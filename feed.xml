<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0"
  xmlns:atom="http://www.w3.org/2005/Atom"
  xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>张时贰</title>
    <link>https://zhsher.cn/</link>
    
    <atom:link href="https://zhsher.cn/feed.xml" rel="self" type="application/rss+xml"/>
    
    <description>环转码，热爱敲代码的小张！</description>
    <pubDate>Fri, 23 Jun 2023 18:08:45 GMT</pubDate>
    <generator>http://hexo.io/</generator>
    
    <item>
      <title>基于腾讯存储桶/Lsky实现动态相册</title>
      <link>https://zhsher.cn/posts/23204/</link>
      <guid>https://zhsher.cn/posts/23204/</guid>
      <pubDate>Fri, 23 Jun 2023 18:08:45 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;上半年事比较多，好久不更新啦。一直想把小张列传单独分离一个博客，前段时间用Typecho搭了一个&lt;a href=&quot;https://blog.</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上半年事比较多，好久不更新啦。一直想把小张列传单独分离一个博客，前段时间用Typecho搭了一个<a href="https://blog.zhsher.cn/">博客</a>，Ty主题很多但是没有一个主题可以把我想要的所有功能放到一起，所以继承了Hexo衣钵，没有就魔改！想加一个相册功能，不需要额外管理（不想每传一张图再写一张图片地址到某个地方，主打一个懒）为了实现动态显示，大多人图床依托存储桶或者兰空，所以从这个角度出发，直接调用他们的接口动态获取图片集合。印象里莱昂纳斯和林木木做过相关瀑布流相册，所以借鉴了他们。</p><p>参考：</p><ul><li><a href="https://blog.leonus.cn/2023/photos.html">基于memos实现动态相册 | Leonus</a></li><li><a href="https://immmmm.com/hugo-shortcodes-gallery/">Hugo 相册短代码 :: 木木木木木</a></li><li><a href="https://blog.leonus.cn/2022/weibo.html">微博热搜api使用与自建 | Leonus</a></li><li><a href="https://blog.anheyu.com/posts/192f.html">butterfly控制特定图片懒加载 | 安知鱼</a></li><li><a href="https://cloud.tencent.com/document/product/436/11459">对象存储 快速入门-SDK 文档-文档中心-腾讯云</a></li></ul><p>Ty效果：<a href="https://blog.zhsher.cn/photos.html">相册 - zhsher</a></p><p>butterfly效果</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E5%9F%BA%E4%BA%8E%E8%85%BE%E8%AE%AF%E5%AD%98%E5%82%A8%E6%A1%B6Lsky%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%9B%B8%E5%86%8C/photo%20wall06.webp" alt="photo wall06"></p><h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><blockquote><p>方案一仅做思路记录，密钥会暴露在前端，不建议使用</p></blockquote><h3 id="腾讯云"><a href="#腾讯云" class="headerlink" title="腾讯云"></a>腾讯云</h3><blockquote><p>免部署，使用快捷，但密钥暴露在前端，切记遵循 <a href="https://cloud.tencent.com/document/product/436/38618">最小权限指引原则</a> 对永久密钥的权限范围进行限制</p></blockquote><p>首先参照<a href="https://cloud.tencent.com/document/product/436/11459">对象存储 快速入门-SDK 文档</a>中准备环境，如下</p><ol><li><p>登录 <a href="https://console.cloud.tencent.com/cos5">对象存储控制台</a> ，获取存储桶名称和地域名称</p></li><li><p>遵循最小权限原则，使用子用户的 <code>SecretId</code> 和 <code>SecretKey</code>。登录 <a href="https://console.cloud.tencent.com/cam/user/userType">控制台-新建用户</a> ，选择快速创建，依次添加用户名，编程访问，<code>QcloudCOSReadOnlyAccess</code>（只读权限）</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E5%9F%BA%E4%BA%8E%E8%85%BE%E8%AE%AF%E5%AD%98%E5%82%A8%E6%A1%B6Lsky%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%9B%B8%E5%86%8C/photo%20wall01.webp" alt="photo wall01"></p></li><li><p>配置 CORS 规则，AllowHeader 需配成<code>*</code>或自己域名，操作为 <code>GET</code>，其它默认</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E5%9F%BA%E4%BA%8E%E8%85%BE%E8%AE%AF%E5%AD%98%E5%82%A8%E6%A1%B6Lsky%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%9B%B8%E5%86%8C/photo%20wall02.webp" alt="photo wall02"></p></li><li><p>以Hexo为例，新建页面<code>hexo new page photos</code>，插入如下代码，填写42~64行配置</p></li></ol><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 腾讯云SDK --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://npm.elemecdn.com/cos-js-sdk-v5/dist/cos-js-sdk-v5.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 瀑布流排版 https://github.com/raphamorim/waterfall.js  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//cdnjs.cloudflare.com/ajax/libs/waterfall.js/1.0.2/waterfall.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- imgStatus https://github.com/raphamorim/imgStatus --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://npm.elemecdn.com/imgstatus/imgStatus.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 图片时间 https://github.com/Tokinx/lately --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/Tokinx/lately/lately.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 图片灯箱 https://github.com/Tokinx/ViewImage --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/Tokinx/ViewImage/view-image.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="comment">/* bottom: 0px适配jasmine主题 */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photos</span> <span class="selector-tag">a</span> <span class="selector-tag">img</span> &#123;<span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">border-radius</span>:<span class="number">0</span>;<span class="attribute">bottom</span>: <span class="number">0px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photos</span>&#123;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">margin-top</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">min-height</span>:<span class="number">5rem</span>;<span class="attribute">width</span>:<span class="number">24.97%</span>;<span class="attribute">padding</span>:<span class="number">4px</span>;<span class="attribute">position</span>: relative;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">a</span>&#123;<span class="attribute">border-radius</span>:<span class="number">8px</span>;<span class="attribute">display</span>:block;<span class="attribute">overflow</span>: hidden;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">img</span>&#123;<span class="attribute">display</span>: block;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">animation</span>: fadeIn <span class="number">1s</span>;<span class="attribute">cursor</span>: pointer;<span class="attribute">transition</span>: all .<span class="number">4s</span> ease-in-out <span class="meta">!important</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>,<span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">max-width</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">7px</span>);<span class="attribute">line-height</span>:<span class="number">1.8</span>;<span class="attribute">position</span>:absolute;<span class="attribute">left</span>:<span class="number">4px</span>;<span class="attribute">font-size</span>:<span class="number">14px</span>;<span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);<span class="attribute">padding</span>:<span class="number">0px</span> <span class="number">8px</span>;<span class="attribute">color</span>: <span class="number">#fff</span>;<span class="attribute">animation</span>: fadeIn <span class="number">1s</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">bottom</span>:<span class="number">4px</span>;<span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">8px</span> <span class="number">0</span> <span class="number">8px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">top</span>:<span class="number">4px</span>;<span class="attribute">border-radius</span>: <span class="number">8px</span> <span class="number">0</span> <span class="number">8px</span> <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span><span class="selector-pseudo">:hover</span> <span class="selector-tag">img</span>&#123;<span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">1100px</span>) &#123;<span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">width</span>:<span class="number">33.3%</span>;&#125;&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">width</span>:<span class="number">49.9%</span>;<span class="attribute">padding</span>:<span class="number">3px</span>&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">display</span>:none&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">font-size</span>:<span class="number">12px</span>&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">left</span>:<span class="number">3px</span>;<span class="attribute">bottom</span>:<span class="number">3px</span>;&#125;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@keyframes</span> fadeIn&#123;<span class="number">0%</span> &#123;<span class="attribute">opacity</span>: <span class="number">0</span>;&#125;<span class="number">100%</span>&#123;<span class="attribute">opacity</span>: <span class="number">1</span>;&#125;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 挂载元素 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-photos page&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// start 需要手动配置</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 自适应 填写当前页面路径例如blog.zhsher.cn/photos就填photos</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">onresize</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (location.<span class="property">pathname</span> == <span class="string">&#x27;/photos/&#x27;</span>) <span class="title function_">waterfall</span>(<span class="string">&#x27;.gallery-photos&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 存储桶自定义域名</span></span></span><br><span class="line"><span class="language-javascript">domain = <span class="string">&#x27;imgl.zhsher.cn&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// SECRETID 和 SECRETKEY 请登录 https://console.cloud.tencent.com/cam/capi 进行查看和管理</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> cos = <span class="keyword">new</span> <span class="title function_">COS</span>(&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="title class_">SecretId</span>: <span class="string">&#x27;AKIDTmpcATXaOzLRP7ankRs4VkjUzMUN1PYS&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="title class_">SecretKey</span>: <span class="string">&#x27;iY9VbVO4WpgRwCg4KOI4cz87nJDwWs1z&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 过滤不想展示的图片 存储桶的绝对路径</span></span></span><br><span class="line"><span class="language-javascript">exclude = []</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">cos.<span class="title function_">getBucket</span>(&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 存储桶名称</span></span></span><br><span class="line"><span class="language-javascript"><span class="title class_">Bucket</span>: <span class="string">&#x27;zh-13104467&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 存储桶所在地域</span></span></span><br><span class="line"><span class="language-javascript"><span class="title class_">Region</span>: <span class="string">&#x27;ap-nanjing&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 非必须，文件夹路径，默认全部</span></span></span><br><span class="line"><span class="language-javascript"><span class="title class_">Prefix</span>: <span class="string">&#x27;&#x27;</span>,<span class="comment">// end 配置结束</span></span></span><br><span class="line"><span class="language-javascript">&#125;).<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 处理拼接图片信息到photo_list filter过滤文件后缀</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> photo_list = data.<span class="property">Contents</span></span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> <span class="regexp">/\.(jpg|png|webp)$/</span>.<span class="title function_">test</span>(item.<span class="property">Key</span>) &amp;&amp; !exclude.<span class="title function_">includes</span>(item.<span class="property">Key</span>))</span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> (&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="attr">img</span>: <span class="string">`https://<span class="subst">$&#123;domain&#125;</span>/`</span> + item.<span class="property">Key</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="attr">title</span>: item.<span class="property">Key</span>.<span class="title function_">match</span>(<span class="regexp">/([^/]+)\.\w+$/</span>)[<span class="number">1</span>],</span></span><br><span class="line"><span class="language-javascript"><span class="attr">time</span>: item.<span class="property">LastModified</span>.<span class="title function_">replace</span>(<span class="regexp">/[TZ]/g</span>, <span class="string">&#x27; &#x27;</span>).<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">5</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;));</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 较新时间放在前 </span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 默认排序 文件夹路径优先时间排序 B/x.webp 2023.10,A/x.webp 2022.10 A排在B前，不是完全按时间顺序，所以不能用photo_list.reverse();</span></span></span><br><span class="line"><span class="language-javascript">photo_list.<span class="title function_">sort</span>(<span class="keyword">function</span>(<span class="params">a, b</span>) &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> timeA = <span class="keyword">new</span> <span class="title class_">Date</span>(a.<span class="property">time</span>); </span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> timeB = <span class="keyword">new</span> <span class="title class_">Date</span>(b.<span class="property">time</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">return</span> timeB - timeA; </span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 拼接dom元素 插入到.gallery-photos.page</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> html = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">photo_list.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">html +=</span></span><br><span class="line"><span class="language-javascript"><span class="string">`&lt;div class=&quot;gallery-photo&quot;&gt;&lt;a href=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot; data-fancybox=&quot;gallery&quot; class=&quot;fancybox&quot; data-thumb=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot;&gt;&lt;img class=&quot;photo-img&quot; loading=&#x27;lazy&#x27; decoding=&quot;async&quot; src=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot;&gt;&lt;/a&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">item.<span class="property">title</span> ? html += <span class="string">`&lt;span class=&quot;photo-title&quot;&gt;<span class="subst">$&#123;item.title&#125;</span>&lt;/span&gt;`</span> : <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">item.<span class="property">time</span> ? html += <span class="string">`&lt;span class=&quot;photo-time&quot;&gt;<span class="subst">$&#123;item.time&#125;</span>&lt;/span&gt;`</span> : <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">html += <span class="string">`&lt;/div&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.gallery-photos.page&#x27;</span>).<span class="property">innerHTML</span> = html;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 瀑布流排版</span></span></span><br><span class="line"><span class="language-javascript">imgStatus.<span class="title function_">watch</span>(<span class="string">&#x27;.photo-img&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">waterfall</span>(<span class="string">&#x27;.gallery-photos&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 处理时间为x天前</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">Lately</span> &amp;&amp; <span class="title class_">Lately</span>.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="attr">target</span>: <span class="string">&#x27;.photo-time&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 图片灯箱</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">ViewImage</span> &amp;&amp; <span class="title class_">ViewImage</span>.<span class="title function_">init</span>(<span class="string">&#x27;.gallery-photo img&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="Lsky图床"><a href="#Lsky图床" class="headerlink" title="Lsky图床"></a>Lsky图床</h3><blockquote><p>免部署，使用快捷，但密钥暴露在前端，Lsky无法权限限制，<strong>不要使用！！！</strong></p></blockquote><ol><li><p>申请token，开源版需要使用命令行。企业版在前端面板中申请</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl --location --request POST &#x27;http://域名/api/v1/tokens&#x27; --form &#x27;email=&quot;邮箱&quot;&#x27; --form &#x27;password=&quot;密码&quot;&#x27;</span><br></pre></td></tr></table></figure></li><li><p>以Hexo为例，新建页面<code>hexo new page photos</code>，插入如下代码，填写40~54行配置</p></li></ol><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 瀑布流排版 https://github.com/raphamorim/waterfall.js  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//cdnjs.cloudflare.com/ajax/libs/waterfall.js/1.0.2/waterfall.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- imgStatus https://github.com/raphamorim/imgStatus --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://npm.elemecdn.com/imgstatus/imgStatus.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 图片时间 https://github.com/Tokinx/lately --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/Tokinx/lately/lately.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 图片灯箱 https://github.com/Tokinx/ViewImage --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/Tokinx/ViewImage/view-image.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="comment">/* bottom: 0px适配jasmine主题可能不适用你的主题，可以删掉 */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photos</span> <span class="selector-tag">a</span> <span class="selector-tag">img</span> &#123;<span class="attribute">margin</span>: <span class="number">0</span>; <span class="attribute">border-radius</span>:<span class="number">0</span>;<span class="attribute">bottom</span>: <span class="number">0px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photos</span>&#123;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">margin-top</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">min-height</span>:<span class="number">5rem</span>;<span class="attribute">width</span>:<span class="number">24.97%</span>;<span class="attribute">padding</span>:<span class="number">4px</span>;<span class="attribute">position</span>: relative;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">a</span>&#123;<span class="attribute">border-radius</span>:<span class="number">8px</span>;<span class="attribute">display</span>:block;<span class="attribute">overflow</span>: hidden;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">img</span>&#123;<span class="attribute">display</span>: block;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">animation</span>: fadeIn <span class="number">1s</span>;<span class="attribute">cursor</span>: pointer;<span class="attribute">transition</span>: all .<span class="number">4s</span> ease-in-out <span class="meta">!important</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>,<span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">max-width</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">7px</span>);<span class="attribute">line-height</span>:<span class="number">1.8</span>;<span class="attribute">position</span>:absolute;<span class="attribute">left</span>:<span class="number">4px</span>;<span class="attribute">font-size</span>:<span class="number">14px</span>;<span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);<span class="attribute">padding</span>:<span class="number">0px</span> <span class="number">8px</span>;<span class="attribute">color</span>: <span class="number">#fff</span>;<span class="attribute">animation</span>: fadeIn <span class="number">1s</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">bottom</span>:<span class="number">4px</span>;<span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">8px</span> <span class="number">0</span> <span class="number">8px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">top</span>:<span class="number">4px</span>;<span class="attribute">border-radius</span>: <span class="number">8px</span> <span class="number">0</span> <span class="number">8px</span> <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span><span class="selector-pseudo">:hover</span> <span class="selector-tag">img</span>&#123;<span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">1100px</span>) &#123;<span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">width</span>:<span class="number">33.3%</span>;&#125;&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">width</span>:<span class="number">49.9%</span>;<span class="attribute">padding</span>:<span class="number">3px</span>&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">display</span>:none&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">font-size</span>:<span class="number">12px</span>&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">left</span>:<span class="number">3px</span>;<span class="attribute">bottom</span>:<span class="number">3px</span>;&#125;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@keyframes</span> fadeIn&#123;<span class="number">0%</span> &#123;<span class="attribute">opacity</span>: <span class="number">0</span>;&#125;<span class="number">100%</span>&#123;<span class="attribute">opacity</span>: <span class="number">1</span>;&#125;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 挂载元素 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-photos page&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// start 需要手动配置</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 自适应 填写相册页面路径例如blog.zhsher.cn/photos就填photos</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">onresize</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">if</span> (location.<span class="property">pathname</span> == <span class="string">&#x27;/photos/&#x27;</span>) <span class="title function_">waterfall</span>(<span class="string">&#x27;.gallery-photos&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 兰空域名</span></span></span><br><span class="line"><span class="language-javascript">domain = <span class="string">&#x27;test.zhsher.cn&#x27;</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> myHeaders = <span class="keyword">new</span> <span class="title class_">Headers</span>();</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 兰空token</span></span></span><br><span class="line"><span class="language-javascript">myHeaders.<span class="title function_">append</span>(<span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Bearer 1|zsNyAN4hPx0xWONcq8Zu01UpynZWQcTgBg26R6iP&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">myHeaders.<span class="title function_">append</span>(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 过滤不想展示的图片</span></span></span><br><span class="line"><span class="language-javascript">exclude = [<span class="string">&#x27;2023/06/04/web开发07.webp&#x27;</span>]</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// end 配置结束</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> requestOptions = &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="attr">method</span>: <span class="string">&#x27;GET&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="attr">headers</span>: myHeaders,</span></span><br><span class="line"><span class="language-javascript"><span class="attr">redirect</span>: <span class="string">&#x27;follow&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">&#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">fetch</span>(<span class="string">`http://<span class="subst">$&#123;domain&#125;</span>/api/v1/images`</span>, requestOptions)</span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">page_num = result.<span class="property">data</span>.<span class="property">last_page</span>; <span class="comment">//获取页码</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">getPhoto</span>(page_num)</span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error&#x27;</span>, error));</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">getPhoto</span>(<span class="params">page_num</span>) &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 需要遍历的页码</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> urls = [];</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= page_num; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">urls.<span class="title function_">push</span>(<span class="string">`http://<span class="subst">$&#123;domain&#125;</span>/api/v1/images?page=<span class="subst">$&#123;i&#125;</span>`</span>)</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> data = &#123;&#125;;</span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> photo_list = []; <span class="comment">// 保存每页的图片信息</span></span></span><br><span class="line"><span class="language-javascript"><span class="title class_">Promise</span>.<span class="title function_">all</span>(urls.<span class="title function_">map</span>(<span class="function"><span class="params">url</span> =&gt;</span></span></span><br><span class="line"><span class="language-javascript"><span class="title function_">fetch</span>(url, requestOptions)</span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">data[result.<span class="property">data</span>.<span class="property">current_page</span>] = result.<span class="property">data</span>.<span class="property">data</span></span></span><br><span class="line"><span class="language-javascript">&#125;)</span></span><br><span class="line"><span class="language-javascript">.<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error&#x27;</span>, error)))).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="comment">//按页码保存图片信息到photo_list</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= page_num; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">photo_list.<span class="title function_">push</span>(...data[i].<span class="title function_">filter</span>(<span class="function"><span class="params">item</span> =&gt;</span> !exclude.<span class="title function_">includes</span>(item.<span class="property">pathname</span>)).<span class="title function_">map</span>(<span class="function"><span class="params">item</span> =&gt;</span> (&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="attr">img</span>: item.<span class="property">links</span>.<span class="property">url</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="attr">title</span>: item.<span class="property">name</span>.<span class="title function_">match</span>(<span class="regexp">/^(.*)\.(webp|png|jpg)$/</span>)[<span class="number">1</span>],</span></span><br><span class="line"><span class="language-javascript"><span class="attr">time</span>: item.<span class="property">date</span></span></span><br><span class="line"><span class="language-javascript">&#125;)))</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 拼接dom元素 插入到.gallery-photos.page</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">let</span> html = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">photo_list.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">html +=</span></span><br><span class="line"><span class="language-javascript"><span class="string">`&lt;div class=&quot;gallery-photo&quot;&gt;&lt;a href=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot; data-fancybox=&quot;gallery&quot; class=&quot;fancybox&quot; data-thumb=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot;&gt;&lt;img class=&quot;photo-img&quot; loading=&#x27;lazy&#x27; decoding=&quot;async&quot; src=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot;&gt;&lt;/a&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">item.<span class="property">title</span> ? html += <span class="string">`&lt;span class=&quot;photo-title&quot;&gt;<span class="subst">$&#123;item.title&#125;</span>&lt;/span&gt;`</span> : <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">item.<span class="property">time</span> ? html += <span class="string">`&lt;span class=&quot;photo-time&quot;&gt;<span class="subst">$&#123;item.time&#125;</span>&lt;/span&gt;`</span> : <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">html += <span class="string">`&lt;/div&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.gallery-photos.page&#x27;</span>).<span class="property">innerHTML</span> = html;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 瀑布流排版</span></span></span><br><span class="line"><span class="language-javascript">imgStatus.<span class="title function_">watch</span>(<span class="string">&#x27;.photo-img&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="title function_">waterfall</span>(<span class="string">&#x27;.gallery-photos&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 处理时间为x天前</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">Lately</span> &amp;&amp; <span class="title class_">Lately</span>.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="attr">target</span>: <span class="string">&#x27;.photo-time&#x27;</span></span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 图片灯箱</span></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">window</span>.<span class="property">ViewImage</span> &amp;&amp; <span class="title class_">ViewImage</span>.<span class="title function_">init</span>(<span class="string">&#x27;.gallery-photo img&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><blockquote><p>为了解决方案一token暴露的痛点，想用一个后端解决，之前实时文章排参照<code>hexo-circle-of-friends</code>项目用了py，想尝试新东西，因为先有了方案一用了很多JS，所以采用node改写会很方便。主要参照Lenous的微博自建api仿着写的。</p><p>区别方案一做了如下修改：</p><ol><li>token不再暴露于前端</li><li>两种后端部署方式二选一，支持Vercel&#x2F;服务器</li><li>减少cdn消耗，不再加载所有照片，对照片做了分页，每页20张图片，点击加载更多在底部追加20张（又是参考朋友圈思路嘿嘿）</li><li>COS和Lsky在后端处理成相同Json格式，前端共用一个模板，代码更加简洁清晰</li><li>Butterfly主题懒加载图片无法显示</li></ol></blockquote><h3 id="获取变量"><a href="#获取变量" class="headerlink" title="获取变量"></a>获取变量</h3><blockquote><p>按照方案一中腾讯云的1、2步或Lsky图床的第一步获取需要的变量</p></blockquote><p>腾讯云</p><table><thead><tr><th>变量名</th><th>解释</th><th>示例</th></tr></thead><tbody><tr><td>cos_domain</td><td>存储桶自定义域名</td><td><code>lsky.pro</code></td></tr><tr><td>cos_SecretId</td><td>存储桶SECRETID</td><td></td></tr><tr><td>cos_SecretKey</td><td>存储桶SECRETKEY</td><td></td></tr><tr><td>cos_bucket</td><td>存储桶名称</td><td><code>name-xxxx</code></td></tr><tr><td>cos_region</td><td>存储桶地域</td><td><code>ap-nanjing</code></td></tr><tr><td>cos_prefix</td><td>文件夹路径，可留空显示全部</td><td><code>blog</code></td></tr><tr><td>exclude</td><td>排除某个图片的绝对路径，可留空</td><td><code>&#39;blog/1.webp&#39;,&#39;blog/2.webp</code></td></tr></tbody></table><p>兰空</p><table><thead><tr><th>变量名</th><th>解释</th><th>示例</th></tr></thead><tbody><tr><td>lsky_domain</td><td>兰空域名</td><td><code>lsky.pro</code></td></tr><tr><td>lsky_token</td><td>兰空Token</td><td><code>Bearer 1 | zsNyAN4hPx0xWONcq8Zu01UpynZWQcTgBg26R6iP</code></td></tr><tr><td>exclude</td><td>排除某个图片的绝对路径，可留空</td><td><code>&#39;blog/1.webp&#39;,&#39;blog/2.webp</code></td></tr></tbody></table><h3 id="后端-Vercel"><a href="#后端-Vercel" class="headerlink" title="后端-Vercel"></a>后端-Vercel</h3><ol><li><p>点击按钮开始部署： <a href="https://vercel.com/new/clone?repository-url=https://github.com/GC-ZF/Cos-Lsky-PhotoWall&repository-name=Cos-Lsky-PhotoWal"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://vercel.com/button" alt="Deploy with Vercel"></a>，直接使用 Github <strong>账号登录即可</strong></p></li><li><p>配置变量，<code>Settings-&gt;Environment Variables-&gt;依次添加变量-&gt;Save</code>，以腾讯云为例配置如图</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E5%9F%BA%E4%BA%8E%E8%85%BE%E8%AE%AF%E5%AD%98%E5%82%A8%E6%A1%B6Lsky%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%9B%B8%E5%86%8C/photo%20wall03.webp" alt="photo wall03"></p></li><li><p>保存后重新部署使变量生效，<code>Deployments-&gt;点击最上边一行的三个点-&gt;Redeploy</code>，如上图所示</p></li><li><p>部署完毕后访问测试，腾讯云接口为<code>https://域名/cos</code>，Lsky域名为<code>https://域名/lsky</code></p></li><li><p><a href="https://vercel.com/docs/concepts/projects/domains/add-a-domain">绑定自定义域名</a>，Vercel 分配的域名 DNS 被污染了， 绑定自定义域名即可直连。<code>Setting-&gt;Domains</code></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article04.png" alt="hexo-hot-article 实时文章排行及访客地图04"></p></li></ol><h3 id="后端-服务器"><a href="#后端-服务器" class="headerlink" title="后端-服务器"></a>后端-服务器</h3><p>打开宝塔面板，在wwwroot下新建一个目录，然后新建 <code>index.js</code> 和 <code>package.json</code> 并填写仓库<a href="https://github.com/GC-ZF/Cos-Lsky-PhotoWall">GC-ZF&#x2F;Cos-Lsky-PhotoWall</a>内对应文件内容。其中<code>indexl.js</code>的8~37行诸如<code>process.env[&#39;cos_domain&#39;]</code>需要替换为你实际的配置，如果只用COS就只需要对COS修改</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E5%9F%BA%E4%BA%8E%E8%85%BE%E8%AE%AF%E5%AD%98%E5%82%A8%E6%A1%B6Lsky%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%9B%B8%E5%86%8C/photo%20wall04.webp" alt="photo wall04"></p><p>建好之后，依次点击 <code>左侧导航栏网站-&gt;node项目-&gt;添加node项目</code>，然后填写配置，没有node需要安装node</p><ul><li>项目目录：刚才创建的目录</li><li>项目端口：3000，需要修改在<code>index.js</code>第五行。记得在腾讯云服务器面板的防火墙放行端口</li><li>绑定域名：建议申请并配置一下ssl，有的网站不能使用http。不配置域名使用<code>服务器ip:3000</code></li><li>其他：默认即可</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E5%9F%BA%E4%BA%8E%E8%85%BE%E8%AE%AF%E5%AD%98%E5%82%A8%E6%A1%B6Lsky%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E7%9B%B8%E5%86%8C/photo%20wall05.webp" alt="photo wall05"></p><h3 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h3><p>以Hexo为例，新建页面<code>hexo new page photos</code>，插入如下代码，填写36~43行配置</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 瀑布流排版 https://github.com/raphamorim/waterfall.js  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;//cdnjs.cloudflare.com/ajax/libs/waterfall.js/1.0.2/waterfall.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- imgStatus https://github.com/raphamorim/imgStatus --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://npm.elemecdn.com/imgstatus/imgStatus.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 图片时间 https://github.com/Tokinx/lately --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/Tokinx/lately/lately.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 图片灯箱 https://github.com/Tokinx/ViewImage --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/Tokinx/ViewImage/view-image.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="comment">/* bottom: 0px适配jasmine主题，margin: 0!important;适配butterfly 可能不适用其它主题，可以删掉 */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photos</span> <span class="selector-tag">a</span> <span class="selector-tag">img</span> &#123;<span class="attribute">margin</span>: <span class="number">0</span><span class="meta">!important</span>; <span class="attribute">border-radius</span>:<span class="number">0</span>;<span class="attribute">bottom</span>: <span class="number">0px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photos</span>&#123;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">margin-top</span>: <span class="number">10px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">min-height</span>:<span class="number">5rem</span>;<span class="attribute">width</span>:<span class="number">24.97%</span>;<span class="attribute">padding</span>:<span class="number">4px</span>;<span class="attribute">position</span>: relative;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">a</span>&#123;<span class="attribute">border-radius</span>:<span class="number">8px</span>;<span class="attribute">display</span>:block;<span class="attribute">overflow</span>: hidden;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">img</span>&#123;<span class="attribute">display</span>: block;<span class="attribute">width</span>:<span class="number">100%</span>;<span class="attribute">animation</span>: fadeIn <span class="number">1s</span>;<span class="attribute">cursor</span>: pointer;<span class="attribute">transition</span>: all .<span class="number">4s</span> ease-in-out <span class="meta">!important</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>,<span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">max-width</span>: <span class="built_in">calc</span>(<span class="number">100%</span> - <span class="number">7px</span>);<span class="attribute">line-height</span>:<span class="number">1.8</span>;<span class="attribute">position</span>:absolute;<span class="attribute">left</span>:<span class="number">4px</span>;<span class="attribute">font-size</span>:<span class="number">14px</span>;<span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0.3</span>);<span class="attribute">padding</span>:<span class="number">0px</span> <span class="number">8px</span>;<span class="attribute">color</span>: <span class="number">#fff</span>;<span class="attribute">animation</span>: fadeIn <span class="number">1s</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">bottom</span>:<span class="number">4px</span>;<span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">8px</span> <span class="number">0</span> <span class="number">8px</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">top</span>:<span class="number">4px</span>;<span class="attribute">border-radius</span>: <span class="number">8px</span> <span class="number">0</span> <span class="number">8px</span> <span class="number">0</span>;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.gallery-photo</span><span class="selector-pseudo">:hover</span> <span class="selector-tag">img</span>&#123;<span class="attribute">transform</span>: <span class="built_in">scale</span>(<span class="number">1.1</span>);&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">1100px</span>) &#123;<span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">width</span>:<span class="number">33.3%</span>;&#125;&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.gallery-photo</span>&#123;<span class="attribute">width</span>:<span class="number">49.9%</span>;<span class="attribute">padding</span>:<span class="number">3px</span>&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-time</span>&#123;<span class="attribute">display</span>:none&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">font-size</span>:<span class="number">12px</span>&#125;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.gallery-photo</span> <span class="selector-tag">span</span><span class="selector-class">.photo-title</span>&#123;<span class="attribute">left</span>:<span class="number">3px</span>;<span class="attribute">bottom</span>:<span class="number">3px</span>;&#125;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"><span class="keyword">@keyframes</span> fadeIn&#123;<span class="number">0%</span> &#123;<span class="attribute">opacity</span>: <span class="number">0</span>;&#125;<span class="number">100%</span>&#123;<span class="attribute">opacity</span>: <span class="number">1</span>;&#125;&#125;</span></span><br><span class="line"><span class="language-css"><span class="selector-class">.uploadmore</span>&#123;<span class="attribute">width</span>:<span class="number">40%</span>;<span class="attribute">max-width</span>:<span class="number">810px</span>;<span class="attribute">height</span>:<span class="number">30px</span>;<span class="attribute">margin</span>:auto;<span class="attribute">border-radius</span>:<span class="number">12px</span>;<span class="attribute">font-weight</span>:<span class="number">700</span>;<span class="attribute">text-align</span>:center;<span class="attribute">display</span>:flex;<span class="attribute">align-items</span>:center;<span class="attribute">justify-content</span>:center;<span class="attribute">cursor</span>:pointer;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#000</span>;<span class="attribute">box-shadow</span>:<span class="number">0</span> <span class="number">8px</span> <span class="number">16px</span> -<span class="number">4px</span> <span class="number">#2c2d300c</span>;<span class="attribute">background</span>:<span class="number">#f4f4f4</span>&#125;</span></span><br><span class="line"><span class="language-css"><span class="comment">/* butterfly和ty的夜间加载按钮 */</span></span></span><br><span class="line"><span class="language-css"><span class="selector-attr">[data-theme=dark]</span> <span class="selector-class">.uploadmore</span>,<span class="selector-class">.dark</span> <span class="selector-class">.uploadmore</span>&#123;<span class="attribute">background</span>: <span class="number">#1D1E3C</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 挂载元素 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery-photos page&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// start 需要手动配置</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 自适应 填写相册页面路径例如blog.zhsher.cn/photos就填photos</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="property">onresize</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (location.<span class="property">pathname</span> == <span class="string">&#x27;/photos/&#x27;</span>) <span class="title function_">waterfall</span>(<span class="string">&#x27;.gallery-photos&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// vercel配置的api接口 腾讯云为`域名/cos` 兰空为`域名/lsky`</span></span></span><br><span class="line"><span class="language-javascript">    api = <span class="string">&#x27;https://cos-lsky-photo-wall.zhsher.cn/cos&#x27;</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// end 配置结束</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 插入加载更多按钮</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> element = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    element.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;uploadmore&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    element.<span class="property">innerHTML</span> = <span class="string">`加载中...`</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.gallery-photos.page&#x27;</span>).<span class="title function_">insertAdjacentElement</span>(<span class="string">&#x27;afterend&#x27;</span>, element);</span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;api&#125;</span>`</span>)</span></span><br><span class="line"><span class="language-javascript">        .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">json</span>())</span></span><br><span class="line"><span class="language-javascript">        .<span class="title function_">then</span>(<span class="function"><span class="params">result</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> page = []; <span class="comment">//存放分页</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">let</span> current_page = <span class="number">0</span>; <span class="comment">// 当前页码</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 将照片分页 每页20张</span></span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; result.<span class="property">length</span> / <span class="number">20</span>; i++) &#123;</span></span><br><span class="line"><span class="language-javascript">                page.<span class="title function_">push</span>(result.<span class="title function_">slice</span>(i * <span class="number">20</span>, (i + <span class="number">1</span>) * <span class="number">20</span>))</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 先加载一页</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">getPhoto</span>(page[<span class="number">0</span>]);</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">updateButton</span>(current_page, page.<span class="property">length</span> - <span class="number">1</span>);</span></span><br><span class="line"><span class="language-javascript">            current_page++;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 点击加载更多</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.uploadmore&#x27;</span>).<span class="property">onclick</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">getPhoto</span>(page[current_page]);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">updateButton</span>(current_page, page.<span class="property">length</span> - <span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">                current_page++;</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">        .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;error&#x27;</span>, error));</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">getPhoto</span>(<span class="params">photo_list</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 拼接dom元素 插入到.gallery-photos.page</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">let</span> html = <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">        photo_list.<span class="title function_">forEach</span>(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            html +=</span></span><br><span class="line"><span class="language-javascript">                <span class="string">`&lt;div class=&quot;gallery-photo&quot;&gt;&lt;a href=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot; data-fancybox=&quot;gallery&quot; class=&quot;fancybox&quot; data-thumb=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot;&gt;&lt;img class=&quot;photo-img &quot; loading=&#x27;lazy&#x27; decoding=&quot;async&quot; src=&quot;<span class="subst">$&#123;item.img&#125;</span>&quot;&gt;&lt;/a&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">            item.<span class="property">title</span> ? html += <span class="string">`&lt;span class=&quot;photo-title&quot;&gt;<span class="subst">$&#123;item.title&#125;</span>&lt;/span&gt;`</span> : <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            item.<span class="property">time</span> ? html += <span class="string">`&lt;span class=&quot;photo-time&quot;&gt;<span class="subst">$&#123;item.time&#125;</span>&lt;/span&gt;`</span> : <span class="string">&#x27;&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">            html += <span class="string">`&lt;/div&gt;`</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.gallery-photos.page&#x27;</span>).<span class="property">innerHTML</span> += html;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 瀑布流排版</span></span></span><br><span class="line"><span class="language-javascript">        imgStatus.<span class="title function_">watch</span>(<span class="string">&#x27;.photo-img&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">waterfall</span>(<span class="string">&#x27;.gallery-photos&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 处理时间为x天前</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">Lately</span> &amp;&amp; <span class="title class_">Lately</span>.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">target</span>: <span class="string">&#x27;.photo-time&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 图片灯箱</span></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">ViewImage</span> &amp;&amp; <span class="title class_">ViewImage</span>.<span class="title function_">init</span>(<span class="string">&#x27;.gallery-photo img&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 更新按钮文字</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">updateButton</span>(<span class="params">current_page, page</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 第一次先加载一次按钮 只有一页时page=0所以额外判断一次</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (current_page == <span class="number">0</span> &amp;&amp; page != <span class="number">0</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.uploadmore&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">`加载更多`</span></span></span><br><span class="line"><span class="language-javascript">        &#125; <span class="comment">//全部加载完</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">else</span> <span class="keyword">if</span> (current_page == page) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;.uploadmore&#x27;</span>).<span class="property">innerHTML</span> = <span class="string">`已加载全部`</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>butterfly额外操作1</strong></p><p>如果是butterfly主题，主题自带灯箱，修改前端模板</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- // 图片灯箱</span></span><br><span class="line"><span class="deletion">- window.ViewImage &amp;&amp; ViewImage.init(&#x27;.gallery-photo img&#x27;);</span></span><br></pre></td></tr></table></figure><p><strong>butterfly额外操作2</strong></p><p>如果是butterfly主题且开启了lazyload，图片可能会显示空白。参照<a href="https://blog.anheyu.com/posts/192f.html">butterfly控制特定图片懒加载 | 安知鱼</a>中方法二，修改前端模板</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- &lt;img class=&quot;photo-img&quot; loading=&#x27;lazy&#x27; decoding=&quot;async&quot; src=&quot;$&#123;item.img&#125;&quot;&gt;;</span></span><br><span class="line"><span class="addition">+ &lt;img class=&quot;photo-img no-lazyload&quot; loading=&#x27;lazy&#x27; decoding=&quot;async&quot; src=&quot;$&#123;item.img&#125;&quot;&gt;;</span></span><br></pre></td></tr></table></figure><p>修改<code>themes/butterfly/scripts/filters/post_lazyload.js</code>的第13行</p><figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="deletion">- return htmlContent.replace(/(&lt;img.*? src=)/ig, `$1 &quot;$&#123;bg&#125;&quot; data-lazy-src=`);</span></span><br><span class="line"><span class="addition">+ return htmlContent.replace(/(&lt;img(?!.*?class[\t]*=[\t]*[&#x27;&quot;].*?no-lazyload.*?[&#x27;&quot;]).*? src=)/gi, `$1 &quot;$&#123;bg&#125;&quot; data-lazy-src=`);</span></span><br></pre></td></tr></table></figure>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/Hexo/">Hexo</category>
      
      
      <category domain="https://zhsher.cn/tags/Hexo/">Hexo</category>
      
      
      <comments>https://zhsher.cn/posts/23204/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>基于Artitalk的说说和清单功能</title>
      <link>https://zhsher.cn/posts/33243/</link>
      <guid>https://zhsher.cn/posts/33243/</guid>
      <pubDate>Fri, 20 Jan 2023 18:16:49 GMT</pubDate>
      
        
        
      <description>&lt;blockquote&gt;
&lt;p&gt;每月任务更新打卡，所以这篇有些水。不知道更什么了，任务清单翻出来一个被鸽了六个月的待写文章嘿嘿&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/</description>
        
      
      
      
      <content:encoded><![CDATA[<blockquote><p>每月任务更新打卡，所以这篇有些水。不知道更什么了，任务清单翻出来一个被鸽了六个月的待写文章嘿嘿</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此篇仅做学习记录，现在更偏向Memos，未来可能更换。据小张目前所知道的普遍用的项目推荐：</p><ul><li><p><a href="https://blog.zhheo.com/p/557c9e72.html">Hexo的Butterfly魔改：即刻短文静态部署版 | 张洪Heo</a>：免部署，直接写在博客文件内</p></li><li><p><a href="https://artitalk.js.org/doc.html#%F0%9F%91%80-%E5%89%8D%E8%A8%80">Artitalk.js | 使用文档 </a>，利用Leancloud数据库存储</p><ul><li>方法一，<a href="https://blog.csdn.net/cungudafa/article/details/105938885">添加说说页面 cungudafa的博客</a>，利用HTML、JS部署</li><li>方法二，<a href="https://github.com/jerryc127/butterfly-plugins/tree/main/hexo-butterfly-artitalk">butterfly | artitalk</a>，Butterfly主题作者插件化部署</li></ul></li><li><p><a href="https://kkapi-doc.vercel.app/guide/">KK Api </a>，依靠github与vercel托管，MongoDB数据库存储，小康开发的，具备前后端面板，UI十分Nice</p></li><li><p><a href="https://immmmm.com/about/">木木木木木 Memos</a>，<a href="https://blog.leonus.cn/2023/memeos.html">基于Memos实现说说和清单功能。 | Leonus</a>，需要服务器，林木木老师的方案，最近<a href="https://blog.leonus.cn/">@Leonus</a>，<a href="https://noionion.top/">@贰猹姐姐</a>也用上了</p></li><li><p><del><a href="https://bb.js.org/quick-start.html#leancloud-%E5%88%9B%E5%BB%BA%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4">BBtalk</a>，Artitalk的改进版，支持微信发送</del>，作者黑石已不维护</p></li><li><p><a href="https://jigu.im/">爱叽咕</a>，不需要安装，通过网页注册，之后的说说都在这个网页内</p></li><li><p><a href="https://www.ifking.cn/p/113.html">时光机微信发送系统</a>，需要服务器，自己注册微信公众号、安装时光机、配置数据库…参考教程<a href="https://www.vian.top/378.html">自建公众号发送时光机 - Vian</a></p></li></ul><p>无服务器首推Heo哥的静态，免部署好实现，之后KK Api可以动态发文。有服务器首推Memos。见仁见智选合适自己的就好</p><p>平常喜欢记录一些碎片化信息，但当时还不知道糖果屋，想实现一个可以方便记录和查看的功能</p><p>如何记录？当时没有什么好办法，在蝴蝶文档了解到『Artitalk说说』基于Leancloud存储，平常经常给QQ小号发信息，所以借助<a href="https://github.com/Mrs4s/go-cqhttp">go-cqhttp: cqhttp的golang实现，轻量、原生跨平台. </a>处理消息，向Leancloud数据库增删改查</p><p>如何查看？在网页中展示，这样其它电子设备也不需要下载额外的软件，『Artitalk说说』前端还提供增删面板</p><p>于是就有了<a href="https://zhsher.cn/talk/">备忘录 | 张时贰</a>。</p><h2 id="部署Artitalk"><a href="#部署Artitalk" class="headerlink" title="部署Artitalk"></a>部署Artitalk</h2><ol><li>前往 <a href="https://leancloud.app/">LeanCloud</a>，注册账号。</li><li>注册完成之后根据 LeanCloud 的提示绑定手机号和邮箱。</li><li>绑定完成之后点击<code>创建应用</code>，应用名称随意，接着在<code>结构化数据</code>中创建 <code>class</code>，命名为 <code>shuoshuo</code>。</li><li>在你新建的应用中找到<code>结构化数据</code>下的<code>用户</code>。点击<code>添加用户</code>，输入想用的用户名及密码（前端面板登录使用）。</li><li>回到<code>结构化数据</code>中，点击 <code>class</code> 下的 <code>shuoshuo</code>。找到权限，在 <code>Class 访问权限</code>中将 <code>add_fields</code> 以及 <code>create</code> 权限设置为指定用户，输入你刚才输入的用户名会自动匹配。为了安全起见，将 <code>delete</code> 和 <code>update</code> 也设置为跟它们一样的权限。</li><li>然后新建一个名为<code>atComment</code>的class，权限使用默认的即可。</li><li>点击 <code>class</code> 下的 <code>_User</code> 添加列，列名称为 <code>img</code>，默认值填上你这个账号想要用的发布说说的头像url，这一项不进行配置，说说头像会显示为默认头像 —— Artitalk 的 logo。</li><li>在最菜单栏中找到<code>设置-&gt; 应用 keys</code>，记下来 <code>AppID</code> 和 <code>AppKey</code>。</li><li>最后将 <code>_User</code> 中的权限全部调为指定用户，或者数据创建者，为了保证不被篡改用户数据以达到强制发布说说。</li></ol><p>在博客根目录执行</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo new page 说说</span><br></pre></td></tr></table></figure><p>粘贴以下内容</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 备忘录</span><br><span class="line">comments: false</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 引用 artitalk --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/artitalk&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 存放说说的容器 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;artitalk_main&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">new</span> <span class="title class_">Artitalk</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="attr">appId</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// LeanCloud appId</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">appKey</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// LeanCloud appKey</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">serverURL</span>: <span class="string">&#x27;&#x27;</span>, <span class="comment">// LeanCloud serverURL</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">pageSize</span>: <span class="number">6</span>,    <span class="comment">//每页最大显示数量</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">shuoPla</span>: <span class="string">&#x27;又来加备忘了&#x27;</span>,   <span class="comment">//编辑说说的输入框中的占位符</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// avatarPla: &#x27;url&#x27;,        //自定义头像地址，优先权大于LeanCloud</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// motion: 1,               //加载动画</span></span></span><br><span class="line"><span class="language-javascript">            <span class="attr">bgImg</span>: <span class="string">&#x27;&#x27;</span>,  <span class="comment">//说说输入框背景图片</span></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// atComment: 1        //评论开启</span></span></span><br><span class="line"><span class="language-javascript">        &#125;)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Artitalk不适配蝴蝶的夜间模式，所以再加一段css --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#artitalk_main</span> <span class="selector-class">.cbp_tmtimeline</span>&gt;<span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) <span class="selector-class">.cbp_tmlabel</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#333030</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#e3dede</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 下一个说说框背景和颜色 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#artitalk_main</span> <span class="selector-class">.cbp_tmtimeline</span>&gt;<span class="selector-tag">li</span> <span class="selector-class">.cbp_tmlabel</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#333030</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#e3dede</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 右边框颜色 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#artitalk_main</span> <span class="selector-class">.cbp_tmtimeline</span>&gt;<span class="selector-tag">li</span><span class="selector-pseudo">:nth-child</span>(odd) <span class="selector-class">.cbp_tmlabel</span><span class="selector-pseudo">:after</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-right-color</span>:  <span class="number">#333030</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#artitalk_main</span> <span class="selector-class">.cbp_tmtimeline</span>&gt;<span class="selector-tag">li</span> <span class="selector-class">.cbp_tmlabel</span><span class="selector-pseudo">:after</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-right-color</span>:  <span class="number">#333030</span>;</span></span><br><span class="line"><span class="language-css">          &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 加载更多按钮 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#artitalk_main</span> <span class="selector-class">.at_button</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#333030</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#f5f5f5</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 评论小气泡 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#artitalk_main</span> path &#123;</span></span><br><span class="line"><span class="language-css">            fill: <span class="built_in">rgb</span>(<span class="number">227</span>, <span class="number">222</span>, <span class="number">222</span>);</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 发布说说背景 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#article-container</span> <span class="selector-id">#artitalk_main</span> <span class="selector-tag">textarea</span><span class="selector-id">#neirong</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ffffffdb</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#ffffff00</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 邮箱框背景 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#article-container</span> <span class="selector-id">#artitalk_main</span> <span class="selector-tag">input</span><span class="selector-id">#email</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ffffffdb</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#ffffff00</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 昵称框背景 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#article-container</span> <span class="selector-id">#artitalk_main</span> imput<span class="selector-id">#commentNick</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ffffffdb</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>: <span class="number">#ffffff00</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>: <span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="comment">/* 表情框背景 */</span></span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#article-container</span> <span class="selector-id">#artitalk_main</span> <span class="selector-class">.shuoshuo_emoji</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">6px</span> <span class="number">6px</span> <span class="number">0</span> <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">120px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow</span>: auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin-top</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-bottom</span>: none;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-attr">[data-theme=<span class="string">&#x27;dark&#x27;</span>]</span> <span class="selector-id">#article-container</span> <span class="selector-id">#artitalk_main</span> <span class="selector-tag">div</span><span class="selector-id">#shuoshuo_emojiswitch</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">40px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-radius</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">6px</span> <span class="number">6px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-collapse</span>: collapse;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#ffffff</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border-top</span>: none;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="部署gocq"><a href="#部署gocq" class="headerlink" title="部署gocq"></a>部署gocq</h2><p>参照<a href="https://space.bilibili.com/33138220">Well404_此教程</a>在服务器下部署</p><p>新建<code>Nonebot根目录/nb2/src/plugins/Artitalk/__init__.py</code></p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> nonebot <span class="keyword">import</span> on_command</span><br><span class="line"><span class="keyword">from</span> nonebot.permission <span class="keyword">import</span> SUPERUSER</span><br><span class="line"><span class="keyword">import</span> leancloud</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> markdown</span><br><span class="line"><span class="keyword">from</span> nonebot.adapters.onebot.v11 <span class="keyword">import</span> Bot, Event</span><br><span class="line"><span class="keyword">from</span> nonebot.adapters.onebot.v11.message <span class="keyword">import</span> Message</span><br><span class="line"></span><br><span class="line">Leancloud_username = <span class="string">&#x27;&#x27;</span> <span class="comment"># 前端登录用户名</span></span><br><span class="line">Leancloud_password = <span class="string">&#x27;&#x27;</span> <span class="comment"># 前端登录密码</span></span><br><span class="line">Leancloud_AppID = <span class="string">&#x27;&#x27;</span> <span class="comment"># Leancloud的AppId</span></span><br><span class="line">Leancloud_AppKey = <span class="string">&#x27;&#x27;</span> <span class="comment"># Leancloud的AppKey</span></span><br><span class="line">qq_Arritalk = [ <span class="string">&#x27;1310446718&#x27;</span> ] <span class="comment"># 可以使用的qq号</span></span><br><span class="line"></span><br><span class="line">write_cheat = on_command ( <span class="string">&quot;备忘&quot;</span>, priority=<span class="number">50</span> )</span><br><span class="line">delete_cheat = on_command ( <span class="string">&quot;删除备忘&quot;</span>, priority=<span class="number">50</span> )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@write_cheat.handle ()</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">write_handle</span>(<span class="params">bot: Bot, event: Event</span>):</span><br><span class="line">    qq_id = event.user_id</span><br><span class="line">    qq_id = <span class="built_in">str</span> ( qq_id )</span><br><span class="line">    <span class="keyword">if</span> qq_id <span class="keyword">in</span> qq_Arritalk:</span><br><span class="line">        msg = event.message.extract_plain_text ().replace ( <span class="string">&quot;备忘&quot;</span>, <span class="string">&quot;&quot;</span> )</span><br><span class="line">        <span class="comment"># write ( mdtohtml ( msg ), msg, getavatar ( Leancloud_username ) )</span></span><br><span class="line">        write ( mdtohtml ( msg ), msg, getavatar ( qq_id ) )</span><br><span class="line">        <span class="keyword">await</span> write_cheat.finish ( Message ( <span class="string">&quot;备忘成功，你什么时候才能记住啊！&quot;</span> ) )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">await</span> write_cheat.finish ( Message ( <span class="string">&quot;你没有权限&quot;</span> ) )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@delete_cheat.handle ()</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">delete_handle</span>(<span class="params">bot: Bot, event: Event</span>):</span><br><span class="line">    qq_id = event.user_id</span><br><span class="line">    qq_id = <span class="built_in">str</span> ( qq_id )</span><br><span class="line">    <span class="keyword">if</span> qq_id <span class="keyword">in</span> qq_Arritalk:</span><br><span class="line">        msg = event.message.extract_plain_text ().replace ( <span class="string">&quot;删除备忘&quot;</span>, <span class="string">&quot;&quot;</span> )</span><br><span class="line">        delete ( msg )</span><br><span class="line">        <span class="keyword">await</span> delete_cheat.finish ( Message ( <span class="string">&#x27;删除成功！&#x27;</span> ) )</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">await</span> delete_cheat.finish ( Message ( <span class="string">&quot;你没有权限&quot;</span> ) )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># # 开启调试日志输出到控制台</span></span><br><span class="line"><span class="comment"># logging.basicConfig ( level=logging.DEBUG )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用init初始化连接</span></span><br><span class="line">leancloud.init ( Leancloud_AppID, Leancloud_AppKey )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 登录用户</span></span><br><span class="line">user = leancloud.User ()</span><br><span class="line">user.login ( Leancloud_username, Leancloud_password )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查找</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query_value</span>(<span class="params">table, key, value</span>):</span><br><span class="line">    objectId = [ ]</span><br><span class="line">    todo = leancloud.Object.extend ( table )</span><br><span class="line">    query = todo.query</span><br><span class="line">    query.equal_to ( key, value )</span><br><span class="line">    todo_list = query.find ()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> todo_list:</span><br><span class="line">        objectId.append ( i.get ( <span class="string">&#x27;objectId&#x27;</span> ) )</span><br><span class="line">    <span class="keyword">return</span> objectId</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getavatar</span>(<span class="params">username</span>):</span><br><span class="line">    <span class="comment"># 从User表中获取用户头像</span></span><br><span class="line">    <span class="comment"># _User = leancloud.Object.extend ( &#x27;_User&#x27; )</span></span><br><span class="line">    <span class="comment"># # 建立查询</span></span><br><span class="line">    <span class="comment"># query = _User.query</span></span><br><span class="line">    <span class="comment"># # 查找键username 值zhangshier</span></span><br><span class="line">    <span class="comment"># query.equal_to ( &#x27;username&#x27;, username )</span></span><br><span class="line">    <span class="comment"># _User_list = query.find ()</span></span><br><span class="line">    <span class="comment"># for i in _User_list:</span></span><br><span class="line">    <span class="comment">#     img = i.get ( &#x27;img&#x27; )</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 用query查找用户表获取头像</span></span><br><span class="line">    <span class="comment"># Todo=leancloud.Object.extend(&#x27;_User&#x27;)</span></span><br><span class="line">    <span class="comment"># objectId = query_value ( &#x27;_User&#x27;, &#x27;username&#x27;, username )</span></span><br><span class="line">    <span class="comment"># query=Todo.query</span></span><br><span class="line">    <span class="comment"># todo = query.get ( objectId[0] )</span></span><br><span class="line">    <span class="comment"># img = todo.get ( &#x27;img&#x27; )</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 什么垃圾代码，直接用腾讯地址多香！</span></span><br><span class="line">    img = <span class="string">f&#x27;http://q2.qlogo.cn/headimg_dl?dst_uin=<span class="subst">&#123;username&#125;</span>&amp;spec=100&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> img</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># md转html</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mdtohtml</span>(<span class="params">Content</span>):</span><br><span class="line">    text = Content</span><br><span class="line">    html = markdown.markdown ( text )</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入数据库</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write</span>(<span class="params">html, content, img</span>):</span><br><span class="line">    <span class="comment"># 写入shuoshuo表</span></span><br><span class="line">    shuoshuo = leancloud.Object.extend ( <span class="string">&#x27;shuoshuo&#x27;</span> )</span><br><span class="line">    <span class="comment"># 构建对象</span></span><br><span class="line">    todo = shuoshuo ()</span><br><span class="line">    <span class="comment"># 为属性赋值</span></span><br><span class="line">    todo.<span class="built_in">set</span> ( <span class="string">&#x27;atContentHtml&#x27;</span>, html )</span><br><span class="line">    todo.<span class="built_in">set</span> ( <span class="string">&#x27;atContentMd&#x27;</span>, content )</span><br><span class="line">    todo.<span class="built_in">set</span> ( <span class="string">&#x27;avatar&#x27;</span>, img )</span><br><span class="line">    todo.<span class="built_in">set</span> ( <span class="string">&#x27;userOs&#x27;</span>, <span class="string">&#x27;QQ&#x27;</span> )</span><br><span class="line">    <span class="comment"># 将对象保存到云端</span></span><br><span class="line">    todo.save ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除shuoshuo</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">txt</span>):</span><br><span class="line">    <span class="comment"># 从shuoshuo表中查找并删除</span></span><br><span class="line">    objectId = query_value ( <span class="string">&#x27;shuoshuo&#x27;</span>, <span class="string">&#x27;atContentMd&#x27;</span>, txt )</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> objectId:</span><br><span class="line">        Todo = leancloud.Object.extend ( <span class="string">&#x27;shuoshuo&#x27;</span> )</span><br><span class="line">        todo = Todo.create_without_data ( i )</span><br><span class="line">        todo.destroy ()</span><br></pre></td></tr></table></figure><p>使用示例：</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E5%9F%BA%E4%BA%8EArtitalk%E7%9A%84%E8%AF%B4%E8%AF%B4%E5%92%8C%E6%B8%85%E5%8D%95%E5%8A%9F%E8%83%BD/Artitalk.png" alt="Artitalk"></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>个人感觉Artitalk已经过时，有服务器还是Memos香，如果想嵌入自己的博客，也有蛮多成熟的前端方案</p><p>最后祝大家新年快乐，前兔似锦！！！</p>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/Hexo/">Hexo</category>
      
      
      <category domain="https://zhsher.cn/tags/Hexo/">Hexo</category>
      
      <category domain="https://zhsher.cn/tags/Nonebot/">Nonebot</category>
      
      
      <comments>https://zhsher.cn/posts/33243/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>hexo-hot-article 实时文章排行及访客地图</title>
      <link>https://zhsher.cn/posts/12205/</link>
      <guid>https://zhsher.cn/posts/12205/</guid>
      <pubDate>Mon, 26 Dec 2022 14:40:29 GMT</pubDate>
      
      <description>好多人啊？你们在看哪篇呢！</description>
      
      
      
      <content:encoded><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>灵感来源于<a href="https://thiscute.world/statistics/">@二花 阅读排行</a></p><p>关于网站统计平台的选择，第一想到的也是51la，我深度使用的感受</p><ul><li>百度好请求，但是没文章题目，需要借助爬虫曲爬取，接口太多且有的不能用，好的接口得付费（不过可以自己手撕计算时间&#x2F;排序文章热度），且token只有一个月的有效期，需要手动填写新的（已解决）！受访页面统计是以UV从高到低的前20条数据问题不算大，显示一部分文章就可以了，额外数据需要开通企业版</li><li>51la相对于百度，有文章题目，接口只有6个，比百度目的性强，Json数据清晰。但是请求体需要<code>accesskey、nonce、secretkey、时间戳</code>利用SHA256HEX生成 sign（签名），之后将五个参数作为请求体再去请求，十分麻烦。致命的是接口调用次数100&#x2F;月，想要开通企业版，加客服根本不鸟我，一定要使用可以利用Github工作流实现，但是这样不能保证实时数据</li></ul><p>综合考虑，使用百度统计实现文章排行及访客地图。效果：<a href="https://zhsher.cn/hot-article">阅读排行</a></p><div align="center">  <img height="300px" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article01.png">  <img height="300px" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article02.png"></div><h2 id="开通百度统计数据API"><a href="#开通百度统计数据API" class="headerlink" title="开通百度统计数据API"></a>开通百度统计数据API</h2><p>参照<a href="https://butterfly.js.org/posts/ceeb73f/#%E5%88%86%E6%9E%90%E7%B5%B1%E8%A8%88">Butterfly 安裝文檔(四) 主題配置-2 | Butterfly</a>，安装注册百度统计服务</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article03.png" alt="hexo-hot-article 实时文章排行及访客地图03"></p><p>百度统计可以获取20条高访问页面数据，为了保证数据的有效性，我在代码中过滤掉了<code>localhost:4000</code>以及<code>tag</code>、<code>categories</code>等页面。为了获取更多的有效数据，可以预先设置不统计<code>localhost</code></p><p><strong>使用设置-&gt;规则设置-&gt;过滤规则设置</strong></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article04.png" alt="hexo-hot-article 实时文章排行及访客地图04"></p><p>在百度统计首页中的数据管理，获取<code>API Key</code>、<code>Secrect Key</code></p><p>访问并登录<code>http://openapi.baidu.com/oauth/2.0/authorize?response_type=code&amp;client_id=&#123;CLIENT_ID&#125;&amp;redirect_uri=oob&amp;scope=basic&amp;display=popup</code>，获取code，其中<code>&#123;CLIENT_ID&#125;</code>替换为<code>API Key</code></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article05.png" alt="hexo-hot-article 实时文章排行及访客地图05"></p><p>访问<code>http://openapi.baidu.com/oauth/2.0/token?grant_type=authorization_code&amp;code=&#123;你的CODE&#125;&amp;client_id=&#123;你的API Key&#125;&amp;client_secret=&#123;你的Secrect Key&#125;&amp;redirect_uri=oob</code>，获取token</p><h2 id="引入博客"><a href="#引入博客" class="headerlink" title="引入博客"></a>引入博客</h2><p>新建一个页面</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hexo new page hot-article</span><br></pre></td></tr></table></figure><p>生成<code>source/hot-article/index.md</code> 文件，打开该文件，粘贴以下内容：</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&#x27;hexo-hot-article&#x27;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&#x27;hexo-china-map&#x27;</span> <span class="attr">style</span>=<span class="string">&quot;height: 500px;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> token = <span class="string">&#x27;&#x27;</span> <span class="comment">//百度统计token vercel自建请留空</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> url = <span class="string">&#x27;zhsher.cn&#x27;</span><span class="comment">//站点地址</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> api = <span class="string">&#x27;&#x27;</span>  <span class="comment">//hexo-hot-article api 留空默认使用 https://hexo-hot-article.zhsher.cn/ 自建使用自己的接口</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> background = <span class="string">&#x27;&#x27;</span>  <span class="comment">//文章表格鼠标悬停背景色，留空默认爷爷红</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">href</span>=<span class="string">&quot;//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/GC-ZF/hexo-hot-article/static/hot-article.min.css&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/gh/GC-ZF/hexo-hot-article/static/hot-article.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/npm/echarts@5.4.1/dist/echarts.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://jsd.onmicrosoft.cn/npm/echarts@4.9.0/map/js/china.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p>hexo三连通过 <strong>『<a href="http://localhost:4000/hot-article%E3%80%8F">http://localhost:4000/hot-article』</a></strong> 访问</p><h2 id="自建项目（可选）"><a href="#自建项目（可选）" class="headerlink" title="自建项目（可选）"></a>自建项目（可选）</h2><p>为了解决百度token只有一个月需要手动更新痛点，借鉴<a href="https://blog.eurkon.com/post/61763977.html">Hexo 博客实时访问统计图 | Eurkon</a>的文章，使用同样的原理实现</p><p>使用 Github + LeanCloud + Vercel，整个部署均在云端完成。运行原理：</p><ol><li>数据存储在 LeanCloud 数据库，也可以自行修改源码存储在其他数据库；</li><li>通过 Github Action 更新百度统计的 <code>AccessToken</code> 和 <code>RefreshToken</code>；</li><li>Vercel 部署的 API 从 LeanCloud 获取 <code>AccessToken</code>，再执行请求，获取百度统计数据，返回给前端。</li></ol><p>接口文档：<a href="https://hexo-hot-article.zhsher.cn/docs">hexo-hot-article docs</a>，其中包括获取及刷新百度token的接口、文章发布时间统计接口等</p><h3 id="LeanCloud数据库配置"><a href="#LeanCloud数据库配置" class="headerlink" title="LeanCloud数据库配置"></a>LeanCloud数据库配置</h3><p>新建结构化数据，创建 Class，填写名称为 <code>BaiduToken</code>，设置默认 ACL read 和 write 权限都为所有用户；</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article06.png" alt="hexo-hot-article 实时文章排行及访客地图06"></p><p>点击添加列，分别新增 <code>accessToken</code> 和 <code>refreshToken</code>；</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article07.png" alt="hexo-hot-article 实时文章排行及访客地图07"></p><p>点击新增行，填写百度统计获取到的 <code>access_token</code> 和 <code>refresh_token</code>；</p><p>点击<strong>设置–&gt;应用凭证</strong>获取连接LeanCloud的<code>APPID</code>与<code>APPKey</code></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article08.png" alt="hexo-hot-article 实时文章排行及访客地图08"></p><h3 id="Github部署"><a href="#Github部署" class="headerlink" title="Github部署"></a>Github部署</h3><p>fork <a href="https://github.com/GC-ZF/hexo-hot-article">GC-ZF&#x2F;hexo-hot-article</a> 项目， <code>Settings--&gt;Security&gt;--&gt;Secrets&gt;--&gt;Actions</code> 中添加以下秘钥：</p><ul><li><code>APIKEY</code>： 百度统计 API Key</li><li><code>SECRETKEY</code>：百度统计 Secret Key</li><li><code>APPID</code>：LeanCloud AppID</li><li><code>APPKEY</code>：LeanCloud AppKey</li></ul><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article09.png" alt="hexo-hot-article 实时文章排行及访客地图09"></p><p>点击<code>Backup twikoo--&gt;Enable workflow</code>启用工作流，然后点击<code>Run workflow</code>手动运行测试能否运行并更新leancloud中的token</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article10.png" alt="hexo-hot-article 实时文章排行及访客地图10"></p><h3 id="Vercel一键部署"><a href="#Vercel一键部署" class="headerlink" title="Vercel一键部署"></a>Vercel一键部署</h3><p>将自己fork的项目导入Vercel并设置环境变量</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article11.png" alt="hexo-hot-article 实时文章排行及访客地图11"></p><p>部署成功后，你会看到 <strong>『部署成功，请按照仓库说明使用』</strong></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article12.png" alt="hexo-hot-article 实时文章排行及访客地图12"></p><p>上图中右侧的免费域名是被墙的，推荐在 <strong>『setting-&gt;domains』</strong> 中绑定一个自己的域名</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://testingcf.jsdelivr.net/gh/GC-ZF/hexo-hot-article/static/hexo-hot-article13.png" alt="hexo-hot-article 实时文章排行及访客地图13"></p><h3 id="Docker一键部署"><a href="#Docker一键部署" class="headerlink" title="Docker一键部署"></a>Docker一键部署</h3><p>vercel也可以使用Docker替代</p><p>启动镜像</p><figure class="highlight docker"><table><tr><td class="code"><pre><span class="line">docker <span class="keyword">run</span><span class="language-bash"> -itd --name=hexo-hot-article --restart=always -v /home/ubuntu/hexo-hot-article:/app/data -p 9135:8000 -e APPID=<span class="string">&quot;LeanCloud的APPID&quot;</span> -e APPKEY=<span class="string">&quot;LeanCloud的APPKEY&quot;</span> -zhshier/hexo-hot-article</span></span><br></pre></td></tr></table></figure><p>测试：返回 <strong>『部署成功，请按照仓库说明使用』</strong> 则部署成功</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl http://127.0.0.1:9135</span><br></pre></td></tr></table></figure><p>在服务器面板中打开9135端口外网即可通过 <strong>『ip:9135』</strong> 访问</p><h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><p>未来可能添加的功能（先画大饼嘻嘻，应该也发现了最近小张发文频率不高，因为实在是事情太多，近几个月尽量每月一篇吧！）</p><ul><li><p><input checked="" disabled="" type="checkbox"> 2023.08.24vercel自建添加自动更新百度token</p></li><li><p><input checked="" disabled="" type="checkbox"> 2023.01.26避免重复造轮子部署，自用整合微博、贡献日历</p><p><a href="https://github.com/Eurkon/weibo-top-api">Eurkon&#x2F;weibo-top-api: 使用python爬取微博热搜</a></p><p><a href="https://github.com/Zfour/python_github_calendar_api/">Zfour&#x2F;python_github_calendar_api: 用python获取github上的用户贡献信息，部署于vercel的api</a></p></li><li><p><input disabled="" type="checkbox"> 添加51la、谷歌分析（51la得Github Actions很头痛，数据不能实时更新）</p></li><li><p><input disabled="" type="checkbox"> 文章发布时间柱状统计图</p></li></ul><p>感谢<a href="https://github.com/Eurkon">@Eurkon</a>、<a href="https://github.com/Zfour">@Zfour</a></p><p>如果你有好的点子，多多pr啊🤩</p>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/Hexo/">Hexo</category>
      
      
      <category domain="https://zhsher.cn/tags/Hexo/">Hexo</category>
      
      
      <comments>https://zhsher.cn/posts/12205/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>爬虫小记：那些年我们丢掉的文章</title>
      <link>https://zhsher.cn/posts/980/</link>
      <guid>https://zhsher.cn/posts/980/</guid>
      <pubDate>Mon, 26 Dec 2022 14:39:51 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;不知道从何记起，自己的博客小有ip后，经常会看后台访客数据，从哪个页面跳转进来？为什么他在这个页面呆了这么久，我写了什么呢？但是小张强迫症有</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>不知道从何记起，自己的博客小有ip后，经常会看后台访客数据，从哪个页面跳转进来？为什么他在这个页面呆了这么久，我写了什么呢？但是小张强迫症有一丢丢严重，宁死不访问入口地址，因为自己也算访客会造成『假』数据，而是在本地文件夹翻这个文章地址。所以想做一个爬虫把所有的文章标题、链接导出为文件</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E7%88%AC%E8%99%AB%E5%B0%8F%E8%AE%B0%EF%BC%9A%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E4%B8%A2%E6%8E%89%E7%9A%84%E6%96%87%E7%AB%A0/%E7%88%AC%E8%99%AB%E5%B0%8F%E8%AE%B0%EF%BC%9A%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E4%B8%A2%E6%8E%89%E7%9A%84%E6%96%87%E7%AB%A001.png" alt="爬虫小记：那些年我们丢掉的文章01"></p><p>做完之后又好奇他们怎么老扒我呢？！我经常会看到我的文章发在别的地方，公开处刑</p><ul><li><p><a href="https://its203.com/">程序员ITS203</a></p></li><li><p><a href="https://copyfuture.com/">复制未来 (copyfuture.com)</a></p></li><li><p>某知乎专栏</p></li><li><p>不知名的扒盗者</p></li></ul><p>所以这篇小记上满足三个需求：</p><ol><li>导出博客文章数据包括标题、链接</li><li>爬取博客文章并导出md文件</li><li>利用百度统计收集博客信息：『热门文章、访客省份、访客国家』的PV、UV、停留时长等数据</li></ol><p>本篇文章也是<a href="https://github.com/GC-ZF/hexo-hot-article">hexo-hot-article</a>的一个开发前传，数据全是本地导出文件，因为一开始想做成Github工作流形式但是考虑到大部分小白对Github使用比较吃力，下一篇这三个需求都将集成接口方便玩hexo的朋友调用</p><h2 id="导出博客数据"><a href="#导出博客数据" class="headerlink" title="导出博客数据"></a>导出博客数据</h2><p>需求分析：提取博客内所有的『文章标题、文章地址、文章创建时间』，而博文页中封面和标题的div中都包含这些信息</p><p>思路分析：</p><ol><li>获取博客有x页</li><li>当前页有x篇文章</li><li>抓取信息并写入json、md、sql、excel方便本地检索或为后期换用Github Actions做准备</li></ol><p>其中博客页数又分三种情况，在不同的页数下网页结构是不一样的</p><p>文章栏分封面和信息两部分，都有标题和链接，但下面多一个『发表于』，所以就直接拿下面的信息一把梭哈</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">title_list = html.xpath ( <span class="string">&#x27;//*[@class=&quot;recent-post-info&quot;]/a/@title&#x27;</span> ) <span class="comment"># 文章标题</span></span><br><span class="line">link_list = html.xpath ( <span class="string">&#x27;//*[@class=&quot;recent-post-info&quot;]/a/@href&#x27;</span> ) <span class="comment"># 文章地址</span></span><br><span class="line">time_list = html.xpath ( <span class="string">&#x27;//*[@class=&quot;post-meta-date-created&quot;]/text()&#x27;</span> ) <span class="comment"># 发表于</span></span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E7%88%AC%E8%99%AB%E5%B0%8F%E8%AE%B0%EF%BC%9A%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E4%B8%A2%E6%8E%89%E7%9A%84%E6%96%87%E7%AB%A0/%E7%88%AC%E8%99%AB%E5%B0%8F%E8%AE%B0%EF%BC%9A%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E4%B8%A2%E6%8E%89%E7%9A%84%E6%96%87%E7%AB%A002.png" alt="爬虫小记：那些年我们丢掉的文章02"></p><p>具体代码实现</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@Author:张时贰</span></span><br><span class="line"><span class="string">@Date:2022年12月16日</span></span><br><span class="line"><span class="string">@CSDN:张时贰</span></span><br><span class="line"><span class="string">@Blog:zhsher.cn</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> xlsxwriter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取博客页数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_page_num</span>(<span class="params">blog_url</span>):</span><br><span class="line">    r = requests.get ( blog_url )</span><br><span class="line">    r = r.content.decode ( <span class="string">&#x27;utf-8&#x27;</span> )</span><br><span class="line">    html = etree.HTML ( r )</span><br><span class="line">    <span class="comment"># 获取博客页数</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        page_num = html.xpath ( <span class="string">&#x27;//*[@class=&quot;pagination&quot;]/a[2]//text()&#x27;</span> )[ <span class="number">0</span> ]  <span class="comment"># 博客页数较多</span></span><br><span class="line">    <span class="keyword">except</span> IndexError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            e = <span class="built_in">str</span> ( e )</span><br><span class="line">            <span class="built_in">print</span> ( <span class="string">&quot;error:&quot;</span> + e + <span class="string">&quot;，博客页数较少没有 &lt;span class=\&quot;space\&quot;&gt;…&lt;/span&gt;&quot;</span> )</span><br><span class="line">            page_num = html.xpath ( <span class="string">&#x27;//*[@class=&quot;pagination&quot;]/a//text()&#x27;</span> )[ <span class="number">0</span> ]  <span class="comment"># 博客页数少没有翻页按钮没有1...X而是直接显示1、2、3</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            e = <span class="built_in">str</span> ( e )</span><br><span class="line">            <span class="built_in">print</span> ( <span class="string">&quot;error:&quot;</span> + e + <span class="string">&quot;，博客只有一页&quot;</span> )</span><br><span class="line">            page_num = <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> page_num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># request无法异步，换用aiohttp库做异步请求</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">requests_get</span>(<span class="params">link</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession () <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> session.get ( link ) <span class="keyword">as</span> resp:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                text = <span class="keyword">await</span> resp.text ()</span><br><span class="line">                <span class="keyword">return</span> text</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                e = <span class="built_in">str</span> ( e )</span><br><span class="line">                <span class="built_in">print</span> ( <span class="string">f&#x27;请求状态码<span class="subst">&#123;resp.status&#125;</span>，错误：<span class="subst">&#123;e&#125;</span>&#x27;</span> )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 抓取博客当前页文章的 标题 链接</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_info</span>(<span class="params">url</span>):</span><br><span class="line">    html = <span class="keyword">await</span> requests_get ( url )</span><br><span class="line">    html = etree.HTML ( html )</span><br><span class="line">    title_list = html.xpath ( <span class="string">&#x27;//*[@class=&quot;recent-post-info&quot;]/a/@title&#x27;</span> )</span><br><span class="line">    link_list = html.xpath ( <span class="string">&#x27;//*[@class=&quot;recent-post-info&quot;]/a/@href&#x27;</span> )</span><br><span class="line">    <span class="comment"># time_list = html.xpath ( &#x27;//*[@class=&quot;post-meta-date-created&quot;]/text()&#x27; ) # 博客未开启更新于时不适用</span></span><br><span class="line">    time_list = html.xpath ( <span class="string">&#x27;//*[@class=&quot;post-meta-date-created&quot;]/text()&#x27;</span> )</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span> ( time_list ) == <span class="number">0</span>:</span><br><span class="line">        time_list = html.xpath ( <span class="string">&#x27;//*[@class=&quot;post-meta-date&quot;]/time/text()&#x27;</span> )</span><br><span class="line">    post_num = <span class="built_in">len</span> ( title_list )  <span class="comment"># 文章数</span></span><br><span class="line">    title_link_time_list_page = [ ]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( post_num ):</span><br><span class="line">        title = title_list[ i ]</span><br><span class="line">        link = link_list[ i ]</span><br><span class="line">        time = time_list[ i ]</span><br><span class="line">        tmp = &#123;<span class="string">&quot;title&quot;</span>: title, <span class="string">&quot;link&quot;</span>: blog_url + link, <span class="string">&quot;time&quot;</span>: time&#125;</span><br><span class="line">        title_link_time_list_page.append ( tmp )</span><br><span class="line">    <span class="keyword">return</span> title_link_time_list_page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 本地文件调试</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">site_url</span>):</span><br><span class="line">    <span class="keyword">global</span> blog_url</span><br><span class="line">    blog_url = site_url</span><br><span class="line">    page_num = <span class="built_in">int</span> ( get_page_num ( blog_url ) )  <span class="comment"># 博客页数</span></span><br><span class="line">    <span class="comment"># 如果博客只有一页</span></span><br><span class="line">    <span class="keyword">if</span> page_num.__eq__ ( <span class="number">1</span> ):</span><br><span class="line">        <span class="comment"># 创建协程容器（获取事件循环）</span></span><br><span class="line">        loop = asyncio.get_event_loop ()</span><br><span class="line">        <span class="comment"># 指定协程添加任务</span></span><br><span class="line">        tasks = [ asyncio.ensure_future ( get_info ( blog_url ) ) ]</span><br><span class="line">        <span class="comment"># 运行任务（将所有的事件对象传入事件循环）</span></span><br><span class="line">        loop.run_until_complete ( asyncio.wait ( tasks ) )  <span class="comment"># Fastapi中线程占用不能用until方法</span></span><br><span class="line">    <span class="comment"># 如果博客多于1页</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># 创建协程容器（获取事件循环）</span></span><br><span class="line">        loop = asyncio.get_event_loop ()</span><br><span class="line">        <span class="comment"># 指定协程添加任务</span></span><br><span class="line">        tasks = [ asyncio.ensure_future ( get_info ( blog_url ) ) ]  <span class="comment"># 第一页</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="number">1</span>, page_num ):</span><br><span class="line">            tasks.append ( asyncio.ensure_future ( get_info ( <span class="string">f&#x27;<span class="subst">&#123;blog_url&#125;</span>/page/<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>/#content-inner&#x27;</span> ) ) )</span><br><span class="line">        <span class="comment"># 运行任务（将所有的事件对象传入事件循环）</span></span><br><span class="line">        loop.run_until_complete ( asyncio.wait ( tasks ) )  <span class="comment"># Fastapi中线程占用不能用until方法</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 将异步返回值合并</span></span><br><span class="line">    title_link_time_list = [ ]  <span class="comment"># 列表字典 文章标题 链接 发布于</span></span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> tasks:</span><br><span class="line">        title_link_time_list = title_link_time_list + task.result ()</span><br><span class="line">    title_link_time_list = <span class="built_in">sorted</span> ( title_link_time_list, key=<span class="keyword">lambda</span> x: x[ <span class="string">&#x27;time&#x27;</span> ], reverse=<span class="literal">True</span> )  <span class="comment"># 解决因为异步导致的乱序，按时间降序</span></span><br><span class="line">    <span class="keyword">return</span> title_link_time_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入md文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_md</span>(<span class="params">row, post_info</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span> ( <span class="string">&#x27;Post_Table.md&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span> ) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( row ):</span><br><span class="line">            f.write ( <span class="string">&#x27;| Post &#x27;</span> )</span><br><span class="line">        f.write ( <span class="string">&#x27;| \n&#x27;</span> )</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( row ):</span><br><span class="line">            f.write ( <span class="string">&#x27;| :----: &#x27;</span> )</span><br><span class="line">        f.write ( <span class="string">&#x27;| \n&#x27;</span> )</span><br><span class="line">        tmp = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> post_info:</span><br><span class="line">            tmp = tmp + <span class="number">1</span></span><br><span class="line">            title = <span class="string">f&#x27;| [<span class="subst">&#123;line[ <span class="string">&quot;title&quot;</span> ]&#125;</span>](<span class="subst">&#123;line[ <span class="string">&quot;link&quot;</span> ]&#125;</span>) &#x27;</span></span><br><span class="line">            f.write ( title )</span><br><span class="line">            <span class="keyword">if</span> row.__eq__ ( tmp ):</span><br><span class="line">                f.write ( <span class="string">&#x27;| \n&#x27;</span> )</span><br><span class="line">                tmp = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入json文件</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_json</span>(<span class="params">post_info</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span> ( <span class="string">&#x27;Post_Table.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span> ) <span class="keyword">as</span> f:</span><br><span class="line">        f.write ( json.dumps ( post_info, indent=<span class="number">4</span>, ensure_ascii=<span class="literal">False</span> ) )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入db</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_sql</span>(<span class="params">post_info</span>):</span><br><span class="line">    <span class="comment"># 将字典转集合，方便后续去重批量执行sql语句</span></span><br><span class="line">    link_title_set = <span class="built_in">set</span> ()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> post_info:</span><br><span class="line">        tmp = (i[ <span class="string">&#x27;title&#x27;</span> ], i[ <span class="string">&#x27;link&#x27;</span> ], i[ <span class="string">&#x27;time&#x27;</span> ])</span><br><span class="line">        link_title_set.add ( tmp )</span><br><span class="line"></span><br><span class="line">    connect = sqlite3.connect ( <span class="string">&#x27;Blog_Post.db&#x27;</span> )  <span class="comment"># 连接数据库</span></span><br><span class="line">    sql = connect.cursor ()  <span class="comment"># 创建cursor对象</span></span><br><span class="line">    <span class="comment"># sql.execute ( &quot;DROP TABLE IF EXISTS Blog_Post&quot; )</span></span><br><span class="line">    sql.execute ( <span class="string">&quot;CREATE TABLE if NOT EXISTS Blog_Post( title text PRIMARY KEY, link text, time text)&quot;</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 去重</span></span><br><span class="line">    link_title_table = sql.execute ( <span class="string">&quot;SELECT * FROM Blog_Post&quot;</span> ).fetchall ()</span><br><span class="line">    link_title_table = <span class="built_in">set</span> ( link_title_table )</span><br><span class="line">    link_title_set = link_title_set - link_title_table</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 插入文章数据</span></span><br><span class="line">    <span class="comment"># sql.execute (</span></span><br><span class="line">    <span class="comment">#     &quot;INSERT INTO Blog_Post VALUES( &#x27;2022 11 13 月亮还是那个月亮&#x27;,&#x27;https://zzhsher.cn/posts/53805/&#x27;,&#x27;2022-11-13 00:10:24&#x27;)&quot; )</span></span><br><span class="line">    sql.executemany ( <span class="string">&#x27;INSERT INTO Blog_Post(title,link,time) VALUES(  ?, ?, ?)&#x27;</span>, link_title_set )</span><br><span class="line"></span><br><span class="line">    connect.commit ()</span><br><span class="line">    connect.close ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入excel</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_excel</span>(<span class="params">post_info</span>):</span><br><span class="line">    workbook = xlsxwriter.Workbook ( <span class="string">&#x27;Post_Table.xlsx&#x27;</span> )  <span class="comment"># 创建工作簿</span></span><br><span class="line">    worksheet = workbook.add_worksheet ( <span class="string">&quot;博客数据&quot;</span> )  <span class="comment"># 创建子表</span></span><br><span class="line">    <span class="built_in">format</span> = &#123;</span><br><span class="line">        <span class="comment"># &#x27;bold&#x27;: True,  # 字体加粗</span></span><br><span class="line">        <span class="string">&#x27;align&#x27;</span>: <span class="string">&#x27;center&#x27;</span>,  <span class="comment"># 水平位置设置：居中</span></span><br><span class="line">        <span class="string">&#x27;valign&#x27;</span>: <span class="string">&#x27;vcenter&#x27;</span>,  <span class="comment"># 垂直位置设置，居中</span></span><br><span class="line">        <span class="comment"># &#x27;font_size&#x27;: 10,  # &#x27;字体大小设置&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">format</span> = workbook.add_format ( <span class="built_in">format</span> )</span><br><span class="line">    worksheet.set_column ( <span class="number">0</span>, <span class="number">0</span>, <span class="number">50</span> )  <span class="comment"># 行宽</span></span><br><span class="line">    worksheet.set_column ( <span class="number">1</span>, <span class="number">1</span>, <span class="number">40</span> )  <span class="comment"># 行宽</span></span><br><span class="line">    worksheet.set_column ( <span class="number">2</span>, <span class="number">2</span>, <span class="number">30</span> )  <span class="comment"># 行宽</span></span><br><span class="line">    worksheet.activate ()  <span class="comment"># 激活表</span></span><br><span class="line">    title = [ <span class="string">&#x27;标题&#x27;</span>, <span class="string">&#x27;链接&#x27;</span>, <span class="string">&#x27;发布于&#x27;</span> ]  <span class="comment"># 设置表头</span></span><br><span class="line">    worksheet.write_row ( <span class="string">&#x27;A1&#x27;</span>, title, <span class="built_in">format</span> )  <span class="comment"># 从A1单元格开始写入表头</span></span><br><span class="line">    i = <span class="number">2</span>  <span class="comment"># 从第二行开始写入数据</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="built_in">len</span> ( post_info ) ):</span><br><span class="line">        insertData = [ post_info[ j ][ <span class="string">&quot;title&quot;</span> ], post_info[ j ][ <span class="string">&quot;link&quot;</span> ], post_info[ j ][ <span class="string">&quot;time&quot;</span> ] ]</span><br><span class="line">        row = <span class="string">&#x27;A&#x27;</span> + <span class="built_in">str</span> ( i )</span><br><span class="line">        worksheet.write_row ( row, insertData, <span class="built_in">format</span> )</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    workbook.close ()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time ()</span><br><span class="line">    blog_url = <span class="string">&#x27;https://zhsher.cn&#x27;</span>  <span class="comment"># 博客地址</span></span><br><span class="line">    <span class="comment"># blog_url = &#x27;https://blog.panghai.top&#x27;  # 博客地址</span></span><br><span class="line">    <span class="comment"># blog_url = &#x27;https://luomengguo.top&#x27;  # 博客地址</span></span><br><span class="line">    <span class="comment"># blog_url = &#x27;https://blog.leonus.cn&#x27;  # 博客地址</span></span><br><span class="line">    <span class="comment"># blog_url = &#x27;https://www.chuckle.top&#x27;  # 博客地址</span></span><br><span class="line">    <span class="comment"># blog_url = &#x27;https://anzhiy.cn&#x27;  # 博客地址</span></span><br><span class="line"></span><br><span class="line">    row = <span class="number">4</span>  <span class="comment"># 输出md文件列数</span></span><br><span class="line">    title_link_time_list = run ( blog_url )  <span class="comment"># 异步抓取</span></span><br><span class="line">    <span class="built_in">print</span> ( title_link_time_list )</span><br><span class="line">    <span class="comment"># save_json ( title_link_time_list )  # 写入json文件</span></span><br><span class="line">    <span class="comment"># save_md ( row, title_link_time_list )  # 写入md文件</span></span><br><span class="line">    <span class="comment"># save_sql ( title_link_time_list )  # 写入sql文件</span></span><br><span class="line">    <span class="comment"># save_excel ( title_link_time_list )  # 写入excel</span></span><br><span class="line">    <span class="built_in">print</span> ( time.time () - start )</span><br></pre></td></tr></table></figure><h2 id="爬取博客文章"><a href="#爬取博客文章" class="headerlink" title="爬取博客文章"></a>爬取博客文章</h2><p>需求分析：通过给定链接获取页面html并转为markdown保存</p><p>遇到问题：</p><ol><li><p>当蝴蝶主题开启懒加载，img标签中src不等于实际地址</p><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;实际地址&quot;</span> <span class="attr">data-fancybox</span>=<span class="string">&quot;gallery&quot;</span> <span class="attr">data-caption</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;懒加载编码&quot;</span> <span class="attr">data-lazy-src</span>=<span class="string">&quot;实际地址&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">style</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>代码框是一个table包裹的，转md格式会乱。而且当主题开启代码换行，table中分为两块，行号和代码，转md后会生成两个代码框，分别是行号和代码</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E7%88%AC%E8%99%AB%E5%B0%8F%E8%AE%B0%EF%BC%9A%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E4%B8%A2%E6%8E%89%E7%9A%84%E6%96%87%E7%AB%A0/%E7%88%AC%E8%99%AB%E5%B0%8F%E8%AE%B0%EF%BC%9A%E9%82%A3%E4%BA%9B%E5%B9%B4%E6%88%91%E4%BB%AC%E4%B8%A2%E6%8E%89%E7%9A%84%E6%96%87%E7%AB%A003.png" alt="爬虫小记：那些年我们丢掉的文章03"></p></li></ol><p>三种思路，起初用的parsel库因为开启懒加载后无法获取图片地址，转用selenium库（南辕北辙了），后来又想到通过别的途径替换img中的src的值</p><p>经测试方案三用时最短，主要Selenium库是浏览器自动化工具，模拟打开浏览器加载请求资源太多了，这个不可控，而且网页渲染会多出很多其它标签，特别不好掌控</p><h3 id="By-Selenium-Value"><a href="#By-Selenium-Value" class="headerlink" title="By Selenium Value"></a>By Selenium Value</h3><p>方案一：模拟打开浏览器，通过js操作：<code>document.querySelectorAll(&#39;.post-content p img&#39;)[&#123;i&#125;].src = &#39;&#123;a_href&#125;</code>，将img中的src地址换为a标签中的地址，之后获取网页html</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">by_selenium_value</span>(<span class="params">link</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    方案一：利用selenium库，img标签外包裹了a标签，a标签中有img的实际地址，通过dom操作将a.src给img.href</span></span><br><span class="line"><span class="string">    :param link: 文章链接</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 1、创建浏览器对象 - 打开浏览器</span></span><br><span class="line">    driver = webdriver.Chrome ()  <span class="comment"># 本地调试打开浏览器窗口</span></span><br><span class="line">    driver.maximize_window ()</span><br><span class="line">    <span class="comment"># driver = webdriver.Chrome ( options=add_options () )  # 不开启浏览器的情况下调试</span></span><br><span class="line">    <span class="comment"># 2、打开博文</span></span><br><span class="line">    driver.get ( link )</span><br><span class="line">    <span class="comment"># 3、找到所有a、img标签</span></span><br><span class="line">    a_list = driver.find_elements ( By.XPATH, <span class="string">&#x27;//*[@id=&quot;article-container&quot;]/p/a/img/..&#x27;</span> )</span><br><span class="line">    <span class="comment"># 4、替换所有的img.href=a.src</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="built_in">len</span> ( a_list ) ):</span><br><span class="line">        a_href = a_list[ i ].get_attribute ( <span class="string">&#x27;href&#x27;</span> )</span><br><span class="line">        js = <span class="string">f&quot;document.querySelectorAll(&#x27;.post-content p img&#x27;)[<span class="subst">&#123;i&#125;</span>].src = &#x27;<span class="subst">&#123;a_href&#125;</span>&#x27;&quot;</span></span><br><span class="line">        driver.execute_script ( js )</span><br><span class="line">    <span class="comment"># 5、获取文章内容部分的HTML</span></span><br><span class="line">    post_content = driver.find_element ( By.XPATH, <span class="string">&#x27;//*[@id=&quot;article-container&quot;]&#x27;</span> ).get_attribute ( <span class="string">&#x27;outerHTML&#x27;</span> )</span><br><span class="line">    post_title = driver.find_element ( By.CSS_SELECTOR, <span class="string">&#x27;.post-title&#x27;</span> ).get_attribute ( <span class="string">&#x27;innerHTML&#x27;</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6、二次处理</span></span><br><span class="line">    <span class="comment"># 蝴蝶主题代码框用table绘制分为行号（.gutter）和代码区域（.code） table标签转md会生成 &#x27;---&#x27;，解决： 用replace去除table，遍历去除&lt;td class=&quot;gutter&quot;&gt;xxx&lt;/td&gt;</span></span><br><span class="line">    post_content = post_content.replace ( <span class="string">&#x27;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&#x27;</span> )  <span class="comment"># 主题配置代码不换行情况匹配规则 code_word_wrap: false</span></span><br><span class="line">    post_content = post_content.replace ( <span class="string">&#x27;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&#x27;</span> )  <span class="comment"># 主题配置代码不换行情况匹配规则 code_word_wrap: true</span></span><br><span class="line">    <span class="comment"># 去除 .gutter</span></span><br><span class="line">    tmp = driver.find_elements ( By.CSS_SELECTOR, <span class="string">&#x27;.gutter&#x27;</span> )</span><br><span class="line">    code_span = [ ]  <span class="comment"># 找出所有的.gutter标签</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tmp:</span><br><span class="line">        code_span.append ( i.get_attribute ( <span class="string">&#x27;outerHTML&#x27;</span> ) )</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code_span:</span><br><span class="line">        post_content = post_content.replace ( i, <span class="string">&#x27;&#x27;</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7、保存markdown</span></span><br><span class="line">    <span class="comment"># markdown = html2text.html2text ( post_content )</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># path = os.path.dirname ( __file__ )</span></span><br><span class="line">    <span class="comment"># path = path + &#x27;/by_selenium_value&#x27;</span></span><br><span class="line">    <span class="comment"># if not os.path.exists ( path ):</span></span><br><span class="line">    <span class="comment">#     os.mkdir ( path )</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># with open ( f&#x27;&#123;path&#125;/&#123;post_title&#125;.md&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27; ) as file:</span></span><br><span class="line">    <span class="comment">#     file.write ( markdown )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url = <span class="string">&#x27;https://zhsher.cn/posts/7884/&#x27;</span></span><br><span class="line">    <span class="comment"># url = &#x27;https://zhsher.cn/posts/53805/&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print ( &#x27;by_selenium_value运行时长：&#x27; )</span></span><br><span class="line">    <span class="comment"># start = time.time ()</span></span><br><span class="line">    <span class="comment"># by_selenium_value ( url )</span></span><br><span class="line">    <span class="comment"># print ( time.time () - start )</span></span><br></pre></td></tr></table></figure><h3 id="By-Selenium-Scroll"><a href="#By-Selenium-Scroll" class="headerlink" title="By Selenium Scroll"></a>By Selenium Scroll</h3><p>方案二：模拟滚动到每一个包裹img标签的a标签，让图片加载出来，之后再获取网页html</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add_options</span>():</span><br><span class="line">    <span class="comment"># 创建谷歌浏览器驱动参数对象</span></span><br><span class="line">    chrome_options = webdriver.ChromeOptions ()</span><br><span class="line">    <span class="comment"># 不加载图片</span></span><br><span class="line">    prefs = &#123;<span class="string">&quot;profile.managed_default_content_settings.images&quot;</span>: <span class="number">2</span>&#125;</span><br><span class="line">    chrome_options.add_experimental_option ( <span class="string">&quot;prefs&quot;</span>, prefs )</span><br><span class="line">    <span class="comment"># 使用无界面浏览器模式！！</span></span><br><span class="line">    chrome_options.add_argument ( <span class="string">&#x27;--headless&#x27;</span> )</span><br><span class="line">    <span class="comment"># 使用隐身模式（无痕模式）</span></span><br><span class="line">    chrome_options.add_argument ( <span class="string">&#x27;--incognito&#x27;</span> )</span><br><span class="line">    <span class="comment"># 禁用GPU加速</span></span><br><span class="line">    chrome_options.add_argument ( <span class="string">&#x27;--disable-gpu&#x27;</span> )</span><br><span class="line">    <span class="keyword">return</span> chrome_options</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">by_selenium_scroll</span>(<span class="params">link</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    方案二：利用selenium库，img标签外包裹了a标签，找到所有的img的上一级a，滚动到a让图片加载（直接找图片会造成滚动坐标越界）</span></span><br><span class="line"><span class="string">    :param link: 文章链接</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 1、创建浏览器对象 - 打开浏览器</span></span><br><span class="line">    driver = webdriver.Chrome ()  <span class="comment"># 本地调试打开浏览器窗口</span></span><br><span class="line">    driver.maximize_window ()</span><br><span class="line">    <span class="comment"># driver = webdriver.Chrome ( options=add_options () )  # 不开启浏览器的情况下调试</span></span><br><span class="line">    <span class="comment"># 2、打开博文</span></span><br><span class="line">    driver.get ( link )</span><br><span class="line">    <span class="comment"># 3、找到所有图片外包裹的a</span></span><br><span class="line">    img_list = driver.find_elements ( By.XPATH, <span class="string">&#x27;//*[@id=&quot;article-container&quot;]/p/a/img/..&#x27;</span> )</span><br><span class="line">    <span class="comment"># img_list = driver.find_elements ( By.CSS_SELECTOR, &#x27;#article-container p a&#x27; )</span></span><br><span class="line">    <span class="comment"># 4、滚动到图片位置</span></span><br><span class="line">    <span class="keyword">for</span> img <span class="keyword">in</span> img_list:</span><br><span class="line">        ActionChains ( driver ).scroll_to_element ( img ).perform ()</span><br><span class="line">    <span class="comment"># 5、获取文章内容部分的HTML</span></span><br><span class="line">    post_content = driver.find_element ( By.XPATH, <span class="string">&#x27;//*[@id=&quot;article-container&quot;]&#x27;</span> ).get_attribute ( <span class="string">&#x27;outerHTML&#x27;</span> )</span><br><span class="line">    post_title = driver.find_element ( By.CSS_SELECTOR, <span class="string">&#x27;.post-title&#x27;</span> ).get_attribute ( <span class="string">&#x27;innerHTML&#x27;</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6、二次处理</span></span><br><span class="line">    <span class="comment"># 蝴蝶主题代码框用table绘制分为行号（.gutter）和代码区域（.code） table标签转md会生成 &#x27;---&#x27;，解决： 用replace去除table，遍历去除&lt;td class=&quot;gutter&quot;&gt;xxx&lt;/td&gt;</span></span><br><span class="line">    post_content = post_content.replace ( <span class="string">&#x27;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&#x27;</span> )  <span class="comment"># 主题配置代码不换行情况匹配规则 code_word_wrap: false</span></span><br><span class="line">    post_content = post_content.replace ( <span class="string">&#x27;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;&lt;tbody&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&#x27;</span> )  <span class="comment"># 主题配置代码不换行情况匹配规则 code_word_wrap: true</span></span><br><span class="line">    <span class="comment"># 去除 .gutter</span></span><br><span class="line">    tmp = driver.find_elements ( By.CSS_SELECTOR, <span class="string">&#x27;.gutter&#x27;</span> )</span><br><span class="line">    code_span = [ ]  <span class="comment"># 找出所有的.gutter标签</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> tmp:</span><br><span class="line">        code_span.append ( i.get_attribute ( <span class="string">&#x27;outerHTML&#x27;</span> ) )</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code_span:</span><br><span class="line">        post_content = post_content.replace ( i, <span class="string">&#x27;&#x27;</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 7、保存markdown</span></span><br><span class="line">    <span class="comment"># markdown = html2text.html2text ( post_content )</span></span><br><span class="line">    <span class="comment"># path = os.path.dirname ( __file__ )</span></span><br><span class="line">    <span class="comment"># path = path + &#x27;/by_selenium_scroll&#x27;</span></span><br><span class="line">    <span class="comment"># if not os.path.exists ( path ):</span></span><br><span class="line">    <span class="comment">#     os.mkdir ( path )</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># with open ( f&#x27;&#123;path&#125;/&#123;post_title&#125;.md&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27; ) as file:</span></span><br><span class="line">    <span class="comment">#     file.write ( markdown )</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url = <span class="string">&#x27;https://zhsher.cn/posts/7884/&#x27;</span></span><br><span class="line">    <span class="comment"># url = &#x27;https://zhsher.cn/posts/53805/&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print ( &#x27;by_selenium_scroll运行时长：&#x27; )</span></span><br><span class="line">    <span class="comment"># start = time.time ()</span></span><br><span class="line">    <span class="comment"># by_selenium_scroll ( url )</span></span><br><span class="line">    <span class="comment"># print ( time.time () - start )</span></span><br></pre></td></tr></table></figure><h3 id="By-Parsel"><a href="#By-Parsel" class="headerlink" title="By Parsel"></a>By Parsel</h3><p>方案叁：又快又好用，太完美了！！！</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">by_parsel_replace</span>(<span class="params">link</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    方案叁：利用parsel库，img标签中 src和data-lazy-src替换： &lt;img src=&quot;懒加载编码&quot; data-lazy-src=&quot;实际地址&quot; alt=&quot;&quot; style=&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">    :param link: 文章链接</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 1、爬取html代码</span></span><br><span class="line">    request = requests.get ( link )</span><br><span class="line">    html = request.content.decode ( <span class="string">&#x27;utf-8&#x27;</span> )</span><br><span class="line">    select = parsel.Selector ( html )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2、获取文章标题和内容</span></span><br><span class="line">    post_title = select.css ( <span class="string">&#x27;.post-title::text&#x27;</span> ).get ()</span><br><span class="line">    post_content = select.css ( <span class="string">&#x27;.post-content&#x27;</span> ).get ()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3、处理懒加载图片</span></span><br><span class="line">    post_content = post_content.replace ( <span class="string">&#x27;src&#x27;</span>, <span class="string">&#x27;lazy&#x27;</span> ).replace ( <span class="string">&#x27;data-lazy-lazy&#x27;</span>, <span class="string">&#x27;src&#x27;</span> )  <span class="comment"># 处理图片</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4、处理多余的标签</span></span><br><span class="line">    <span class="comment"># 蝴蝶主题代码框用table绘制分为行号（.gutter）和代码区域（.code） table标签转md会生成 &#x27;---&#x27;，解决： 用replace去除table，遍历去除&lt;td class=&quot;gutter&quot;&gt;xxx&lt;/td&gt;</span></span><br><span class="line">    <span class="comment"># 去&lt;table&gt;</span></span><br><span class="line">    post_content = post_content.replace ( <span class="string">&#x27;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&#x27;</span> )  <span class="comment"># 主题配置代码不换行情况匹配规则 code_word_wrap: false</span></span><br><span class="line">    post_content = post_content.replace ( <span class="string">&#x27;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&#x27;</span>,</span><br><span class="line">                                          <span class="string">&#x27;&lt;tr&gt;&lt;td class=&quot;code&quot;&gt;&#x27;</span> )  <span class="comment"># 主题配置代码不换行情况匹配规则 code_word_wrap: true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 去行号 当蝴蝶主题使用代码框换行时，代码框是单独的一个td标签，用replace处理掉</span></span><br><span class="line">    code_span = select.css ( <span class="string">&#x27;.gutter&#x27;</span> ).getall ()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code_span:</span><br><span class="line">        post_content = post_content.replace ( i, <span class="string">&#x27;&#x27;</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5、转md</span></span><br><span class="line">    markdown = html2text.html2text ( post_content )</span><br><span class="line">    <span class="comment"># with open ( f&#x27;by_parsel_replace/&#123;post_title&#125;.md&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27; ) as file:</span></span><br><span class="line">    <span class="comment">#     file.writelines ( markdown )</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6、去代码框前多余的换行</span></span><br><span class="line">    markdown = markdown.split ( <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    file_content = [ ]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="built_in">len</span> ( markdown ) ):</span><br><span class="line">        <span class="keyword">if</span> (markdown[ i ].__eq__ ( <span class="string">&#x27;    &#x27;</span> ) <span class="keyword">or</span> markdown[ i ].__eq__ ( <span class="string">&#x27;      &#x27;</span> )):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            file_content.append ( markdown[ i ] + <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    <span class="comment"># 7、保存文件</span></span><br><span class="line">    <span class="comment"># path = os.path.dirname ( __file__ )</span></span><br><span class="line">    <span class="comment"># path = path + &#x27;/by_parsel_replace&#x27;</span></span><br><span class="line">    <span class="comment"># if not os.path.exists ( path ):</span></span><br><span class="line">    <span class="comment">#     os.mkdir ( path )</span></span><br><span class="line">    <span class="comment"># print ( file_content )</span></span><br><span class="line">    <span class="comment"># with open ( f&#x27;&#123;path&#125;/&#123;post_title&#125;.md&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27; ) as file:</span></span><br><span class="line">    <span class="comment">#     for i in file_content:</span></span><br><span class="line">    <span class="comment">#         file.write ( i )</span></span><br><span class="line">    <span class="keyword">return</span> post_content</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    url = <span class="string">&#x27;https://zhsher.cn/posts/7884/&#x27;</span></span><br><span class="line">    <span class="comment"># url = &#x27;https://zhsher.cn/posts/53805/&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># print ( &#x27;by_parsel_replace运行时长：&#x27; )</span></span><br><span class="line">    <span class="comment"># start = time.time ()</span></span><br><span class="line">    <span class="comment"># by_parsel_replace ( url )</span></span><br><span class="line">    <span class="comment"># print ( time.time () - start )</span></span><br></pre></td></tr></table></figure><h3 id="CSDN"><a href="#CSDN" class="headerlink" title="CSDN"></a>CSDN</h3><p>到这里本应该结束了，但是偷博客的人总不可能一个博客主题做一种爬虫吧？何况光一个蝴蝶主题都要分不同的配置情况分析，我突然想起来以前不会Hexo的时候用CSDN做博客，而且少去了很多情况讨论，一把梭哈写到底</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">csdn</span>(<span class="params">link</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    爬取CSDN</span></span><br><span class="line"><span class="string">    :param link: 文章链接</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># (.*?):(.*)</span></span><br><span class="line">    <span class="comment"># &quot;$1&quot;:&quot;$2&quot;,</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.105 Safari/537.36 Edg/84.0.522.52&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Referer&quot;</span>: <span class="string">&quot;https://blog.csdn.net/tansty_zh&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    request = requests.get ( link, headers=headers )</span><br><span class="line">    html = request.text</span><br><span class="line">    select = parsel.Selector ( html )</span><br><span class="line">    post_content = select.css ( <span class="string">&#x27;#article_content&#x27;</span> ).get ()</span><br><span class="line">    post_title = select.css ( <span class="string">&#x27;.title-article::text&#x27;</span> ).get ()</span><br><span class="line">    markdown = html2text.html2text ( post_content )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 可能因为CSDN防盗机制，，html2text无法直接解析图片地址被分开 &#x27;![在这里插入图片描述](https://img-\n&#x27;, &#x27;blog.csdnimg.cn/90d.png#pic_center)\n&#x27;</span></span><br><span class="line">    <span class="comment"># with open ( f&#x27;&#123;post_title&#125;.md&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27; ) as file:</span></span><br><span class="line">    <span class="comment">#     file.write (markdown)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 解决办法</span></span><br><span class="line">    markdown = markdown.split ( <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">    file_content = [ ]</span><br><span class="line">    flag = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="built_in">len</span> ( markdown ) - <span class="number">1</span> ):</span><br><span class="line">        <span class="comment"># 如果是空说明换行，插入一个换行</span></span><br><span class="line">        <span class="keyword">if</span> (markdown[ i ].__eq__ ( <span class="string">&#x27;    &#x27;</span> )):</span><br><span class="line">            <span class="comment"># file_content.append ( &#x27;\n&#x27; )</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="comment"># 如果包含 &#x27;](https://img-&#x27; 说明下一次循环是后半个图片地址，flag作为标记</span></span><br><span class="line">        <span class="comment"># img_pattern = re.compile(r&#x27;^!\[.*&#x27;, re.M)</span></span><br><span class="line">        <span class="comment"># img_pattern=img_pattern.match(content).group()</span></span><br><span class="line">        <span class="keyword">elif</span> <span class="string">&#x27;](https://img-&#x27;</span> <span class="keyword">in</span> markdown[ i ]:</span><br><span class="line">            flag = <span class="number">1</span></span><br><span class="line">            img_front_url = markdown[ i ]</span><br><span class="line">        <span class="comment"># flag==1 说明这次循环是图片的后半段地址</span></span><br><span class="line">        <span class="keyword">elif</span> flag == <span class="number">1</span>:</span><br><span class="line">            flag = <span class="number">0</span></span><br><span class="line">            file_content.append ( img_front_url + markdown[ i ] + <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line">        <span class="comment"># 否则就是单纯的文本内容</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            file_content.append ( markdown[ i ] + <span class="string">&#x27;\n&#x27;</span> )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># path = os.path.dirname ( __file__ )</span></span><br><span class="line">    <span class="comment"># path = path + &#x27;/CSDN&#x27;</span></span><br><span class="line">    <span class="comment"># if not os.path.exists ( path ):</span></span><br><span class="line">    <span class="comment">#     os.mkdir ( path )</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># with open ( f&#x27;&#123;path&#125;/&#123;post_title&#125;.md&#x27;, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27; ) as file:</span></span><br><span class="line">    <span class="comment">#     for i in file_content:</span></span><br><span class="line">    <span class="comment">#         file.write ( i )</span></span><br><span class="line">    <span class="keyword">return</span> post_content</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># url = &#x27;https://blog.csdn.net/qq_49488584/article/details/126884686?spm=1001.2014.3001.5502&#x27;</span></span><br><span class="line">    <span class="comment"># print ( &#x27;csdn爬取运行时长：&#x27; )</span></span><br><span class="line">    <span class="comment"># start = time.time ()</span></span><br><span class="line">    <span class="comment"># csdn ( url )</span></span><br><span class="line">    <span class="comment"># print ( time.time () - start )</span></span><br></pre></td></tr></table></figure><h2 id="热门文章及访客统计"><a href="#热门文章及访客统计" class="headerlink" title="热门文章及访客统计"></a>热门文章及访客统计</h2><p>百度有个坑，文档说明可以获取到文章标题但实际请求是空的，所以上面的爬虫直接cv补充就好了。51la可以拿到文章标题但为什么选择百度？下一篇对比选百度的优势</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@Author:张时贰</span></span><br><span class="line"><span class="string">@Date:2022年11月16日</span></span><br><span class="line"><span class="string">@CSDN:张时贰</span></span><br><span class="line"><span class="string">@Blog:zhsher.cn</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">百度统计API文档：https://tongji.baidu.com/api/manual/</span></span><br><span class="line"><span class="string">ACESS_TOKEN 与 REFRESH_TOKEN 申请，查看API文档或以下说明</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">申请 token 的方法：</span></span><br><span class="line"><span class="string">    1.在百度统计控制台点击数据管理开通数据并获取 `API Key` 与 `Secret Key`</span></span><br><span class="line"><span class="string">    2.登录百度账号，获取 `code`（一次性且10min有效） ：http://openapi.baidu.com/oauth/2.0/authorize?response_type=code&amp;client_id=&#123;CLIENT_ID&#125;&amp;redirect_uri=oob&amp;scope=basic&amp;display=popup</span></span><br><span class="line"><span class="string">      其中 `&#123;CLIENT_ID&#125;` 为API key</span></span><br><span class="line"><span class="string">    3.获取 `ACCESS_TOKEN` ：http://openapi.baidu.com/oauth/2.0/token?grant_type=authorization_code&amp;code=&#123;CODE&#125;&amp;client_id=&#123;CLIENT_ID&#125;&amp;client_secret=&#123;CLIENT_SECRET&#125;&amp;redirect_uri=oob</span></span><br><span class="line"><span class="string">      其中 `&#123;CLIENT_ID&#125;`填写您的API Key</span></span><br><span class="line"><span class="string">          `&#123;CLIENT_SECRET&#125;`填写您的Secret Key</span></span><br><span class="line"><span class="string">          `&#123;CODE&#125;`填写刚才拿到的CODE</span></span><br><span class="line"><span class="string">如果你对文档不清楚如何拿到 token 可以借助此项目接口</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">baidu_get_token</span>(<span class="params">API_Key, Secret_Key, CODE</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    获取百度token</span></span><br><span class="line"><span class="string">    :param API_Key: 百度账号API_Key</span></span><br><span class="line"><span class="string">    :param Secret_Key: 百度账号Secret_Key</span></span><br><span class="line"><span class="string">    :param CODE: 登录并访问 http://openapi.baidu.com/oauth/2.0/authorize?response_type=code&amp;client_id=&#123;你的API_Key&#125;&amp;redirect_uri=oob&amp;scope=basic&amp;display=popup</span></span><br><span class="line"><span class="string">    :return: &#123;&#x27;access_token&#x27;: access_token, &#x27;refresh_token&#x27;: refresh_token&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&quot;grant_type&quot;</span>: <span class="string">&quot;authorization_code&quot;</span>,</span><br><span class="line">        <span class="string">&quot;redirect_uri&quot;</span>: <span class="string">&quot;oob&quot;</span>,</span><br><span class="line">        <span class="string">&quot;code&quot;</span>: <span class="string">f&#x27;<span class="subst">&#123;CODE&#125;</span>&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;client_id&quot;</span>: <span class="string">f&#x27;<span class="subst">&#123;API_Key&#125;</span>&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;client_secret&quot;</span>: <span class="string">f&#x27;<span class="subst">&#123;Secret_Key&#125;</span>&#x27;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post ( <span class="string">&#x27;http://openapi.baidu.com/oauth/2.0/token&#x27;</span>, params=payload )</span><br><span class="line">    getData = r.json ()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        access_token = getData[ <span class="string">&#x27;access_token&#x27;</span> ]  <span class="comment"># 有效期一个月</span></span><br><span class="line">        refresh_token = getData[ <span class="string">&#x27;refresh_token&#x27;</span> ]  <span class="comment"># 有效期十年</span></span><br><span class="line">        <span class="built_in">print</span> ( <span class="string">&#x27;Acess_Token：&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> + access_token )</span><br><span class="line">        <span class="built_in">print</span> ( <span class="string">&#x27;Refresh_Token：&#x27;</span> + <span class="string">&#x27;\n&#x27;</span> + refresh_token )</span><br><span class="line">        token = &#123;<span class="string">&#x27;access_token&#x27;</span>: access_token, <span class="string">&#x27;refresh_token&#x27;</span>: refresh_token&#125;</span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        e = <span class="built_in">str</span> ( e )</span><br><span class="line">        e = e + <span class="string">&#x27;获取失败，请保证code有效（十分钟有效期且仅能使用一次）&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">baidu_refresh_token</span>(<span class="params">API_Key, Secret_Key, refresh_token</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    通过 refresh_token 刷新</span></span><br><span class="line"><span class="string">    :param API_Key: 百度账号API_Key</span></span><br><span class="line"><span class="string">    :param Secret_Key: 百度账号Secret_Key</span></span><br><span class="line"><span class="string">    :param refresh_token: 百度账号refresh_token</span></span><br><span class="line"><span class="string">    :return: &#123;&#x27;access_token&#x27;: access_token, &#x27;refresh_token&#x27;: refresh_token&#125;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload = &#123;<span class="string">&#x27;grant_type&#x27;</span>: <span class="string">&#x27;refresh_token&#x27;</span>,</span><br><span class="line">               <span class="string">&#x27;refresh_token&#x27;</span>: refresh_token,</span><br><span class="line">               <span class="string">&#x27;client_id&#x27;</span>: API_Key,</span><br><span class="line">               <span class="string">&#x27;client_secret&#x27;</span>: Secret_Key</span><br><span class="line">               &#125;</span><br><span class="line">    r = requests.post ( <span class="string">&#x27;http://openapi.baidu.com/oauth/2.0/token&#x27;</span>, params=payload )</span><br><span class="line">    token = r.json ()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        access_token = token[ <span class="string">&#x27;access_token&#x27;</span> ]  <span class="comment"># 有效期一个月</span></span><br><span class="line">        refresh_token = token[ <span class="string">&#x27;refresh_token&#x27;</span> ]  <span class="comment"># 有效期十年</span></span><br><span class="line">        <span class="built_in">print</span> ( <span class="string">&quot;Token更新\nAcess_Token = &quot;</span> + access_token + <span class="string">&quot;\nRefresh_Token = &quot;</span> + refresh_token )</span><br><span class="line">        token = &#123;<span class="string">&#x27;access_token&#x27;</span>: access_token, <span class="string">&#x27;refresh_token&#x27;</span>: refresh_token&#125;</span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        e = <span class="built_in">str</span> ( e )</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;错误信息：刷新后无&#x27;</span> + e + <span class="string">&#x27;值 ， 请检查 refresh_token 是否填写正确&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getSiteList</span>(<span class="params">access_token, domain</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    请求获取百度账号下所有的站点列表并处理得到自己博客的 site_id</span></span><br><span class="line"><span class="string">    :param access_token: 百度分析access_token</span></span><br><span class="line"><span class="string">    :param domain: 站点域名</span></span><br><span class="line"><span class="string">    :return: 构造 site_info 字典作为其它请求的 params</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    payload = &#123;<span class="string">&#x27;access_token&#x27;</span>: access_token&#125;</span><br><span class="line">    r = requests.post ( <span class="string">&#x27;https://openapi.baidu.com/rest/2.0/tongji/config/getSiteList&#x27;</span>, params=payload )</span><br><span class="line">    get_data = r.json ()</span><br><span class="line">    <span class="comment"># 多个站点会返回多个 域名 和 id</span></span><br><span class="line">    <span class="comment"># 成功示例：&#123;&#x27;list&#x27;: [&#123;&#x27;site_id&#x27;: 17960579, &#x27;domain&#x27;: &#x27;zhsher.cn&#x27;, &#x27;status&#x27;: 0, &#x27;create_time&#x27;: &#x27;2022-05-12 15:20:32&#x27;, &#x27;sub_dir_list&#x27;: []&#125;]&#125;</span></span><br><span class="line">    <span class="comment"># 失败示例：&#123;&#x27;error_code&#x27;: 110, &#x27;error_msg&#x27;: &#x27;Access token invalid or no longer valid&#x27;&#125;</span></span><br><span class="line">    <span class="comment"># 利用 dic 对站点提取必要的 payload</span></span><br><span class="line">    getData = get_data[ <span class="string">&#x27;list&#x27;</span> ]</span><br><span class="line">    now = datetime.datetime.now ().date ()</span><br><span class="line">    now = datetime.datetime.strftime ( now, <span class="string">&#x27;%Y%m%d&#x27;</span> )  <span class="comment"># 纯字符串格式</span></span><br><span class="line">    site_info = &#123;&#125;  <span class="comment"># 定义一个字典，作为 post 请求的 payload</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> getData:</span><br><span class="line">        <span class="keyword">if</span> i[ <span class="string">&#x27;domain&#x27;</span> ].__eq__ ( domain ):</span><br><span class="line">            site_info[ <span class="string">&#x27;site_id&#x27;</span> ] = i[ <span class="string">&#x27;site_id&#x27;</span> ]</span><br><span class="line">            site_info[ <span class="string">&#x27;domain&#x27;</span> ] = i[ <span class="string">&#x27;domain&#x27;</span> ]</span><br><span class="line">            site_info[ <span class="string">&#x27;status&#x27;</span> ] = i[ <span class="string">&#x27;status&#x27;</span> ]</span><br><span class="line">            site_info[ <span class="string">&#x27;start_date&#x27;</span> ] = i[ <span class="string">&#x27;create_time&#x27;</span> ]</span><br><span class="line">            site_info[ <span class="string">&#x27;end_date&#x27;</span> ] = now</span><br><span class="line">    <span class="keyword">return</span> site_info</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_hot_article</span>(<span class="params">access_token, domain</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    获取热文统计</span></span><br><span class="line"><span class="string">    :param access_token: 百度分析access_token</span></span><br><span class="line"><span class="string">    :param domain: 站点域名</span></span><br><span class="line"><span class="string">    :return: 以pv排序返回文章标题、链接、pv、uv、平均时长</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    site_info = getSiteList ( access_token, domain )  <span class="comment"># 站点基础数据</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&#x27;access_token&#x27;</span>: access_token,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span>: <span class="string">&#x27;visit/toppage/a&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;metrics&quot;</span>: <span class="string">&quot;pv_count,visitor_count,average_stay_time&quot;</span>,  <span class="comment"># 浏览量 访客数 平均访问时长s</span></span><br><span class="line">    &#125;</span><br><span class="line">    payload.update ( site_info )</span><br><span class="line">    r = requests.post ( <span class="string">&#x27;https://openapi.baidu.com/rest/2.0/tongji/report/getData&#x27;</span>, params=payload )</span><br><span class="line">    get_site_data = r.json ()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 对 get_site_data 二次处理，去除主页、友链朋友圈、关于等信息，只保留 post 文章页信息</span></span><br><span class="line">    <span class="comment"># 并构造一个字典 get_hot_article 包括 概览信息blog_general 每篇文章信息article_info</span></span><br><span class="line">    <span class="comment"># 文章概览信息</span></span><br><span class="line">    blog_general = &#123;<span class="string">&quot;timeSpan&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;timeSpan&#x27;</span> ][ <span class="number">0</span> ],  <span class="comment"># 统计时间区间 eg：2022/05/12 - 2022/11/17</span></span><br><span class="line">                    <span class="string">&quot;total&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;total&#x27;</span> ],  <span class="comment"># 百度统计控制台-受访页面中URL个数 但只有前20篇具体数据，需要购买商业版统计</span></span><br><span class="line">                    <span class="string">&quot;sum_pv_count&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;sum&#x27;</span> ][ <span class="number">0</span> ][ <span class="number">0</span> ],  <span class="comment"># 总浏览量 PV</span></span><br><span class="line">                    <span class="string">&quot;sum_visitor_count&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;sum&#x27;</span> ][ <span class="number">0</span> ][ <span class="number">1</span> ],  <span class="comment"># 总访客数 UV</span></span><br><span class="line">                    <span class="string">&quot;sum_average_stay_time&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;sum&#x27;</span> ][ <span class="number">0</span> ][ <span class="number">2</span> ],  <span class="comment"># 总平均停留时长 单位 s</span></span><br><span class="line">                    <span class="string">&quot;top20_pv_count&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;pageSum&#x27;</span> ][ <span class="number">0</span> ][ <span class="number">0</span> ],  <span class="comment"># 前20篇的总浏览量 PV</span></span><br><span class="line">                    <span class="string">&quot;top20_visitor_count&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;pageSum&#x27;</span> ][ <span class="number">0</span> ][ <span class="number">1</span> ],  <span class="comment"># 前20篇的总访客数 UV</span></span><br><span class="line">                    <span class="string">&quot;top20_average_stay_time&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;pageSum&#x27;</span> ][ <span class="number">0</span> ][ <span class="number">2</span> ],  <span class="comment"># 前20篇的平均访问时长</span></span><br><span class="line">                    <span class="comment"># 前20篇的总平均停留时长 单位 s</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">    post_num = <span class="built_in">len</span> ( get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ] )  <span class="comment"># 避免有的人文章少超出索引</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 去除主页、友链朋友圈、关于等信息，只保留 post 文章页信息</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="number">0</span>, post_num ):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> re.<span class="keyword">match</span> ( <span class="string">r&#x27;^https://&#x27;</span> + site_info[ <span class="string">&#x27;domain&#x27;</span> ] + <span class="string">&#x27;/post/*&#x27;</span>,</span><br><span class="line">                          get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ][ i - index ][ <span class="number">0</span> ][ <span class="string">&#x27;name&#x27;</span> ] ):</span><br><span class="line">            <span class="keyword">del</span> get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ][ i - index ]</span><br><span class="line">            <span class="keyword">del</span> get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">1</span> ][ i - index ]</span><br><span class="line">            index = index + <span class="number">1</span></span><br><span class="line">    post_num = <span class="built_in">len</span> ( get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ] )  <span class="comment"># 去除处理后更新</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 单篇文章信息 百度统计没title：利用 xpath 爬取博客获取文章标题</span></span><br><span class="line">    article_info = [ ]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="number">0</span>, post_num ):</span><br><span class="line">        tmp = &#123;<span class="string">&quot;title&quot;</span>: get_title ( get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ][ i ][ <span class="number">0</span> ][ <span class="string">&#x27;name&#x27;</span> ] ),</span><br><span class="line">               <span class="string">&quot;url&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ][ i ][ <span class="number">0</span> ][ <span class="string">&#x27;name&#x27;</span> ],  <span class="comment"># 文章链接</span></span><br><span class="line">               <span class="string">&quot;pv_count&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">1</span> ][ i ][ <span class="number">0</span> ],  <span class="comment"># 浏览量PV</span></span><br><span class="line">               <span class="string">&quot;visitor_count&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">1</span> ][ i ][ <span class="number">1</span> ],  <span class="comment"># 访客数UV</span></span><br><span class="line">               <span class="string">&quot;average_stay_time&quot;</span>: get_site_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">1</span> ][ i ][ <span class="number">2</span> ]  <span class="comment"># 平均停留时长</span></span><br><span class="line">               &#125;</span><br><span class="line">        article_info.append ( tmp )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 构造新字典并return</span></span><br><span class="line">    get_hot_article = &#123;<span class="string">&quot;blog_general&quot;</span>: blog_general, <span class="string">&quot;article_info&quot;</span>: article_info&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwd = os.getcwd ()</span></span><br><span class="line">    <span class="comment"># father_path_method1 = os.path.dirname ( pwd )</span></span><br><span class="line">    <span class="comment"># file_path = father_path_method1 + &quot;\\baidu.json&quot;</span></span><br><span class="line">    <span class="comment"># with open ( file_path, &#x27;w&#x27;, encoding=&#x27;utf-8&#x27; ) as f:</span></span><br><span class="line">    <span class="comment">#     json.dump ( get_post_data, f, indent=4, ensure_ascii=False )</span></span><br><span class="line">    <span class="keyword">return</span> get_hot_article</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_title</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    补充百度分析不显示标题</span></span><br><span class="line"><span class="string">    :param url: 文章链接</span></span><br><span class="line"><span class="string">    :return: 文章标题</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    r = requests.get ( url )</span><br><span class="line">    r = r.content.decode ( <span class="string">&#x27;utf-8&#x27;</span> )</span><br><span class="line">    html = etree.HTML ( r )</span><br><span class="line">    title = html.xpath ( <span class="string">&#x27;//*[@id=&quot;post-info&quot;]/h1//text()&#x27;</span> )[ <span class="number">0</span> ]</span><br><span class="line">    <span class="keyword">return</span> title</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_visitor_province</span>(<span class="params">access_token, domain</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    访客省份统计</span></span><br><span class="line"><span class="string">    :param access_token: 百度分析access_token</span></span><br><span class="line"><span class="string">    :param domain: 站点域名</span></span><br><span class="line"><span class="string">    :return: 省份UV</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    site_info = getSiteList ( access_token, domain )  <span class="comment"># 站点基础数据</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&#x27;access_token&#x27;</span>: access_token,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span>: <span class="string">&#x27;overview/getDistrictRpt&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;metrics&quot;</span>: <span class="string">&quot;pv_count&quot;</span>,  <span class="comment"># 获取pv_count或visitor_count</span></span><br><span class="line">    &#125;</span><br><span class="line">    payload.update ( site_info )</span><br><span class="line">    r = requests.post ( <span class="string">&#x27;https://openapi.baidu.com/rest/2.0/tongji/report/getData&#x27;</span>, params=payload )</span><br><span class="line">    get_data = r.json ()</span><br><span class="line">    get_visitor_province = [ ]</span><br><span class="line">    num = <span class="built_in">len</span> ( get_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ] )</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="number">0</span>, num ):</span><br><span class="line">        <span class="comment"># get_data[ &#x27;result&#x27; ][ &#x27;items&#x27; ][ 1 ][ i ][ 0 ] # PV</span></span><br><span class="line">        tmp = &#123;<span class="string">&#x27;name&#x27;</span>: get_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ][ i ][ <span class="number">0</span> ],</span><br><span class="line">               <span class="string">&#x27;value&#x27;</span>: get_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">1</span> ][ i ][ <span class="number">0</span> ]&#125;</span><br><span class="line">        get_visitor_province.append ( tmp )</span><br><span class="line">    <span class="keyword">return</span> get_visitor_province</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_visitor_counrty</span>(<span class="params">access_token, domain</span>):</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    访客国家统计</span></span><br><span class="line"><span class="string">    :param access_token: 百度分析access_token</span></span><br><span class="line"><span class="string">    :param domain: 站点域名</span></span><br><span class="line"><span class="string">    :return: 国家UV</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    site_info = getSiteList ( access_token, domain )  <span class="comment"># 站点基础数据</span></span><br><span class="line">    payload = &#123;</span><br><span class="line">        <span class="string">&#x27;access_token&#x27;</span>: access_token,</span><br><span class="line">        <span class="string">&#x27;method&#x27;</span>: <span class="string">&#x27;visit/world/a&#x27;</span>,</span><br><span class="line">        <span class="string">&quot;metrics&quot;</span>: <span class="string">&quot;pv_count,visitor_count,average_stay_time&quot;</span>,  <span class="comment"># 浏览量 访客数 平均访问时长s</span></span><br><span class="line">    &#125;</span><br><span class="line">    payload.update ( site_info )</span><br><span class="line">    r = requests.post ( <span class="string">&#x27;https://openapi.baidu.com/rest/2.0/tongji/report/getData&#x27;</span>, params=payload )</span><br><span class="line">    get_data = r.json ()</span><br><span class="line">    get_visitor_country = [ ]</span><br><span class="line">    num = <span class="built_in">len</span> ( get_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ] )</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="number">0</span>, num ):</span><br><span class="line">        <span class="comment"># get_data[ &#x27;result&#x27; ][ &#x27;items&#x27; ][ 0 ] # 国家</span></span><br><span class="line">        <span class="comment"># get_data[ &#x27;result&#x27; ][ &#x27;items&#x27; ][ 1 ][ i ][ 0 ] # PV</span></span><br><span class="line">        <span class="comment"># get_data[ &#x27;result&#x27; ][ &#x27;items&#x27; ][ 1 ][ i ][ 1 ] # UV</span></span><br><span class="line">        tmp = &#123;<span class="string">&#x27;name&#x27;</span>: get_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">0</span> ][ i ][ <span class="number">0</span> ][ <span class="string">&#x27;name&#x27;</span> ],</span><br><span class="line">               <span class="string">&#x27;value&#x27;</span>: get_data[ <span class="string">&#x27;result&#x27;</span> ][ <span class="string">&#x27;items&#x27;</span> ][ <span class="number">1</span> ][ i ][ <span class="number">0</span> ]&#125;</span><br><span class="line">        get_visitor_country.append ( tmp )</span><br><span class="line">    <span class="keyword">return</span> get_visitor_country</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    API_Key = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    Secret_Key = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    CODE = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    refresh_token = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 测试</span></span><br><span class="line">    <span class="comment"># print ( baidu_get_token ( API_Key, Secret_Key, CODE ) )</span></span><br><span class="line">    <span class="comment"># print ( baidu_refresh_token ( API_Key, Secret_Key, refresh_token ) )</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># access_token = &#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># domain = &#x27;zhsher.cn&#x27;</span></span><br><span class="line">    <span class="comment"># print ( get_hot_article ( access_token, domain ) )</span></span><br><span class="line">    <span class="comment"># print ( get_visitor_province ( access_token, domain ) )</span></span><br><span class="line">    <span class="comment"># print ( get_visitor_counrty ( access_token, domain ) )</span></span><br></pre></td></tr></table></figure><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>感谢以下hexo框架的好友，为我提供了各种测试数据😁</p><ul><li><a href="https://blog.leonus.cn/">Leonus - 进一寸有进一寸的欢喜</a></li><li><a href="https://blog.panghai.top/">心流 - 保持谨慎，保持乐观</a></li><li><a href="https://www.chuckle.top/">轻笑Chuckle</a></li><li><a href="https://anzhiy.cn/">安知鱼 - 生活明朗 万物可爱</a></li><li><a href="https://luomengguo.top/">懒代王 - 梦想起源,追逐梦想 </a></li></ul><p>这次爬虫得到了不少实践及代码分析思维</p><ol><li>selenium库主要用来网页自动化操作对爬取并不友好（居然还可以执行js操作，好用！）</li><li>etree库需要将html转为etree对象，之后通过xpath解析，etree对象不能直接打印输出html文本</li><li>最强的parsel库yyds！！！不仅支持众多CSS选择器，支持xpath解析，还可以直接输出html文本，对有一定CSS前端基础的人极易上手</li></ol>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/Hexo/">Hexo</category>
      
      
      <category domain="https://zhsher.cn/tags/Hexo/">Hexo</category>
      
      
      <comments>https://zhsher.cn/posts/980/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>2022 11 13 月亮还是那个月亮</title>
      <link>https://zhsher.cn/posts/53805/</link>
      <guid>https://zhsher.cn/posts/53805/</guid>
      <pubDate>Sat, 12 Nov 2022 16:10:24 GMT</pubDate>
      
        
        
      <description>&lt;div class=&quot;aplayer&quot; data-id=&quot;481535277&quot; data-server=&quot;netease&quot; data-type=&quot;song&quot; data-mutex=&quot;true&quot; data-preload=&quot;auto&quot; data-theme=&quot;#3F51B5&quot;&gt;&lt;</description>
        
      
      
      
      <content:encoded><![CDATA[<div class="aplayer" data-id="481535277" data-server="netease" data-type="song" data-mutex="true" data-preload="auto" data-theme="#3F51B5"></div><p>今天是2022年11月13日，也是我被封在学校的75天，晚上看着一栋栋冰冷的建筑，空气散发着雨后特有的泥土气息，月亮还是那个月亮但月亮下的世界不是从前的那个世界</p><p>这也是疫情的第三年，去年因为有同学抗议所以解封了，但相比去年的烦躁，大家更多了些坦然，对解封也没有太多期望，每天过着重复的生活，吃着重复的饭菜，扣不完的1，打不完的卡，还有捅不完的核酸，心如止水，没一点波澜，但每每晚上，总觉得我的大学生活不该如此，但也只能如此</p><p>马上就要雪季了，如果没有疫情的话，可以和舍友一起吃火锅、撸串，可以争辩中午什么好吃，可以在操场谈天说地，听各种奇思妙想，在周末可以去滑雪，去骑行，去抓住冬天的雪花，看似简单的日常如今被冰冷的围墙阻挡</p><p>前段时间和朋友聊了好多，回忆这三年的零零碎碎，下课后和三五好友去市中心压马路，一到周末就去看电影、吃饭喝酒吹牛逼，也可以说走就走在太阳晒屁股的时候，决定起床租车自驾去平遥…好多都历历在目，但如今简单的生活变得多么奢望，看着剩下不多的大学时光，思绪万千</p><p>太原的疫情就像是修不完的bug，总在清零的时候出现下一个bug，希望瞬间又化为了灰烬，又能怎么样？有心无力！宿舍一股臭味，找了好久找不到哪里发出来的，原来是腐烂的理想，我真的好想，好想回到过去</p><p>好在平淡的疫情总会有些小美好，解决一个棘手的bug、利用所长帮别人解决问题、疲惫的一天结束后突然收到奖学金，小梁的礼物、蛋糕更是为这杯苦咖中放了一大块糖！…也认识了好多朋友，<a href="https://thiscute.world/">@二花</a>、<a href="https://blog.panghai.top/">@心流</a>、<a href="https://www.luomengguo.top/">@洛梦国</a>…请教学习亦或是远程帮忙又或者闲聊，也夹杂了一些农夫与蛇，好在收获波多，<a href="https://akilar.top/">@Akilar</a>说『放下助人情节，尊重他人命运』，15届的老学长说『疫情之下，别人能做到你也能做到，不要抱怨』，一位老班长说『闭上那怨天尤人的嘴，咬紧那满是奋斗的牙』…没错，疫情下，你我与共，山巅自相逢！</p><p>地球又转到了月亮第一次照到我的地方，我对月亮许愿希望我们永远快乐，疫情消散，真诚的！</p><p>月亮下的世界不是从前的那个世界，但我们越来越好！</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E6%97%A5%E8%AE%B0/%E6%97%A5%E8%AE%B020.png" alt="日记20"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E6%97%A5%E8%AE%B0/%E6%97%A5%E8%AE%B021.png" alt="日记21"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E6%97%A5%E8%AE%B0/%E6%97%A5%E8%AE%B022.png" alt="日记22"></p><blockquote><p>索尼大法真的强👍</p></blockquote>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/%E5%B0%8F%E5%BC%A0%E5%88%97%E4%BC%A0/">小张列传</category>
      
      
      <category domain="https://zhsher.cn/tags/%E5%B0%8F%E5%BC%A0%E5%88%97%E4%BC%A0/">小张列传</category>
      
      
      <comments>https://zhsher.cn/posts/53805/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Github Actions—解放双手</title>
      <link>https://zhsher.cn/posts/7339/</link>
      <guid>https://zhsher.cn/posts/7339/</guid>
      <pubDate>Wed, 09 Nov 2022 14:26:58 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;一、前置知识&quot;&gt;&lt;a href=&quot;#一、前置知识&quot; class=&quot;headerlink&quot; title=&quot;一、前置知识&quot;&gt;&lt;/a&gt;一、前置知识&lt;/h2&gt;&lt;p&gt;CI\CD 即：持续集成（&lt;code&gt;Continuous Integration&lt;/code&gt;）、持续交付</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="一、前置知识"><a href="#一、前置知识" class="headerlink" title="一、前置知识"></a>一、前置知识</h2><p>CI\CD 即：持续集成（<code>Continuous Integration</code>）、持续交付（<code>Continuous Delivery</code>）、持续部署（<code>Continuous Deployment</code>）。GitHub Actions 是一个持续集成和持续交付 (CI&#x2F;CD) 平台，可用于自动执行构建、测试和部署管道。</p><p>最近几个月拿Github Actions写了一些CI\CD，是看别人怎么写然后边学边敲得，比如定时执行脚本、自动化博客部署、打包pip、npm等等，自动化以后甚是好用<del>（主要是懒）</del>！故翻文档整理一则入门笔记，本以为我<del>精通</del>了，一翻文档翻出了一堆，写成了进阶，主要是<code>jobs</code>😭文档中分好细，实际生产工作中并没用到太多，感觉比较偏，剩下的<code>on、evn、secret</code>都是高频且只要有一定的git基础很容易搞懂并上手，但如果你是新手文档会显得晦涩，推荐两篇快速入门：</p><ul><li><p><a href="https://blog.csdn.net/Ber_Bai/article/details/120310024">最全总结，GitHub Action自动化部署</a></p></li><li><p><a href="https://blog.csdn.net/unreliable_narrator/article/details/124468384">GitHubActions详解</a></p></li></ul><p>在阅读以前应该有一些基础：git常识，yml文件书写规范，善于查阅文档</p><p>参考文档：<a href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions">Workflow syntax for GitHub Actions - GitHub Docs</a></p><h2 id="二、文件结构"><a href="#二、文件结构" class="headerlink" title="二、文件结构"></a>二、文件结构</h2><p>Github项目路径下创建<code>.github/workflows/xxx.yml</code>，每一个<code>.yml</code>文件对应一个<strong>workflows</strong></p><p>基本概念：</p><ul><li><p>workflow（流程）：持续集成一次运行的过程，就是一个 workflow</p></li><li><p>jobs（任务）：一个 workflow 由一个或多个 jobs 构成，含义是一次持续集成的运行，可以完成多个任务</p></li><li><p>step（步骤）：每个 job 由多个 step 构成，一步步完成</p></li><li><p>action（动作）：每个 step 可以依次执行一个或多个命令</p></li></ul><h3 id="name"><a href="#name" class="headerlink" title="name"></a>name</h3><p>工作流名称，留空为文件名</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">hello-github-actions</span></span><br></pre></td></tr></table></figure><h3 id="on"><a href="#on" class="headerlink" title="on"></a>on</h3><p>触发的条件：<a href="https://docs.github.com/cn/actions/using-workflows/events-that-trigger-workflows">Events that trigger workflows - GitHub Docs</a></p><h4 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># push时触发</span></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 数组表示，push、fork时触发</span></span><br><span class="line"><span class="attr">on:</span> [<span class="string">push</span>, <span class="string">fork</span>]</span><br></pre></td></tr></table></figure><p>对事件细分，又可以增加<strong>事件活动类型（<code>types</code>）和筛选器（<code>branches</code>、<code>tags</code>、<code>paths</code>）</strong>规定事件的触发条件</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="string">事件:</span></span><br><span class="line">    <span class="string">活动类型\筛选器:</span></span><br><span class="line">       <span class="string">条件</span>  </span><br></pre></td></tr></table></figure><h4 id="types"><a href="#types" class="headerlink" title="types"></a>types</h4><p>语法：<code>on.&lt;event_name&gt;.types</code>，定义<strong>事件活动类型</strong></p><p>issues时，触发条件</p><ul><li>创建issues</li><li>为issues做标签</li></ul><p>当创建一个带两个标签的issues，则触发三个工作流</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">issues:</span></span><br><span class="line">    <span class="attr">types:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">opened</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">labeled</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 可以表示为数组</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">issues:</span></span><br><span class="line">    <span class="attr">types:</span> [<span class="string">opened</span>,<span class="string">labeled</span>]</span><br></pre></td></tr></table></figure><h4 id="『pull-request』：branches-branches-ignore"><a href="#『pull-request』：branches-branches-ignore" class="headerlink" title="『pull_request』：branches &amp; branches-ignore"></a>『pull_request』：branches &amp; branches-ignore</h4><p>语法：<code>on.&lt;pull_request|pull_request_target&gt;.&lt;branches|branches-ignore&gt;</code></p><p>如果同时定义 <code>branches</code>&#x2F;<code>branches-ignore</code> 筛选器和 <code>paths</code>筛选器，则工作流将只在这<strong>两个筛选器都满足条件时运行</strong></p><p><code>branches</code>与<code>branches-ignore</code>不能同时使用，可以使用<code>!</code>排除分支，当<code>branches</code>中使用<code>!</code>需要至少定义一个不带<code>!</code>的分支，支持glob模式（一种正则表达）</p><p>pull_request时，触发条件</p><ul><li><code>releases/开头</code>分支</li><li><code>releases/开头-alpha结尾</code>分支</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;releases/**&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;!releases/**-alpha&#x27;</span></span><br></pre></td></tr></table></figure><p>pull_request时触发，但不包括</p><ul><li><code>main</code>分支</li><li><code>releases/开头-alpha结尾</code>分支</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="comment"># Sequence of patterns matched against refs/heads</span></span><br><span class="line">    <span class="attr">branches-ignore:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;main&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;releases/**-alpha&#x27;</span></span><br></pre></td></tr></table></figure><p>pull_request时，触发条件</p><ul><li><code>releases/开头</code>分支</li><li>但不包括<code>releases/开头-alpha结尾</code>分支</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">pull_request:</span></span><br><span class="line">    <span class="attr">branches:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;releases/**&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;!releases/**-alpha&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="『push』：branches-tags-branches-ignore-tags-ignore"><a href="#『push』：branches-tags-branches-ignore-tags-ignore" class="headerlink" title="『push』：branches &amp; tags &amp; branches-ignore &amp; tags-ignore"></a>『push』：branches &amp; tags &amp; branches-ignore &amp; tags-ignore</h4><p>语法：<code>on.push.&lt;branches|tags|branches-ignore|tags-ignore&gt;</code></p><p>如果仅定义 <code>tags</code>&#x2F;<code>tags-ignore</code> 或 <code>branches</code>&#x2F;<code>branches-ignore</code>，则工作流不会针对影响未定义的 Git ref 的事件运行。如果两者 <code>tags</code>&#x2F;<code>tags-ignore</code> 或 <code>branches</code>&#x2F;<code>branches-ignore</code> 均未定义，则工作流将针对影响<strong>分支或标记</strong>的事件运行。 如果你同时定义 <code>branches</code>&#x2F;<code>branches-ignore</code> 筛选器和 <a href="https://docs.github.com/cn/actions/using-workflows/workflow-syntax-for-github-actions#onpushpull_requestpull_request_targetpathspaths-ignore"><code>paths</code></a> 筛选器，则工作流将只在这<strong>两个筛选器都满足条件时运行</strong></p><p><code>branches</code>与<code>branches-ignore</code>不能同时使用， <code>tags</code> 与 <code>tags-ignore</code> 不能同时使用，可以使用<code>!</code>排除分支|标签，当<code>branches|tags</code>中使用<code>!</code>需要至少定义一个不带<code>!</code>的分支，支持glob模式（一种正则表达）</p><p>push时，触发条件</p><ul><li><code>main</code>分支</li><li><code>releases/</code>开头分支</li><li><code>v2</code>标签</li><li><code>v1.</code>开头的标签</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="comment"># Sequence of patterns matched against refs/heads</span></span><br><span class="line">    <span class="attr">branches:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;releases/**&#x27;</span></span><br><span class="line">    <span class="comment"># Sequence of patterns matched against refs/tags</span></span><br><span class="line">    <span class="attr">tags:</span>        </span><br><span class="line">      <span class="bullet">-</span> <span class="string">v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">v1.*</span></span><br></pre></td></tr></table></figure><p>push时触发，但不包括</p><ul><li><code>main</code>分支</li><li><code>releases/开头</code>分支</li><li><code>v2</code>标签</li><li><code>v1.</code>开头的标签</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="comment"># Sequence of patterns matched against refs/heads</span></span><br><span class="line">    <span class="attr">branches-ignore:</span>    </span><br><span class="line">      <span class="bullet">-</span> <span class="string">main</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;releases/**&#x27;</span></span><br><span class="line">    <span class="comment"># Sequence of patterns matched against refs/tags</span></span><br><span class="line">    <span class="attr">tags-ignore:</span>        </span><br><span class="line">      <span class="bullet">-</span> <span class="string">v2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">v1.*</span></span><br></pre></td></tr></table></figure><p>push时，触发条件</p><ul><li><code>releases/开头</code>的分支</li><li>但不包括<code>releases/开头-alpha结尾</code>的分支</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;releases/**&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;!releases/**-alpha&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="『push-pull-request』：paths-paths-ignore"><a href="#『push-pull-request』：paths-paths-ignore" class="headerlink" title="『push &amp; pull_request』：paths &amp; paths-ignore"></a>『push &amp; pull_request』：paths &amp; paths-ignore</h4><p>语法：<code>on.&lt;push|pull_request|pull_request_target&gt;.&lt;paths|paths-ignore&gt;</code></p><p>如果同时定义 <code>branches</code>&#x2F;<code>branches-ignore</code> 筛选器和 <code>paths</code> 筛选器，则工作流将只在这<strong>两个筛选器都满足条件时运行</strong></p><p><code>paths</code> 与 <code>paths-ignore</code> 不能同时使用，可以使用<code>!</code>排除标签，当<code>paths</code>中使用<code>!</code>需要至少定义一个不带<code>!</code>的路径，支持glob模式（一种正则表达）</p><p>push时，触发条件</p><ul><li>包含<code>.js</code>文件名</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;**.js&#x27;</span></span><br></pre></td></tr></table></figure><p>push时触发，但不包括</p><ul><li><code>docs</code>目录下</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">paths-ignore:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;docs/**&#x27;</span></span><br></pre></td></tr></table></figure><p>push时，触发条件</p><ul><li><code>sub-project</code>目录下，但不包括<code>sub-project/docs</code></li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;sub-project/**&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;!sub-project/docs/**&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="schedule"><a href="#schedule" class="headerlink" title="schedule"></a>schedule</h4><p>定时<code>cron</code>，推荐在线验证网站：<a href="https://crontab.guru/">Crontab.guru - The cron schedule expression editor</a></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">schedule:</span></span><br><span class="line">    <span class="comment"># At 05:30 on Monday and Wednesday</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&#x27;30 5 * * 1,3&#x27;</span></span><br><span class="line"><span class="comment"># At 05:30 on Tuesday and Thursday   </span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&#x27;30 5 * * 2,4&#x27;</span></span><br></pre></td></tr></table></figure><h4 id="workflow"><a href="#workflow" class="headerlink" title="workflow"></a>workflow</h4><p>语法：<code>on.workflow_call</code>，调用其它工作流，但这部分没理解，也从未见过示例，先留个坑</p><p>语法：<code>on.workflow_run.&lt;branches|branches-ignore&gt;</code>：指定运行分支</p><p>仅当名为 <code>Build</code> 的工作流在名称以 <code>releases/</code> 开头的分支上运行时，具有以下触发器的工作流才会运行</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_run:</span></span><br><span class="line">    <span class="attr">workflows:</span> [<span class="string">&quot;Build&quot;</span>]</span><br><span class="line">    <span class="attr">types:</span> [<span class="string">requested</span>]</span><br><span class="line">    <span class="attr">branches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;releases/**&#x27;</span></span><br></pre></td></tr></table></figure><p>仅当名为 <code>Build</code> 的工作流不在名为 <code>canary</code> 的分支上运行时，具有以下触发器的工作流才会运行</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_run:</span></span><br><span class="line">    <span class="attr">workflows:</span> [<span class="string">&quot;Build&quot;</span>]</span><br><span class="line">    <span class="attr">types:</span> [<span class="string">requested</span>]</span><br><span class="line">    <span class="attr">branches-ignore:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;canary&quot;</span></span><br></pre></td></tr></table></figure><p>语法：<code>on.workflow_dispatch</code>：手动触发</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br></pre></td></tr></table></figure><p>语法：<code>on.workflow_dispatch.inputs</code>：带表单的手动触发</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 格式</span></span><br><span class="line"><span class="attr">inputs:</span></span><br><span class="line">  <span class="string">变量名字:</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&#x27;Log level&#x27;</span><span class="comment"># 描述</span></span><br><span class="line">    <span class="attr">required:</span> <span class="literal">true</span><span class="comment"># 必填</span></span><br><span class="line">    <span class="attr">default:</span> <span class="string">&#x27;warning&#x27;</span> <span class="comment"># 默认值</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">choice</span><span class="comment"># type: choice 选项，string 字符串，number 数值，boolean 布尔值</span></span><br><span class="line">    <span class="attr">options:</span><span class="comment"># 选项</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">info</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">warning</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">debug</span> </span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">      <span class="attr">logLevel:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Log level&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">default:</span> <span class="string">&#x27;warning&#x27;</span> </span><br><span class="line">        <span class="attr">type:</span> <span class="string">choice</span></span><br><span class="line">        <span class="attr">options:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">info</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">warning</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">debug</span> </span><br><span class="line">      <span class="attr">print_tags:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;True to print to STDOUT&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span> </span><br><span class="line">        <span class="attr">type:</span> <span class="string">boolean</span> </span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&#x27;Test scenario tags&#x27;</span></span><br><span class="line">        <span class="attr">required:</span> <span class="literal">true</span> </span><br><span class="line">        <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">print-tag:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="comment"># 如果print_tags为true就执行</span></span><br><span class="line">    <span class="attr">if:</span>  <span class="string">$&#123;&#123;</span> <span class="string">inputs.print_tags</span> <span class="string">&#125;&#125;</span> </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">the</span> <span class="string">input</span> <span class="string">tag</span> <span class="string">to</span> <span class="string">STDOUT</span></span><br><span class="line">      <span class="comment"># 输出tags的值</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">echo</span>  <span class="string">The</span> <span class="string">tags</span> <span class="string">are</span> <span class="string">$&#123;&#123;</span> <span class="string">inputs.tags</span> <span class="string">&#125;&#125;</span> </span><br></pre></td></tr></table></figure><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://docs.github.com/assets/cb-93002/images/help/images/workflow-dispatch-inputs.png" alt="inputs"></p><h3 id="evn"><a href="#evn" class="headerlink" title="evn"></a>evn</h3><p>语法：<code>jobs.steps[*\].env</code>，读取环境变量，其中<code>GITHUB_TOKEN</code>是一个特殊的变量，并不需要在仓库下<strong>『Setting-&gt;Secrets-&gt;Actions』</strong>定义的一个变量，而是工作流运行时自动创建的临时TOKEN，不需要自己配置，源自：<a href="https://docs.github.com/en/actions/security-guides/automatic-token-authentication">Automatic token authentication - GitHub Docs</a></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">action</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">FIRST_NAME:</span> <span class="string">Mona</span></span><br><span class="line">      <span class="attr">LAST_NAME:</span> <span class="string">Octocat</span></span><br></pre></td></tr></table></figure><h3 id="jobs"><a href="#jobs" class="headerlink" title="jobs"></a>jobs</h3><p>jobs表示要执行的一项或多项任务。jobs可以包含一个或多个job，这个任务可以包含多个步骤(steps)</p><p>语法：</p><ul><li><code>jobs.&lt;job_id&gt;</code>：jobs的唯一标识符</li><li><code>jobs.&lt;job_id&gt;.name</code>：作业名称（如果留空，则为job_id）</li></ul><p><code>job_id</code> 值为 <code>my_first_job</code> 和 <code>my_second_job</code>。默认多个job是<strong>并发</strong>执行的</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">job</span></span><br><span class="line">  <span class="attr">my_second_job:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">My</span> <span class="string">second</span> <span class="string">job</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.needs</code>：等待前面的jobs<strong>成功完成</strong>才执行</p><p><code>job1</code> 必须在 <code>job2</code> 开始之前<strong>成功完成</strong>，并且 <code>job3</code> 等待 <code>job1</code> 和 <code>job2</code> 完成</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">job1:</span></span><br><span class="line">  <span class="attr">job2:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">job1</span></span><br><span class="line">  <span class="attr">job3:</span></span><br><span class="line">    <span class="attr">needs:</span> [<span class="string">job1</span>, <span class="string">job2</span>]</span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.if</code>：执行条件</p><p><code>job3</code> 使用 <code>always()</code> 条件表达式，确保始终在 <code>job1</code> 和 <code>job2</code> 完成（无论是否成功）后运行</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">job1:</span></span><br><span class="line">  <span class="attr">job2:</span></span><br><span class="line">    <span class="attr">needs:</span> <span class="string">job1</span></span><br><span class="line">  <span class="attr">job3:</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">always()</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">needs:</span> [<span class="string">job1</span>, <span class="string">job2</span>]</span><br></pre></td></tr></table></figure><p>语法：</p><ul><li><code>jobs.&lt;job_id&gt;.runs-on</code>：运行镜像，查表：<a href="https://docs.github.com/cn/actions/using-workflows/workflow-syntax-for-github-actions#choosing-github-hosted-runners">Workflow syntax for GitHub Actions - GitHub Docs</a></li><li><code>jobs.&lt;job_id&gt;.steps</code>：作业步骤，步骤中可以包括多个命令</li><li><code>jobs.&lt;job_id&gt;.steps[*].name</code>：步骤中又分小任务，每个任务的名称，将会展示在Actions</li><li><code>jobs.&lt;job_id&gt;.steps[*].run</code>：执行shell命令</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Greeting</span> <span class="string">from</span> <span class="string">Mona</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span> <span class="string">push</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my-job:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">My</span> <span class="string">Job</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Print</span> <span class="string">a</span> <span class="string">greeting</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">MY_VAR:</span> <span class="string">Hi</span> <span class="string">there!</span> <span class="string">My</span> <span class="string">name</span> <span class="string">is</span></span><br><span class="line">          <span class="attr">FIRST_NAME:</span> <span class="string">Mona</span></span><br><span class="line">          <span class="attr">MIDDLE_NAME:</span> <span class="string">The</span></span><br><span class="line">          <span class="attr">LAST_NAME:</span> <span class="string">Octocat</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          echo $MY_VAR $FIRST_NAME $MIDDLE_NAME $LAST_NAME.</span></span><br><span class="line"><span class="string"></span>      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">end</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">          <span class="string">echo</span> <span class="string">test</span> <span class="string">end</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.steps[*].if</code>：执行条件。if可取值：<a href="https://docs.github.com/cn/actions/learn-github-actions/expressions#status-check-functions">Expressions - GitHub Docs</a></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 仅当`pull_request`时且action为`unassigned`触发</span></span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">step</span></span><br><span class="line">   <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event_name</span> <span class="string">==</span> <span class="string">&#x27;pull_request&#x27;</span> <span class="string">&amp;&amp;</span> <span class="string">github.event.action</span> <span class="string">==</span> <span class="string">&#x27;unassigned&#x27;</span> <span class="string">&#125;&#125;</span></span><br><span class="line">   <span class="attr">run:</span> <span class="string">echo</span> <span class="string">This</span> <span class="string">event</span> <span class="string">is</span> <span class="string">a</span> <span class="string">pull</span> <span class="string">request</span> <span class="string">that</span> <span class="string">had</span> <span class="string">an</span> <span class="string">assignee</span> <span class="string">removed.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 仅当前一个任务失败，My backup step才执行</span></span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">step</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">octo-org/action-name@main</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">backup</span> <span class="string">step</span></span><br><span class="line">    <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">failure()</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">actions/heroku@1.0.0</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.steps[*].uses</code>：这个就很有意思了，可以减少我们重复造轮子，调用别人做好的Actions。可以在<a href="https://github.com/marketplace?type=actions">GitHub Marketplace · Actions </a>找到需要的轮子</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 指定uses的分支、版本</span></span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="comment"># Reference a specific commit</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@a81bbbf8298c0fa03ea29cdc473d45769f953675</span></span><br><span class="line">  <span class="comment"># Reference the major version of a release</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">  <span class="comment"># Reference a specific version</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v3.2.0</span></span><br><span class="line">  <span class="comment"># Reference a branch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@main</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用别人的公有仓库，&#123;owner&#125;/&#123;repo&#125;@&#123;ref&#125;</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">step</span></span><br><span class="line">        <span class="comment"># Uses the default branch of a public repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/heroku@main</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">second</span> <span class="string">step</span></span><br><span class="line">        <span class="comment"># Uses a specific version tag of a public repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/aws@v2.0.1</span></span><br><span class="line">        </span><br><span class="line"><span class="comment"># 调用仓库下特定路径，&#123;owner&#125;/&#123;repo&#125;/&#123;path&#125;@&#123;ref&#125;</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">step</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/aws/ec2@main</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用自己写的actions</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">out</span> <span class="string">repository</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Use</span> <span class="string">local</span> <span class="string">my-action</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">./.github/actions/my-action</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用docker docker://&#123;image&#125;:&#123;tag&#125;</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">step</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker://alpine:3.8</span></span><br><span class="line">       </span><br><span class="line"><span class="comment"># 指定docker地址 docker://&#123;host&#125;/&#123;image&#125;:&#123;tag&#125;</span></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">step</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">docker://ghcr.io/OWNER/IMAGE_NAME</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.steps[*].shell</code>：指定shell，默认bash</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Display</span> <span class="string">the</span> <span class="string">path</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">echo</span> <span class="string">$PATH</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">bash</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Display</span> <span class="string">the</span> <span class="string">path</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">echo</span> <span class="string">%PATH%</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">cmd</span></span><br><span class="line"></span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Display</span> <span class="string">the</span> <span class="string">path</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">echo</span> <span class="string">$&#123;env:PATH&#125;</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">powershell</span></span><br><span class="line"></span><br><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Display</span> <span class="string">the</span> <span class="string">path</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      import os</span></span><br><span class="line"><span class="string">      print(os.environ[&#x27;PATH&#x27;])</span></span><br><span class="line"><span class="string"></span>    <span class="attr">shell:</span> <span class="string">python</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.steps[*].with</code>：定义变量，可以被hello_world所访问</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">my_first_job:</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">step</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/hello_world@main</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">first_name:</span> <span class="string">Mona</span></span><br><span class="line">          <span class="attr">middle_name:</span> <span class="string">The</span></span><br><span class="line">          <span class="attr">last_name:</span> <span class="string">Octocat</span></span><br></pre></td></tr></table></figure><p>语法：</p><ul><li><code>jobs.&lt;job_id&gt;.steps[*].with.args</code>：文档解释『A <code>string</code> that defines the inputs for a Docker container. GitHub passes the <code>args</code> to the container’s <code>ENTRYPOINT</code> when the container starts up』，我的理解是给docker容器启动时传入参数？第二个坑</li><li><code>jobs.&lt;job_id&gt;.steps[*].with.entrypoint</code>：覆盖Dockerfile中的ENTRYPOINT</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Explain</span> <span class="string">why</span> <span class="string">this</span> <span class="string">job</span> <span class="string">ran</span></span><br><span class="line">    <span class="attr">uses:</span> <span class="string">octo-org/action-name@main</span></span><br><span class="line">    <span class="attr">with:</span></span><br><span class="line">      <span class="attr">entrypoint:</span> <span class="string">/bin/echo</span></span><br><span class="line">      <span class="attr">args:</span> <span class="string">The</span> <span class="string">$&#123;&#123;</span> <span class="string">github.event_name</span> <span class="string">&#125;&#125;</span> <span class="string">event</span> <span class="string">triggered</span> <span class="string">this</span> <span class="string">step.</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.steps[*].env</code>、<code>jobs.&lt;job_id&gt;.env</code>：传入变量</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">My</span> <span class="string">first</span> <span class="string">action</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">FIRST_NAME:</span> <span class="string">Mona</span></span><br><span class="line">      <span class="attr">LAST_NAME:</span> <span class="string">Octocat</span></span><br></pre></td></tr></table></figure><p>语法：</p><ul><li><code>jobs.&lt;job_id&gt;.steps[*].continue-on-error: true</code>：表示，此步运行失败时，工作流仍继续执行下一个任务</li><li><code>jobs.&lt;job_id&gt;.steps[*].timeout-minutes</code>：任务最大执行时间</li><li><code>jobs.&lt;job_id&gt;.timeout-minutes</code>：作业最大执行时间，默认360min</li><li><code>jobs.&lt;job_id&gt;.strategy.matrix</code>：使用矩阵策略</li></ul><p>可以使用矩阵策略，两个操作系统会分别在三个版本下分别运行即6个作业</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">example_matrix:</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">os:</span> [<span class="string">ubuntu-22.04</span>, <span class="string">ubuntu-20.04</span>]</span><br><span class="line">        <span class="attr">version:</span> [<span class="number">10</span>, <span class="number">12</span>, <span class="number">14</span>]</span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/setup-node@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.version</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.strategy.matrix.include</code>：include下是一个列表，如果对象中的键:值对均未覆盖任何原始矩阵值，则会将键:值对添加到每个矩阵组合中。 如果对象不能添加到任何矩阵组合中，将改为创建新的矩阵组合。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">strategy:</span></span><br><span class="line">  <span class="attr">matrix:</span></span><br><span class="line">    <span class="attr">fruit:</span> [<span class="string">apple</span>, <span class="string">pear</span>]</span><br><span class="line">    <span class="attr">animal:</span> [<span class="string">cat</span>, <span class="string">dog</span>]</span><br><span class="line">    <span class="attr">include:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">color:</span> <span class="string">pink</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">color:</span> <span class="string">green</span></span><br><span class="line">        <span class="attr">animal:</span> <span class="string">cat</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fruit:</span> <span class="string">apple</span></span><br><span class="line">        <span class="attr">shape:</span> <span class="string">circle</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fruit:</span> <span class="string">banana</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">fruit:</span> <span class="string">banana</span></span><br><span class="line">        <span class="attr">animal:</span> <span class="string">cat</span></span><br></pre></td></tr></table></figure><p>解释</p><ul><li><code>&#123;color: green&#125;</code> 添加到所有原始矩阵组合，因为它可以添加，而不会覆盖原始组合的任何部分。</li><li><code>&#123;color: pink, animal: cat&#125;</code> 仅将 <code>color:pink</code> 添加到包含 <code>animal: cat</code> 的原始矩阵组合中。 这会覆盖上一个 <code>include</code> 条目添加的 <code>color: green</code>。</li><li><code>&#123;fruit: apple, shape: circle&#125;</code> 仅将 <code>shape: circle</code> 添加到包含 <code>fruit: apple</code> 的原始矩阵组合中。</li><li><code>&#123;fruit: banana&#125;</code> 添加到任何原始矩阵组合时都会覆盖值，因此会将其作为其他矩阵组合进行添加。</li><li><code>&#123;fruit: banana, animal: cat&#125;</code> 添加到任何原始矩阵组合时都会覆盖值，因此会将其作为其他矩阵组合进行添加。 它不会添加到 <code>&#123;fruit: banana&#125;</code> 矩阵组合中，因为该组合不是原始矩阵组合之一</li></ul><p>即生成六个作业</p><ul><li><code>&#123;fruit: apple, animal: cat, color: pink, shape: circle&#125;</code></li><li><code>&#123;fruit: apple, animal: dog, color: green, shape: circle&#125;</code></li><li><code>&#123;fruit: pear, animal: cat, color: pink&#125;</code></li><li><code>&#123;fruit: pear, animal: dog, color: green&#125;</code></li><li><code>&#123;fruit: banana&#125;</code></li><li><code>&#123;fruit: banana, animal: cat&#125;</code></li></ul><p>工作流将运行六个作业，其中针对每个 <code>os</code> 和 <code>node</code> 变量组合提供一个作业。 当对应于 <code>windows-latest</code> 的 <code>os</code> 值和 <code>16</code> 的 <code>node</code> 值的作业运行时，作业中将包含一个被称为 <code>npm</code> 且值为 <code>6</code> 的其他变量</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">example_matrix:</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">os:</span> [<span class="string">windows-latest</span>, <span class="string">ubuntu-latest</span>]</span><br><span class="line">        <span class="attr">node:</span> [<span class="number">12</span>, <span class="number">14</span>, <span class="number">16</span>]</span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">os:</span> <span class="string">windows-latest</span></span><br><span class="line">            <span class="attr">node:</span> <span class="number">16</span></span><br><span class="line">            <span class="attr">npm:</span> <span class="number">6</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/setup-node@v3</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">node-version:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.node</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">if:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.npm</span> <span class="string">&#125;&#125;</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span> <span class="string">-g</span> <span class="string">npm@$&#123;&#123;</span> <span class="string">matrix.npm</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">run:</span> <span class="string">npm</span> <span class="string">--version</span></span><br></pre></td></tr></table></figure><p>将运行 10 个作业，矩阵中每个 <code>os</code> 和 <code>version</code> 的组合一个作业，再加上一个用于 <code>windows-latest</code> 的 <code>os</code> 值和 <code>17</code> 的 <code>version</code> 值的作业</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">example_matrix:</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">os:</span> [<span class="string">macos-latest</span>, <span class="string">windows-latest</span>, <span class="string">ubuntu-latest</span>]</span><br><span class="line">        <span class="attr">version:</span> [<span class="number">12</span>, <span class="number">14</span>, <span class="number">16</span>]</span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">os:</span> <span class="string">windows-latest</span></span><br><span class="line">            <span class="attr">version:</span> <span class="number">17</span></span><br></pre></td></tr></table></figure><p>工作流将运行两个作业，每个 <code>include</code> 一个作业。 这样你可以利用矩阵策略，而无需完全填充矩阵</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">includes_only:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">site:</span> <span class="string">&quot;production&quot;</span></span><br><span class="line">            <span class="attr">datacenter:</span> <span class="string">&quot;site-a&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">site:</span> <span class="string">&quot;staging&quot;</span></span><br><span class="line">            <span class="attr">datacenter:</span> <span class="string">&quot;site-b&quot;</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.strategy.matrix.exclude</code>：移除矩阵中定义的特定配置</p><p>工作流将运行 9 个作业：每 12 个配置一个作业，再减去一个与 <code>&#123;os: macos-latest, version: 12, environment: production&#125;</code> 匹配的排除作业，以及两个与 <code>&#123;os: windows-latest, version: 16&#125;</code> 匹配的排除作业</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">strategy:</span></span><br><span class="line">  <span class="attr">matrix:</span></span><br><span class="line">    <span class="attr">os:</span> [<span class="string">macos-latest</span>, <span class="string">windows-latest</span>]</span><br><span class="line">    <span class="attr">version:</span> [<span class="number">12</span>, <span class="number">14</span>, <span class="number">16</span>]</span><br><span class="line">    <span class="attr">environment:</span> [<span class="string">staging</span>, <span class="string">production</span>]</span><br><span class="line">    <span class="attr">exclude:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">os:</span> <span class="string">macos-latest</span></span><br><span class="line">        <span class="attr">version:</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">environment:</span> <span class="string">production</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">os:</span> <span class="string">windows-latest</span></span><br><span class="line">        <span class="attr">version:</span> <span class="number">16</span></span><br><span class="line"><span class="attr">runs-on:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.os</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>语法：</p><ul><li><code>jobs.&lt;job_id&gt;.strategy.fail-fast</code>：设置为 <code>true</code>，则在矩阵中的任何作业失败的情况下，GitHub 将取消矩阵中所有正在进行和加入队列的作业。 此属性的默认值为 <code>true</code></li><li><code>jobs.&lt;job_id&gt;.continue-on-error</code> ：适用于单个作业。 如果 <code>jobs.&lt;job_id&gt;.continue-on-error</code> 为 <code>true</code>，即使具有 <code>jobs.&lt;job_id&gt;.continue-on-error: true</code> 的作业失败，矩阵中的其他作业也将继续运行</li></ul><p>可以同时使用 <code>jobs.&lt;job_id&gt;.strategy.fail-fast</code> 和 <code>jobs.&lt;job_id&gt;.continue-on-error</code>。 例如，以下工作流将启动四个作业。 对于每个作业，<code>continue-on-error</code> 都由 <code>matrix.experimental</code> 的值确定。 如果任何具有 <code>continue-on-error: false</code> 的作业失败，所有正在进行或加入队列的作业都将被取消。 如果具有 <code>continue-on-error: true</code> 的作业失败，则其他作业将不会受到影响</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">test:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">continue-on-error:</span> <span class="string">$&#123;&#123;</span> <span class="string">matrix.experimental</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">version:</span> [<span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>]</span><br><span class="line">        <span class="attr">experimental:</span> [<span class="literal">false</span>]</span><br><span class="line">        <span class="attr">include:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">version:</span> <span class="number">9</span></span><br><span class="line">            <span class="attr">experimental:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>语法：<code>jobs.&lt;job_id&gt;.strategy.max-parallel</code>：GitHub 将根据运行器的可用性将并行运行的作业数最大化</p><p>工作流一次最多运行两个作业，即使运行器可同时运行六个作业</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">example_matrix:</span></span><br><span class="line">    <span class="attr">strategy:</span></span><br><span class="line">      <span class="attr">max-parallel:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">matrix:</span></span><br><span class="line">        <span class="attr">version:</span> [<span class="number">10</span>, <span class="number">12</span>, <span class="number">14</span>]</span><br><span class="line">        <span class="attr">os:</span> [<span class="string">ubuntu-latest</span>, <span class="string">windows-latest</span>]</span><br></pre></td></tr></table></figure><p>关于docker，这部分挺好理解的，跟compose.yaml差不多，所以简述了</p><p><code>jobs.&lt;job_id&gt;.container</code>：创建一个容器</p><p><code>jobs.&lt;job_id&gt;.container.image</code>：定义要用作运行操作的容器的 Docker 映像</p><p><code>jobs.&lt;job_id&gt;.container.credentials</code>：映像的容器注册表需要身份验证才能拉取映像</p><p><code>jobs.&lt;job_id&gt;.container.env</code>：容器中设置环境变量</p><p><code>jobs.&lt;job_id&gt;.container.ports</code>：容器的端口</p><p><code>jobs.&lt;job_id&gt;.container.volumes</code>：挂载卷</p><p><code>jobs.&lt;job_id&gt;.container.options</code>：容器的其它选项</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">CI</span></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> [ <span class="string">main</span> ]</span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">container-test-job:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">container:</span></span><br><span class="line">      <span class="comment"># 验证身份</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.actor</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.github_token</span> <span class="string">&#125;&#125;</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">node:14.16</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">NODE_ENV:</span> <span class="string">development</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">my_docker_volume:/volume_mount</span></span><br><span class="line">      <span class="attr">options:</span> <span class="string">--cpus</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">for</span> <span class="string">dockerenv</span> <span class="string">file</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">(ls</span> <span class="string">/.dockerenv</span> <span class="string">&amp;&amp;</span> <span class="string">echo</span> <span class="string">Found</span> <span class="string">dockerenv)</span> <span class="string">||</span> <span class="string">(echo</span> <span class="literal">No</span> <span class="string">dockerenv)</span></span><br></pre></td></tr></table></figure><p><code>jobs.&lt;job_id&gt;.services</code>：If you configure the job to run directly on the runner machine and your step doesn’t use a container action, you must map any required Docker service container ports to the Docker host (the runner machine). You can access the service container using localhost and the mapped port.译：如果您将作业配置为直接在运行程序机器上运行，并且您的步骤不使用容器操作，那么您必须将任何所需的Docker服务容器端口映射到Docker主机(运行程序机器)</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="comment"># Map port 8080 on the Docker host to port 80 on the nginx container</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:80</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="comment"># Map TCP port 6379 on Docker host to a random free port on the Redis container</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">/tcp</span></span><br></pre></td></tr></table></figure><h3 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h3><p>前文，写了很多类似于<strong>『secret.xxx』</strong>的东西，在写Actions时，文件或者仓库中可能会涉及一些密码不希望被泄露，可以在在仓库下『Setting-&gt;Secrets-&gt;Actions』定义的该变量，之后在Actions中读取</p><h2 id="三、Rule"><a href="#三、Rule" class="headerlink" title="三、Rule"></a>三、Rule</h2><p>Github Actions并非完全免费，但对于日常使用足够</p><p>以官方最新说明为主：<a href="https://docs.github.com/en/actions/learn-github-actions/usage-limits-billing-and-administration">Usage limits, billing, and administration - GitHub Docs</a></p><div class="tabs" id="github-actions"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#github-actions-1">English</button></li><li class="tab"><button type="button" data-href="#github-actions-2">小张直译</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="github-actions-1"><ul><li><p><strong>Job execution time</strong> - Each job in a workflow can run for up to 6 hours of execution time. If a job reaches this limit, the job is terminated and fails to complete.</p></li><li><p><strong>Workflow run time</strong> - Each workflow run is limited to 35 days. If a workflow run reaches this limit, the workflow run is cancelled. This period includes execution duration, and time spent on waiting and approval.</p></li><li><p><strong>API requests</strong> - You can execute up to 1000 requests to the GitHub API in an hour across all actions within a repository. If requests are exceeded, additional API calls will fail which might cause jobs to fail.</p></li><li><p><strong>Concurrent jobs</strong> - The number of concurrent jobs you can run in your account depends on your GitHub plan, as indicated in the following table. If exceeded, any additional jobs are queued.</p><table><thead><tr><th align="left">GitHub plan</th><th align="left">Total concurrent jobs</th><th align="left">Maximum concurrent macOS jobs</th></tr></thead><tbody><tr><td align="left">Free</td><td align="left">20</td><td align="left">5</td></tr><tr><td align="left">Pro</td><td align="left">40</td><td align="left">5</td></tr><tr><td align="left">Team</td><td align="left">60</td><td align="left">5</td></tr><tr><td align="left">Enterprise</td><td align="left">180</td><td align="left">50</td></tr></tbody></table></li><li><p><strong>Job matrix</strong> - A job matrix can generate a maximum of 256 jobs per workflow run. This limit applies to both GitHub-hosted and self-hosted runners.</p></li><li><p><strong>Workflow run queue</strong> - No more than 500 workflow runs can be queued in a 10 second interval per repository. If a workflow run reaches this limit, the workflow run is terminated and fails to complete.</p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="github-actions-2"><ul><li><p>作业时间：每一个作业运行时间不得超过6小时，如果超过六小时，这个作业将会终止而无法完成</p></li><li><p>工作流时间：每一个工作流不得超过35天，如果超出此限制，这个工作流将被取消，此时间段包括执行持续时间以及等待和批准所花费的时间</p></li><li><p>API请求：在同一个仓库中一个小时内最多可以执行1000次API请求，如果请求超出，API将调用失败可能导致作业失败</p></li><li><p>并发作业：账户中可以运行的并发数量取决于Github计划，如果超出将排队作业</p><table><thead><tr><th align="left">GitHub plan</th><th align="left">并发数量</th><th align="left">MacOS 最大并发数</th></tr></thead><tbody><tr><td align="left">Free</td><td align="left">20</td><td align="left">5</td></tr><tr><td align="left">Pro</td><td align="left">40</td><td align="left">5</td></tr><tr><td align="left">Team</td><td align="left">60</td><td align="left">5</td></tr><tr><td align="left">Enterprise</td><td align="left">180</td><td align="left">50</td></tr></tbody></table></li><li><p>作业矩阵：一个作业中的矩阵最多可以生成256个，此限制适用于 Github 托管（GitHub-hosted）和自托管运行（self-hosted runners）</p></li><li><p>工作流队列：每一个仓库不超过500个工作流可以被排队，间隔10s。如果超出限制，这个工作流将终止且运行失败</p></li></ul><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><h2 id="四、自用整理常用Actions"><a href="#四、自用整理常用Actions" class="headerlink" title="四、自用整理常用Actions"></a>四、自用整理常用Actions</h2><p>善用<a href="https://github.com/marketplace?type=actions">GitHub Marketplace</a>会减少我们做Actions的工作量，以下为自己常用的Actions</p><h3 id="Clone-From-Github"><a href="#Clone-From-Github" class="headerlink" title="Clone From Github"></a>Clone From Github</h3><p>需要对当前仓库操作时，手撕版</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Clone</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    git clone 仓库地址</span></span><br><span class="line"><span class="string">    cd 仓库名</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/marketplace/actions/checkout">Checkout</a>：最常见的Actions，clone当前仓库的默认分支，指定<strong>仓库&#x2F;分支</strong>详见文档</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br></pre></td></tr></table></figure><h3 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h3><p>Ubuntu自带py环境但没有node环境</p><p><a href="https://github.com/marketplace/actions/setup-python">Setup Python</a>：python环境</p><p><a href="https://github.com/marketplace/actions/setup-node-js-environment">Setup Node.js environment</a>：nodejs</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 默认版本由 runs-on 决定</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Python</span> </span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/setup-python@v4</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">python-version:</span> <span class="number">3.8</span></span><br><span class="line">    </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Setup</span> <span class="string">Node</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">actions/setup-node@v3</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">node-version:</span> <span class="string">&quot;12.x&quot;</span></span><br></pre></td></tr></table></figure><h3 id="Push-To-GitHub"><a href="#Push-To-GitHub" class="headerlink" title="Push To GitHub"></a>Push To GitHub</h3><p>当工作流对仓库工作区改动需要push时，手撕版</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Commit</span> <span class="string">&amp;</span> <span class="string">Push</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    git config user.name github-actions[bot]</span></span><br><span class="line"><span class="string">    git config user.email github-actions[bot]@users.noreply.github.com</span></span><br><span class="line"><span class="string">    git add -A .</span></span><br><span class="line"><span class="string">    git commit -m &quot;Commit &amp; Push&quot;</span></span><br><span class="line"><span class="string">    git push</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/EndBug/add-and-commit">EndBug&#x2F;add-and-commit</a>：简化push</p><table><thead><tr><th>参数</th><th>说明</th><th>默认</th><th>示例</th></tr></thead><tbody><tr><td>add</td><td>添加暂存区文件</td><td>add: ‘.’</td><td>add: ‘src’</td></tr><tr><td>author_name</td><td>用户名</td><td>作者用户名</td><td></td></tr><tr><td>author_email</td><td>邮箱</td><td>作者邮箱</td><td></td></tr><tr><td>commit</td><td>提交信息</td><td>commit: ‘’</td><td>commit: ‘Commit &amp; Push’</td></tr></tbody></table><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Push</span> <span class="string">to</span> <span class="string">GitHub</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">EndBug/add-and-commit@v7.2.1</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;Commit &amp; Push&#x27;</span></span><br></pre></td></tr></table></figure><h3 id="主页美化"><a href="#主页美化" class="headerlink" title="主页美化"></a>主页美化</h3><blockquote><p>美化效果：<a href="https://github.com/GC-ZF/GC-ZF">GC-ZF&#x2F;GC-ZF: My GitHub profile.</a></p></blockquote><p><a href="https://github.com/marketplace/actions/blog-post-workflow">Blog Post Workflow</a>：拉取最新博文</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 参考：https://github.com/CCKNBC/CCKNBC</span></span><br><span class="line"><span class="comment"># Actions1：https://github.com/marketplace/actions/delete-workflow-runs</span></span><br><span class="line"><span class="comment"># Actions2：https://github.com/marketplace/actions/blog-post-workflow</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">update</span> <span class="string">blog</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">schedule:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&#x27;0 0 * * *&#x27;</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 具体参数看文档</span></span><br><span class="line">    <span class="comment"># feed_list 必填 rss地址</span></span><br><span class="line">    <span class="comment"># max_post_count 必填 获取文章数</span></span><br><span class="line">    <span class="comment"># reade_path 选填 默认写入README</span></span><br><span class="line">    <span class="comment"># template 选填 生成模版 emojikey随机表情 默认为[$title]($url)</span></span><br><span class="line">    <span class="comment"># date_format 选填 修改模版中日期格式 默认英文 </span></span><br><span class="line">    <span class="comment"># committer_username和committer_email 选填 提交信息</span></span><br><span class="line">    <span class="comment"># filter_dates 选填 daysAgo/10/代表只获取近10天博文 ， currentMonth只获取当月博文， currentYear只获取当年博文</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">blog-post-workflow</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">gautamkrishnar/blog-post-workflow@master</span></span><br><span class="line">      <span class="attr">with:</span></span><br><span class="line">        <span class="attr">feed_list:</span> <span class="string">&quot;https://zhsher.cn/feed.xml&quot;</span></span><br><span class="line">        <span class="attr">max_post_count:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">readme_path:</span> <span class="string">&quot;./README.md&quot;</span></span><br><span class="line">        <span class="attr">template:</span> <span class="string">&quot;$newline - $emojiKey(💯,🔥,💫,🚀,🌮,💫) $date [$title]($url)&quot;</span></span><br><span class="line">        <span class="attr">date_format:</span> <span class="string">&quot;yyyy年mm月dd日&quot;</span></span><br><span class="line">        <span class="attr">committer_username:</span> <span class="string">&quot;github-actions[bot]&quot;</span></span><br><span class="line">        <span class="attr">committer_email:</span> <span class="string">&quot;github-actions[bot]@users.noreply.github.com&quot;</span></span><br><span class="line">        <span class="attr">filter_dates:</span> <span class="string">&quot;currentYear&quot;</span></span><br><span class="line">        </span><br><span class="line">     <span class="comment"># 删除近retain_days天的Workflow日志</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Delete</span> <span class="string">Workflow</span> <span class="string">Runs</span></span><br><span class="line">       <span class="attr">uses:</span> <span class="string">Mattraks/delete-workflow-runs@main</span></span><br><span class="line">       <span class="attr">with:</span></span><br><span class="line">         <span class="attr">retain_days:</span> <span class="number">10</span></span><br><span class="line">         <span class="attr">keep_minimum_runs:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/marketplace/actions/github-profile-3d-contrib">GitHub-Profile-3D-Contrib</a>：绘制3D贡献图</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">GitHub-Profile-3D-Contrib</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">schedule:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&quot;0 0 * * *&quot;</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">generate-github-profile-3d-contrib</span></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">uses:</span> <span class="string">yoshi389111/github-profile-3d-contrib@0.5.0</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="attr">GITHUB_TOKEN:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">USERNAME:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository_owner</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Commit</span> <span class="string">&amp;</span> <span class="string">Push</span></span><br><span class="line">        <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">          S=$(curl &#x27;https://v1.hitokoto.cn/?c=a&amp;encode=text&#x27;)</span></span><br><span class="line"><span class="string">          git config user.name github-actions[bot]</span></span><br><span class="line"><span class="string">          git config user.email github-actions[bot]@users.noreply.github.com</span></span><br><span class="line"><span class="string">          git add -A .</span></span><br><span class="line"><span class="string">          git commit -m &quot;:rocket: $&#123;S&#125;&quot;</span></span><br><span class="line"><span class="string">          git push</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/Platane/snk">Platane&#x2F;snk</a>：贪吃蛇版贡献图</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Generate</span> <span class="string">Snake</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">schedule:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">cron:</span> <span class="string">&quot;0 0 * * *&quot;</span></span><br><span class="line">  <span class="attr">workflow_dispatch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">build:</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Checkout</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">actions/checkout@v2.3.4</span></span><br><span class="line">      </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Generate</span> <span class="string">Snake</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">Platane/snk@master</span></span><br><span class="line">        <span class="attr">id:</span> <span class="string">snake-gif</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">github_user_name:</span> <span class="string">$&#123;&#123;</span> <span class="string">github.repository_owner</span> <span class="string">&#125;&#125;</span></span><br><span class="line">          <span class="attr">gif_out_path:</span> <span class="string">./contribution-snake/github-contribution-grid-snake.gif</span></span><br><span class="line">          <span class="attr">svg_out_path:</span> <span class="string">./contribution-snake/github-contribution-grid-snake.svg</span></span><br><span class="line"></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Push</span> <span class="string">to</span> <span class="string">GitHub</span></span><br><span class="line">        <span class="attr">uses:</span> <span class="string">EndBug/add-and-commit@v7.2.1</span></span><br><span class="line">        <span class="attr">with:</span></span><br><span class="line">          <span class="attr">author_name:</span> <span class="string">github-actions[bot]</span></span><br><span class="line">          <span class="attr">author_email:</span> <span class="string">github-actions[bot]@users.noreply.github.com</span></span><br><span class="line">          <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line">          <span class="attr">message:</span> <span class="string">&#x27;:rocket: Update&#x27;</span></span><br></pre></td></tr></table></figure><p>其它美化Actions：</p><ul><li><a href="https://github.com/anmol098/waka-readme-stats">anmol098&#x2F;waka-readme-stats</a></li></ul><h3 id="Github-sync-to-other-repo"><a href="#Github-sync-to-other-repo" class="headerlink" title="Github sync to other repo"></a>Github sync to other repo</h3><p><a href="https://github.com/marketplace/actions/mirror-a-repository-using-ssh">Mirror a repository using SSH</a>：同步Github中的仓库到其它平台</p><p><a href="https://github.com/marketplace/actions/gitee-pages-action">Gitee Pages Action · Actions</a>：如果需要开启Gitee Page，参考此Actions</p><p>以Github同步Gitee为例：</p><ol><li><p><code>ssh-keygen -t rsa -C &quot;任意命名&quot; -f &quot;id_rsa_github to gitee&quot;</code> 生成 SSH Key。(⚠️注意<strong>直接连续三次回车</strong>，此处不要设置密码，生成的公私钥用于下面 GitHub &#x2F; Gitee 的配置，以保证公私钥成对，否则从 GitHub -&gt; Gitee 的同步将会失败)。生成的 <code>id_rsa_github to gitee</code> 是私钥，<code>id_rsa_github to gitee.pub</code> 是公钥</p></li><li><p>在仓库 的「Settings -&gt; Secrets」路径下配置好命名为 <code>GITEE_RSA_PRIVATE_KEY</code> 和 <code>GITEE_PASSWORD</code> 的两个变量。其中：<code>GITEE_RSA_PRIVATE_KEY</code> 存放 <code>id_rsa</code> 私钥；<code>GITEE_PASSWORD</code> 存放 Gitee 帐号的密码</p></li></ol><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://test1.jsdelivr.net/gh/yanglbme/gitee-pages-action/images/add_secrets.png"></p><ol start="3"><li>在 GitHub 的个人设置页面「<a href="https://github.com/settings/keys">Settings -&gt; SSH and GPG keys</a>」配置 SSH 公钥（即：<code>id_rsa_github to gitee.pub</code>），命名随意</li><li>在 Gitee 的个人设置页面「<a href="https://gitee.com/profile/sshkeys">安全设置 -&gt; SSH 公钥</a>」配置 SSH 公钥（即：<code>id_rsa_github to gitee.pub</code>），命名随意</li></ol><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Sync</span> <span class="string">to</span> <span class="string">Gitee</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">wearerequired/git-mirror-action@master</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="comment"># 注意在 Settings-&gt;Secrets 配置 GITEE_RSA_PRIVATE_KEY</span></span><br><span class="line">    <span class="attr">SSH_PRIVATE_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITEE_RSA_PRIVATE_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="comment"># 注意替换为你的 GitHub 源仓库地址</span></span><br><span class="line">    <span class="attr">source-repo:</span> <span class="string">git@github.com:doocs/leetcode.git</span></span><br><span class="line">    <span class="comment"># 注意替换为你的 Gitee 目标仓库地址</span></span><br><span class="line">    <span class="attr">destination-repo:</span> <span class="string">git@gitee.com:Doocs/leetcode.git</span></span><br></pre></td></tr></table></figure><h3 id="操作云服务器"><a href="#操作云服务器" class="headerlink" title="操作云服务器"></a>操作云服务器</h3><p>手撕版，<code>DEPLOY_PRI</code>为连接服务器的私钥</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssh</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">DEPLOY_PRI:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DEPLOY_PRI</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    sudo timedatectl set-timezone &quot;Asia/Shanghai&quot;</span></span><br><span class="line"><span class="string">    mkdir -p ~/.ssh/</span></span><br><span class="line"><span class="string">    echo &quot;$DEPLOY_PRI&quot; &gt; ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">    chmod 600 ~/.ssh/id_rsa</span></span><br><span class="line"><span class="string">    ssh-keyscan 服务器ip &gt;&gt; ~/.ssh/known_hosts</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">    <span class="string">ssh</span> <span class="string">ubuntu@服务器ip</span> </span><br><span class="line">    <span class="string">&quot;</span></span><br><span class="line"><span class="string">    shell命令，一行一个</span></span><br><span class="line"><span class="string">    cd /xxx/</span></span><br><span class="line"><span class="string">    ls</span></span><br><span class="line"><span class="string">    &quot;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/marketplace/actions/ssh-pipeline">ssh-pipeline</a>：连接服务器并对服务器操作</p><table><thead><tr><th>参数</th><th>说明</th><th>默认</th></tr></thead><tbody><tr><td>host*</td><td>ip</td><td></td></tr><tr><td>user*</td><td>用户</td><td></td></tr><tr><td>pass（与key二选一）</td><td>密码</td><td></td></tr><tr><td>key（与pass二选一）</td><td>私钥</td><td></td></tr><tr><td>port</td><td>端口</td><td>22</td></tr><tr><td>connect_timeout</td><td>连接超时时间</td><td>30s</td></tr><tr><td>script</td><td>命令</td><td></td></tr></tbody></table><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssh</span> <span class="string">pipelines</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">cross-the-world/ssh-pipeline@master</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">WELCOME:</span> <span class="string">&quot;ssh pipeline&quot;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_HOST</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_USER</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">pass:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_PASS</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_PORT</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">connect_timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">script:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      (rm -rf /home/github/test || true)</span></span><br><span class="line"><span class="string">      ls -la  </span></span><br><span class="line"><span class="string">      echo $WELCOME </span></span><br><span class="line"><span class="string">      mkdir -p /home/github/test/test1 &amp;&amp; </span></span><br><span class="line"><span class="string">      mkdir -p /home/github/test/test2 &amp;&amp;</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/marketplace/actions/ssh-scp-ssh-pipelines">ssh-scp-ssh-pipelines</a>：同一作者的优化版，与上表不同的是去除了<code>script</code>，新增</p><ul><li><code>first_ssh</code>：scp之前需要做的命令</li><li><code>scp</code>：sync copy，复制本地到服务器中，支持正则</li><li><code>last_ssh</code>：scp之后需要做的命令</li></ul><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ssh</span> <span class="string">scp</span> <span class="string">ssh</span> <span class="string">pipelines</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">cross-the-world/ssh-scp-ssh-pipelines@latest</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">WELCOME:</span> <span class="string">&quot;ssh scp ssh pipelines&quot;</span></span><br><span class="line">    <span class="attr">LASTSSH:</span> <span class="string">&quot;Doing something after copying&quot;</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_HOST</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_USER</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">pass:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_PASS</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.DC_PORT</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">connect_timeout:</span> <span class="string">10s</span></span><br><span class="line">    <span class="attr">first_ssh:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      rm -rf /home/github/test</span></span><br><span class="line"><span class="string">      ls -la  \necho $WELCOME </span></span><br><span class="line"><span class="string">      mkdir -p /home/github/test/test1 &amp;&amp; </span></span><br><span class="line"><span class="string">      mkdir -p /home/github/test/test2 &amp;&amp;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">scp:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      &#x27;./test/*&#x27; =&gt; /home/github/test/</span></span><br><span class="line"><span class="string">      ./test/test1* =&gt; /home/github/test/test1/</span></span><br><span class="line"><span class="string">      ./test/test*.csv =&gt; &quot;/home/github/test/test2/&quot;</span></span><br><span class="line"><span class="string"></span>    <span class="attr">last_ssh:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      echo $LASTSSH &amp;&amp; </span></span><br><span class="line"><span class="string">      (mkdir test1/test || true)</span></span><br><span class="line"><span class="string">      || ls -la</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/marketplace/actions/ssh-deploy">ssh deploy</a>：更倾向于服务器同步文件操作的工作流，最大的特点是利用 <code>rsync</code>（remote sync 远程同步）命令备份数据时，不会直接覆盖以前的数据，而是先判断已经存在的数据和新数据的差异，只有数据不同时才会把不相同的部分覆盖，所以速度上会很快</p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td>SSH_PRIVATE_KEY*</td><td>服务器私钥</td></tr><tr><td>ARGS*</td><td>rsync的参数</td></tr><tr><td>SOURCE</td><td>源路径</td></tr><tr><td>TARGET</td><td>目标路径</td></tr><tr><td>REMOTE_HOST*</td><td>服务器ip</td></tr><tr><td>REMOTE_USER*</td><td>服务器用户名</td></tr><tr><td>EXCLUDE</td><td>排除文件</td></tr><tr><td>SCRIPT_BEFORE</td><td>同步前的操作</td></tr><tr><td>SCRIPT_AFTER</td><td>同步后的操作</td></tr></tbody></table><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span> <span class="string">to</span> <span class="string">Staging</span> <span class="string">server</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">easingthemes/ssh-deploy@main</span></span><br><span class="line">  <span class="attr">env:</span></span><br><span class="line">    <span class="attr">SSH_PRIVATE_KEY:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SSH_PRIVATE_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">ARGS:</span> <span class="string">&quot;-rlgoDzvc -i&quot;</span></span><br><span class="line">    <span class="attr">SOURCE:</span> <span class="string">&quot;dist/&quot;</span></span><br><span class="line">    <span class="attr">REMOTE_HOST:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.REMOTE_HOST</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">REMOTE_USER:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.REMOTE_USER</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">TARGET:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.REMOTE_TARGET</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">EXCLUDE:</span> <span class="string">&quot;/dist/, /node_modules/&quot;</span></span><br><span class="line">    <span class="attr">SCRIPT_BEFORE:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      whoami</span></span><br><span class="line"><span class="string">      ls -al</span></span><br><span class="line"><span class="string"></span>    <span class="attr">SCRIPT_AFTER:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      whoami</span></span><br><span class="line"><span class="string">      ls -al</span></span><br><span class="line"><span class="string">      echo $RSYNC_STDOUT</span></span><br></pre></td></tr></table></figure><h3 id="小tips"><a href="#小tips" class="headerlink" title="小tips"></a>小tips</h3><blockquote><p>一些不常用的Actions及使用技巧</p></blockquote><p><a href="https://github.com/ryan4yin/waline-comments-backup">waline-comments-backup</a>：<a href="https://thiscute.world/">@二花</a>的数据库备份方案，使用了gpg对文件加密，不错的点子！</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 gpg 加密备份文件，需要提前生成随机密码，保存到 github action secrets 中，环境变量名称为 `COMMENTS_DECRYPT_KEY`</span></span><br><span class="line"><span class="comment"># 建议使用密码管理器备份此 gpg 密码，方便在本地做数据恢复</span></span><br><span class="line"><span class="comment"># 将数据解密到 /tmp 文件夹中（建议在需要时，在本地执行）：gpg --quiet --batch --yes --decrypt --passphrase=&quot;$COMMENTS_DECRYPT_KEY&quot; --output /tmp/waline_comments.json data/waline_comments.json.gpg</span></span><br><span class="line"><span class="string">gpg</span> <span class="string">--quiet</span> <span class="string">--batch</span> <span class="string">--yes</span> <span class="string">--passphrase=&quot;$COMMENTS_DECRYPT_KEY&quot;</span> <span class="string">--symmetric</span> <span class="string">--cipher-algo</span> <span class="string">AES256</span> <span class="string">data/waline_comments.json</span></span><br><span class="line"><span class="comment"># 删除明文的备份文件</span></span><br><span class="line"><span class="string">rm</span> <span class="string">-f</span> <span class="string">data/waline_comments.json</span></span><br></pre></td></tr></table></figure><p><a href="https://github.com/dawidd6/action-send-mail">dawidd6&#x2F;action-send-mail</a>：利用Actions发送邮件</p><p><a href="https://github.com/justjavac/auto-green">justjavac&#x2F;auto-green</a>：自动保持 GitHub 提交状态常绿 <strong>a commit every day, keep your girlfriend far away.</strong> （仅定时运行脚本无提交，60天后会自动关闭Actions，可以借助这个）</p>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/%E7%AC%94%E8%AE%B0/">笔记</category>
      
      
      <category domain="https://zhsher.cn/tags/Git/">Git</category>
      
      <category domain="https://zhsher.cn/tags/Github/">Github</category>
      
      
      <comments>https://zhsher.cn/posts/7339/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Docker的简单食用论</title>
      <link>https://zhsher.cn/posts/63200/</link>
      <guid>https://zhsher.cn/posts/63200/</guid>
      <pubDate>Sun, 06 Nov 2022 15:43:11 GMT</pubDate>
      
        
        
      <description>&lt;blockquote&gt;
&lt;p&gt;愚有一台Ubuntu的服务器，常无事好(hào)折腾，安装部署如有它法，则避之。然近不得已用docker，CSDN其文章误人子弟！反复安装数次，遂请大佬阅之，大佬以为有过，故特意总结整理&lt;/p&gt;
&lt;p&gt;以下文章取自&lt;a href=&quot;https://</description>
        
      
      
      
      <content:encoded><![CDATA[<blockquote><p>愚有一台Ubuntu的服务器，常无事好(hào)折腾，安装部署如有它法，则避之。然近不得已用docker，CSDN其文章误人子弟！反复安装数次，遂请大佬阅之，大佬以为有过，故特意总结整理</p><p>以下文章取自<a href="https://vuepress.mirror.docker-practice.com/">Docker 从入门到实践</a>（强烈推荐小白阅读），以及自己的一些理解</p><p>旧活新整？<del>小张也开始水文了？！</del>简单食用论在八月初发过一次，当时初次体验docker，现在有了更多的认识（<strong>『Docker Compose』</strong>越用越香啊！）以及常用命令所以重构一篇</p></blockquote><h2 id="一、安装Docker"><a href="#一、安装Docker" class="headerlink" title="一、安装Docker"></a>一、安装Docker</h2><p><a href="https://vuepress.mirror.docker-practice.com/install/">安装 Docker 教程</a>中有主流的Ubuntu、Centos、MacOS等安装教程，这里以我的Ubuntu为例</p><h3 id="卸载旧版本"><a href="#卸载旧版本" class="headerlink" title="卸载旧版本"></a>卸载旧版本</h3><p>旧版本的 Docker 称为 <code>docker</code> 或者 <code>docker-engine</code>，首先卸载旧版本</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get remove docker \</span><br><span class="line">               docker-engine \</span><br><span class="line">               docker.io</span><br></pre></td></tr></table></figure><h3 id="使用-APT-安装"><a href="#使用-APT-安装" class="headerlink" title="使用 APT 安装"></a>使用 APT 安装</h3><p>由于 <code>apt</code> 源使用 HTTPS 以确保软件下载过程中不被篡改。因此，我们首先需要添加使用 HTTPS 传输的软件包以及 CA 证书</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get update<span class="comment"># 先更新一下</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br></pre></td></tr></table></figure><p>为了确认所下载软件包的合法性，需要添加软件源的 <code>GPG</code> 密钥，二选一</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 阿里源</span></span><br><span class="line">$ curl -fsSL https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 官方源</span></span><br><span class="line">$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br></pre></td></tr></table></figure><p>然后，我们需要向 <code>sources.list</code> 中添加 Docker 软件源，二选一</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 阿里源</span></span><br><span class="line">$ <span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.aliyun.com/docker-ce/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># 官方源</span></span><br><span class="line">$ <span class="built_in">echo</span> \</span><br><span class="line">   <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">   <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></pre></td></tr></table></figure><blockquote><p>以上命令会添加稳定版本的 Docker APT 镜像源，如果需要测试版本的 Docker 请将 stable 改为 test</p></blockquote><h3 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h3><p>更新 apt 软件包缓存，并安装 <code>docker-ce</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure><h3 id="启动-Docker"><a href="#启动-Docker" class="headerlink" title="启动 Docker"></a>启动 Docker</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl <span class="built_in">enable</span> docker</span><br><span class="line">$ sudo systemctl start docker</span><br></pre></td></tr></table></figure><h3 id="建立-docker-用户组"><a href="#建立-docker-用户组" class="headerlink" title="建立 docker 用户组"></a>建立 docker 用户组</h3><p>默认情况下，<code>docker</code> 命令会使用 <a href="https://en.wikipedia.org/wiki/Unix_domain_socket">Unix socket</a> 与 Docker 引擎通讯。而只有 <code>root</code> 用户和 <code>docker</code> 组的用户才可以访问 Docker 引擎的 Unix socket。出于安全考虑，一般 Linux 系统上不会直接使用 <code>root</code> 用户。因此，更好地做法是将需要使用 <code>docker</code> 的用户加入 <code>docker</code> 用户组。</p><p>建立 <code>docker</code> 组：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo groupadd docker</span><br></pre></td></tr></table></figure><p>将当前用户加入 <code>docker</code> 组：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo usermod -aG docker <span class="variable">$USER</span></span><br></pre></td></tr></table></figure><p>退出当前终端并重新登录，进行如下测试。</p><h3 id="测试-Docker-是否安装正确"><a href="#测试-Docker-是否安装正确" class="headerlink" title="测试 Docker 是否安装正确"></a>测试 Docker 是否安装正确</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --<span class="built_in">rm</span> hello-world</span><br><span class="line"><span class="comment"># -----------输出-----------</span></span><br><span class="line">Unable to find image <span class="string">&#x27;hello-world:latest&#x27;</span> locally</span><br><span class="line">latest: Pulling from library/hello-world</span><br><span class="line">b8dfde127a29: Pull complete</span><br><span class="line">Digest: sha256:308866a43596e83578c7dfa15e27a73011bdd402185a84c5cd7f32a88b501a24</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> hello-world:latest</span><br><span class="line"></span><br><span class="line">Hello from Docker!</span><br><span class="line">This message shows that your installation appears to be working correctly.</span><br><span class="line"></span><br><span class="line">To generate this message, Docker took the following steps:</span><br><span class="line"> 1. The Docker client contacted the Docker daemon.</span><br><span class="line"> 2. The Docker daemon pulled the <span class="string">&quot;hello-world&quot;</span> image from the Docker Hub.</span><br><span class="line">    (amd64)</span><br><span class="line"> 3. The Docker daemon created a new container from that image <span class="built_in">which</span> runs the</span><br><span class="line">    executable that produces the output you are currently reading.</span><br><span class="line"> 4. The Docker daemon streamed that output to the Docker client, <span class="built_in">which</span> sent it</span><br><span class="line">    to your terminal.</span><br><span class="line"></span><br><span class="line">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class="line"> $ docker run -it ubuntu bash</span><br><span class="line"></span><br><span class="line">Share images, automate workflows, and more with a free Docker ID:</span><br><span class="line"> https://hub.docker.com/</span><br><span class="line"></span><br><span class="line">For more examples and ideas, visit:</span><br><span class="line"> https://docs.docker.com/get-started/</span><br></pre></td></tr></table></figure><p>若能正常输出以上信息，则说明安装成功</p><h3 id="镜像加速"><a href="#镜像加速" class="headerlink" title="镜像加速"></a>镜像加速</h3><p>如果在使用过程中发现拉取 Docker 镜像十分缓慢，可以配置 Docker 国内镜像加速</p><p>首先执行以下命令，查看是否在 <code>docker.service</code> 文件中配置过镜像地址。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl <span class="built_in">cat</span> docker | grep <span class="string">&#x27;\-\-registry\-mirror&#x27;</span></span><br></pre></td></tr></table></figure><p>如果该命令有输出，那么请执行 <code>$ systemctl cat docker</code> 查看 <code>ExecStart=</code> 出现的位置，修改对应的文件内容去掉 <code>--registry-mirror</code> 参数及其值，并按接下来的步骤进行配置。</p><p>如果以上命令没有任何输出，那么就可以在 <code>/etc/docker/daemon.json</code> 中写入如下内容（如果文件不存在请新建该文件）：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;https://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://mirror.baidubce.com&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>之后重新启动服务</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo systemctl daemon-reload</span><br><span class="line">$ sudo systemctl restart docker</span><br></pre></td></tr></table></figure><h2 id="二、什么是Docker"><a href="#二、什么是Docker" class="headerlink" title="二、什么是Docker"></a>二、什么是Docker</h2><p>抛开一切官方术语，以我自己的认识，简单理解一下Docker（我一直不想用Docker就是因为错误的安装教程以及晦涩的概念），官方描述看我推荐的文档</p><p>Docker 包括三个基本概念</p><ul><li><strong>镜像</strong>（<code>Image</code>）</li><li><strong>容器</strong>（<code>Container</code>）</li><li><strong>仓库</strong>（<code>Repository</code>）</li></ul><p>举两个例子去解释</p><div class="tabs" id="test"><ul class="nav-tabs"><li class="tab active"><button type="button" data-href="#test-1">QQ案例</button></li><li class="tab"><button type="button" data-href="#test-2">编程思想</button></li></ul><div class="tab-contents"><div class="tab-item-content active" id="test-1"><p>手机里从华为应用商城下载了QQ APP，登录了账号A、账号B。这里下载的软件”QQ”就是一个镜像，聊天所产生的缓存文件就是容器且账号A、B是分开存储的，仓库即华为应用商城</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div><div class="tab-item-content" id="test-2"><p>无论c、cpp、java、py都有面向对象，建立一个类，然后实例化两个对象。这里类就是一个镜像，两个实例化对象就是容器，俩个实例调用类中函数及数据互不影响。将类打包并发布到npm、pypi等等或下载别人的模块、包即仓库</p><button type="button" class="tab-to-top" aria-label="scroll to top"><i class="fas fa-arrow-up"></i></button></div></div></div><p>以上是我自己的理解，源自自己的一次实践，因为第一次使用很晦涩，我明明卸载干净了但是重装数据还在，是因为容器并没有删除</p><h2 id="三、命令"><a href="#三、命令" class="headerlink" title="三、命令"></a>三、命令</h2><blockquote><p>总结一些自己常见的或者可能用到的，方便忘记的时候查阅一些命令</p></blockquote><h3 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h3><p><code>docker pull</code>：从 <a href="https://hub.docker.com/search?q=&type=image">Docker</a> 镜像仓库获取镜像，格式：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull [选项] [Docker Registry 地址[:端口号]/]仓库名[:标签]</span><br></pre></td></tr></table></figure><ul><li>Docker 镜像仓库地址：地址的格式一般是 <code>&lt;域名/IP&gt;[:端口号]</code>。默认地址是 Docker Hub(<code>docker.io</code>)</li><li>仓库名：如之前所说，这里的仓库名是两段式名称，即 <code>&lt;用户名&gt;/&lt;软件名&gt;</code>。对于 Docker Hub，如果不给出用户名，则默认为 <code>library</code>，也就是官方镜像</li></ul><p>例子：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull ubuntu:18.04</span><br><span class="line">18.04: Pulling from library/ubuntu</span><br><span class="line">92dc2a97ff99: Pull complete</span><br><span class="line">be13a9d27eb8: Pull complete</span><br><span class="line">c8299583700a: Pull complete</span><br><span class="line">Digest: sha256:4bc3ae6596938cb0d9e5ac51a1152ec9dcac2a1c50829c74abd9c4361e321b26</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> ubuntu:18.04</span><br><span class="line">docker.io/library/ubuntu:18.04</span><br></pre></td></tr></table></figure><p>上面的命令中没有给出 Docker 镜像仓库地址，因此将会从 Docker Hub （<code>docker.io</code>）获取镜像。而镜像名称是 <code>ubuntu:18.04</code>，因此将会获取官方镜像 <code>library/ubuntu</code> 仓库中标签为 <code>18.04</code> 的镜像。<code>docker pull</code> 命令的输出结果最后一行给出了镜像的完整名称，即： <code>docker.io/library/ubuntu:18.04</code>。</p><p>从下载过程中可以看到我们之前提及的分层存储的概念，镜像是由多层存储所构成。下载也是一层层的去下载，并非单一文件。下载过程中给出了每一层的 ID 的前 12 位。并且下载结束后，给出该镜像完整的 <code>sha256</code> 的摘要，以确保下载一致性。</p><p>在使用上面命令的时候，你可能会发现，你所看到的层 ID 以及 <code>sha256</code> 的摘要和这里的不一样。这是因为官方镜像是一直在维护的，有任何新的 bug，或者版本更新，都会进行修复再以原来的标签发布，这样可以确保任何使用这个标签的用户可以获得更安全、更稳定的镜像。</p><h3 id="运行镜像"><a href="#运行镜像" class="headerlink" title="运行镜像"></a>运行镜像</h3><blockquote><p>举两个示例，基本包括了常用的所有可选参数</p></blockquote><p>例子1：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it --<span class="built_in">rm</span> ubuntu:18.04 bash</span><br><span class="line"></span><br><span class="line">root@e7009c6ce357:/<span class="comment"># cat /etc/os-release</span></span><br><span class="line">NAME=<span class="string">&quot;Ubuntu&quot;</span></span><br><span class="line">VERSION=<span class="string">&quot;18.04.1 LTS (Bionic Beaver)&quot;</span></span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">PRETTY_NAME=<span class="string">&quot;Ubuntu 18.04.1 LTS&quot;</span></span><br><span class="line">VERSION_ID=<span class="string">&quot;18.04&quot;</span></span><br><span class="line">HOME_URL=<span class="string">&quot;https://www.ubuntu.com/&quot;</span></span><br><span class="line">SUPPORT_URL=<span class="string">&quot;https://help.ubuntu.com/&quot;</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">&quot;https://bugs.launchpad.net/ubuntu/&quot;</span></span><br><span class="line">PRIVACY_POLICY_URL=<span class="string">&quot;https://www.ubuntu.com/legal/terms-and-policies/privacy-policy&quot;</span></span><br><span class="line">VERSION_CODENAME=bionic</span><br><span class="line">UBUNTU_CODENAME=bionic</span><br></pre></td></tr></table></figure><p><code>docker run</code> 就是运行容器的命令</p><ul><li><code>-it</code>：这是两个参数，一个是 <code>-i</code>：交互式操作，一个是 <code>-t</code> 终端。我们这里打算进入 <code>bash</code> 执行一些命令并查看返回结果，因此我们需要交互式终端。</li><li><code>--rm</code>：这个参数是说容器退出后随之将其删除。默认情况下，为了排障需求，退出的容器并不会立即删除，除非手动 <code>docker rm</code>。我们这里只是随便执行个命令，看看结果，不需要排障和保留结果，因此使用 <code>--rm</code> 可以避免浪费空间。</li><li><code>ubuntu:18.04</code>：这是指用 <code>ubuntu:18.04</code> 镜像为基础来启动容器。</li><li><code>bash</code>：放在镜像名后的是 <strong>命令</strong>，这里我们希望有个交互式 Shell，因此用的是 <code>bash</code>。</li></ul><p>进入容器后，我们可以在 Shell 下操作，执行任何所需的命令。这里，我们执行了 <code>cat /etc/os-release</code>，这是 Linux 常用的查看当前系统版本的命令，从返回的结果可以看到容器内是 <code>Ubuntu 18.04.1 LTS</code> 系统。</p><p>最后我们通过 <code>exit</code> 退出了这个容器。</p><p>例子2：以<code>uptime-kuma</code>这个软件为例子，获取镜像并运行</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run -d --restart=always -p 3001:3001 -v /xxxx/uptime-kuma/data:/app/data --name uptime-kuma louislam/uptime-kuma:1</span><br></pre></td></tr></table></figure><ul><li><code>-d</code>：后台运行</li><li><code>--restart=always</code>：重启docker时，自启动容器</li><li><code>-p</code>：通过<code>ip+3001</code>端口在web中访问</li><li><code>-v</code>：<code>/宿主机目录:/容器目录</code>， <code>/xxxx/uptime-kuma/data:/app/data</code>表示文件在<code>/xxxx/uptime-kuma/data</code>，如果使用相对路径则在<code>/var/lib/docker/volumes</code></li><li><code>--name</code>：指定容器名字</li><li><code>louislam/uptime-kuma:1</code>：获取的镜像名字</li></ul><p>转自<a href="https://blog.panghai.top/posts/29dc6fe8/#Docler%E9%95%9C%E5%83%8F%E5%91%BD%E4%BB%A4">Docker常用命令 | 心流</a>，其它可选参数：</p><ul><li><code>--dns 8.8.8.8</code>: 为容器指定一个dns服务器,默认与宿主一致</li><li><code>--dns-search domain</code>:为容器指定一个DNS域名,默认与宿主一致</li><li><code>-h &quot;hostname&quot;</code>: 指定容器的hostname</li><li><code>-e arg=&quot;value&quot;</code>: 设置环境变量</li><li><code>-env-file=[]</code>:从指定文件读入环境变量</li><li><code>--cpuset=&quot;0-2&quot; or --cpuset=&quot;0,1,2&quot;:</code> 绑定容器到指定的cpu运行</li><li><code>-m</code>: 设置容器使用内存最大值</li><li><code>--net=&quot;bridge&quot;</code>: 指定容器的网络连接类型,支持bridge&#x2F;host&#x2F;none&#x2F;container四种类型</li><li><code>--link=[]</code>:添加链接到另外一个容器</li><li><code>--expose=[]</code>:开放一个端口或一组端口,宿主机使用随机端口映射到开放的端口</li></ul><h3 id="列出镜像"><a href="#列出镜像" class="headerlink" title="列出镜像"></a>列出镜像</h3><p><code>docker image ls</code>、<code>docker images</code>：列出已经下载下来的镜像</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY           TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">redis                latest              5f515359c7f8        5 days ago          183 MB</span><br><span class="line">mongo                3.2                 fe9198c04d62        5 days ago          342 MB</span><br><span class="line">&lt;none&gt;               &lt;none&gt;              00285df0df87        5 days ago          342 MB</span><br><span class="line">ubuntu               18.04               329ed837d508        3 days ago          63.3MB</span><br><span class="line">ubuntu               bionic              329ed837d508        3 days ago          63.3MB</span><br></pre></td></tr></table></figure><p>列表包含了 <code>仓库名</code>、<code>标签</code>、<code>镜像 ID</code>、<code>创建时间</code> 以及 <code>所占用的空间</code>。</p><p><strong>镜像 ID</strong> 则是镜像的唯一标识，一个镜像可以对应多个 <strong>标签</strong>。因此，在上面的例子中，我们可以看到 <code>ubuntu:18.04</code> 和 <code>ubuntu:bionic</code> 拥有相同的 ID，因为它们对应的是同一个镜像</p><p>列出指定镜像<code>docker image ls [IMAGE ID]</code>、<code>docker image ls [REPOSITORY:TAG]</code></p><h3 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h3><p>ID可以只输入前三位即<strong>短ID</strong>，或者根据仓库名、标签删除</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker image <span class="built_in">rm</span> [IMAGE ID]</span><br><span class="line">$ docker image <span class="built_in">rm</span> [REPOSITORY]</span><br><span class="line">$ docker image <span class="built_in">rm</span> [REPOSITORY:TAG]</span><br></pre></td></tr></table></figure><p>小tips：docker『启动&#x2F;删除』镜像或者容器，都可以使用短id，只要可以区分唯一id就可以运行，哪怕是前一位或者前两位id</p><h3 id="操作容器"><a href="#操作容器" class="headerlink" title="操作容器"></a>操作容器</h3><p>查看容器状态（四条指令输出相同）：<code>docker container ls -a</code> 、<code>docker container ls</code>、<code>docker container ps</code>、<code>docker ps</code></p><p>终止运行中的容器：<code>docker container stop [CONTAINER ID]</code></p><p>启动已终止的容器： <code>docker container start [CONTAINER ID]</code></p><p>重启运行中的容器：<code>docker container restart [CONTAINER ID]</code></p><p>删除容器（容器未终止添加参数<code>-f</code> ）：<code>docker container rm [CONTAINER ID]</code>、<code>docker container rm [NAMES]</code></p><p>清除所有已终止的容器：<code>docker container prune</code></p><p>进入容器：<code>docker exec -it [CONTAINER ID] bash</code></p><p>查看&#x2F;修改环境变量（如果经常需要这样做，推荐使用Docker Compose）：</p><ul><li><code>vim  /var/lib/docker/containers/ID/config.v2.json</code>（json不方便查看）</li><li><code>docker inspect &lt;NAME&gt; OR &lt;ID&gt;</code></li><li>进入容器后输入：<code>export</code></li><li>进入容器后输入：<code>vim /proc/1/environ</code>（容器内没有vim编辑器，需要安装很鸡肋！）</li></ul><p>查看容器日志：<code>『docker logs [OPTIONS] CONTAINER』</code></p><ul><li><p>可选参数（翻译自<code>docker logs help</code>）：</p><ul><li><code>-f</code>，<code>--follow</code>：跟随最新输出</li><li><code>--since</code>，起始时间</li><li><code>-n</code>，<code>--tail</code>：指定行数</li><li><code>-t</code>，<code>--since</code>，<code>--until</code>：加入时间戳</li></ul></li><li><p>查看自启动所有日志：<code>docker logs [CONTAINER ID] </code></p></li><li><p>查看最近10行日志：<code>docker logs --tail 10 [CONTAINER ID]</code>、<code>docker logs [CONTAINER ID] | -n 10</code></p></li><li><p>查看最旧10行日志：<code>docker logs [CONTAINER ID] | head -n 10</code></p></li><li><p>关键字日志：<code>docker logs [CONTAINER ID] | grep 关键字</code>，可组合<code>-n</code></p></li><li><p>根据时间查看</p><ul><li>起始时间：<code>docker logs -f -t --since=&quot;2022-11-01&quot; [CONTAINER ID]</code></li><li>近30min：<code>docker logs --since 30m [CONTAINER_ID]</code></li><li>起止时间：<code>docker logs -t --since=&quot;2022-11-01T10:23:37&quot; --until &quot;2022-11-01T12:23:37&quot; [CONTAINER_ID]</code></li></ul></li></ul><p>导出某个容器到本地：<code>docker export [CONTAINER ID]</code>，例如：<code>docker export 7691a814370e &gt; ubuntu.tar</code></p><p>容器快照文件导入为镜像：<code>docker import</code></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> ubuntu.tar | docker import - <span class="built_in">test</span>/ubuntu:v1.0</span><br><span class="line">$ docker image <span class="built_in">ls</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED              VIRTUAL SIZE</span><br><span class="line"><span class="built_in">test</span>/ubuntu         v1.0                9d37a6082e97        About a minute ago   171.3 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此外，也可以通过指定 URL 或者某个目录来导入，例如</span></span><br><span class="line">$ docker import http://example.com/exampleimage.tgz example/imagerepo</span><br></pre></td></tr></table></figure><p><strong>注：用户既可以使用 <code>docker load</code> 来导入镜像存储文件到本地镜像库，也可以使用 <code>docker import</code> 来导入一个容器快照到本地镜像库。这两者的区别在于容器快照文件将丢弃所有的历史记录和元数据信息（即仅保存容器当时的快照状态），而镜像存储文件将保存完整记录，体积也要大。此外，从容器快照文件导入时可以重新指定标签等元数据信息。</strong></p><h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><p>Docker官方的另一个开源项目：<strong>『Docker Compose』</strong>，优点：</p><ul><li>相对于Docker，用户可以自定义一个多容器协同工作的容器，例如Web 服务+后端的数据库服务容器，甚至还包括负载均衡容器等</li><li>Docker容器命令仍适用Docker Compose，而<code>docker compose</code>可以在<code>docker-compose.yml</code>路径下直接输入命令，而不需要再查看容器ID或容器名称后再输入，例如<code>docker logs uptime-kuma</code>、<code>docker compose logs</code>，使用更便捷！</li><li>二次修改容器中内容时（环境变量、镜像）只需要对<code>docker-compose.yml</code>重新编辑后重启即可（越用越香，换Compose的主要原因）</li></ul><p>注：因为是简单食用，<code>docker-compose.yml</code>文件模板没有过多阐述变量属性，通常拉取镜像时作者都会附一份文件模板说明需要配置的变量，个人认为看懂会用即可。因为与docker命令用法一致，命令改为了<code>docker compose</code>所以命令部分省略了很多</p><h3 id="简单食用"><a href="#简单食用" class="headerlink" title="简单食用"></a>简单食用</h3><p>先做一个简单的例子，以上面的docker为例</p><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">docker run -d --restart=always -p 3001:3001 -v /xxxx/uptime-kuma/data:/app/data --name uptime-kuma louislam/uptime-kuma:1</span><br></pre></td></tr></table></figure><p>Docker Compose，在路径下新建<code>docker-compose.yml</code>并写入</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.6&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="comment"># 任意命名</span></span><br><span class="line">    <span class="attr">uptime-kuma:</span></span><br><span class="line">    <span class="comment"># 镜像</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">louislam/uptime-kuma:1</span></span><br><span class="line">        <span class="comment"># 容器名称</span></span><br><span class="line">        <span class="attr">container_name:</span> <span class="string">uptime-kuma</span></span><br><span class="line">        <span class="comment"># 自动重启</span></span><br><span class="line">        <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">        <span class="comment"># 挂载目录</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">/xxxx/uptime-kuma/data:/app/data</span></span><br><span class="line">        <span class="comment"># 打开的端口</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="number">3001</span><span class="string">:3001</span></span><br></pre></td></tr></table></figure><p>启动：<code>docker compose up -d</code></p><p>第二个例子</p><p><code>depends_on</code>指定先启动 <code>redis</code> <code>db</code> 再启动 <code>web</code></p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres</span></span><br></pre></td></tr></table></figure><p>第三个例子</p><p>使用 <code>context</code> 指令指定 <code>Dockerfile</code> 所在文件夹的路径。使用 <code>dockerfile</code> 指令指定 <code>Dockerfile</code> 文件名。使用 <code>arg</code> 指令指定构建镜像时的变量。</p><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">webapp:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./dir</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile-alternate</span></span><br><span class="line">      <span class="comment"># 设置共享内存2g（shared memory）</span></span><br><span class="line">      <span class="attr">shm_size:</span> <span class="string">2gb</span></span><br><span class="line">      <span class="comment"># 环境变量</span></span><br><span class="line">      <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xxx=xxx</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">xxx=xxx</span></span><br><span class="line">      <span class="attr">args:</span></span><br><span class="line">        <span class="attr">buildno:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><p>验证<code>docker-compose.yml</code>文件是否正确：<code>docker compose config</code></p><p>启动容器：<code>docker compose up -d</code>，其中<code>-d</code>指后台运行容器，不直接输出到<code>bash</code>窗口</p><p>查看日志：<code>docker compose logs</code></p><p>停止容器：<code>docker compose stop</code></p><p>启动已停止的容器：<code>docker compose start</code></p><p>重启运行中的容器：<code>docker compose restart</code></p><p>列出Compose中所有容器：<code>docker compose ps</code></p><p>列出Compose中所有镜像：<code>docker compose images</code></p><p>删除所有（停止状态的）服务容器： <code>docker compose rm [options] [SERVICE...]</code>，选项：</p><ul><li><code>-f, --force</code> 强制直接删除，包括非停止状态的容器。一般尽量不要使用该选项</li><li><code>-v</code> 删除容器所挂载的数据卷</li></ul>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</category>
      
      
      <category domain="https://zhsher.cn/tags/docker/">docker</category>
      
      
      <comments>https://zhsher.cn/posts/63200/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>有『备』无患 定时备份服务器文件方案</title>
      <link>https://zhsher.cn/posts/7884/</link>
      <guid>https://zhsher.cn/posts/7884/</guid>
      <pubDate>Fri, 28 Oct 2022 18:05:47 GMT</pubDate>
      
        
        
      <description>&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;备份最厉害的，应该就是程序员啦！小张对数据有一种恐惧，最常用的就是利用&lt;strong&gt;『Github Actions』&lt;/strong&gt;将&lt;</description>
        
      
      
      
      <content:encoded><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>备份最厉害的，应该就是程序员啦！小张对数据有一种恐惧，最常用的就是利用<strong>『Github Actions』</strong>将<strong>『本地-Github-Gitee』</strong>三端同步，甚至服务器四端同步，建站这么久，还从未想过对站点多端备份，因为认为服务器很稳定，平常只是将站点备份在服务器里方便回滚，直至10月22日晚睡前看博客的时候，发现了站点404，本以为是博客挂了，结果发现是所有的站点、应用都下线了，shell工具也链接失败，而腾讯云控制台却显示开机状态，心里一万匹草泥马慌的一批，和<a href="https://blog.panghai.top/">@心流</a>沟通后没找出问题所以重启万能大法了</p><p>之后<a href="https://blog.panghai.top/">@心流</a>在第二天晚上做了一个服务器备份方案：<a href="https://blog.panghai.top/posts/cbb5481/">使用Aligo定时备份服务器文件 | 心流</a></p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>参考文档：<a href="https://github.com/foyoux/aligo">foyoux&#x2F;aligo: 🔥简单、易用、可扩展的阿里云盘 API 接口库🚀 | Github</a></p><p>CV代码：<a href="https://blog.panghai.top/posts/cbb5481/">使用Aligo定时备份服务器文件 | 心流</a></p><p><a href="https://blog.panghai.top/">@心流</a>做的是服务器与阿里云盘中同时保留备份文件，但是我的服务器只有40G，站点一共1.3G左右，七份就9G了，寸土寸金啊！结合自己的实际情况修改如下：</p><ol><li>备份文件只存在于阿里云盘中</li><li><a href="https://blog.panghai.top/">@心流</a>删除备份文件方案中是通过<code>time</code>模块获取过期时间，拼接『过期日期+文件名字』判断阿里云盘中是否存在该文件，存在就删除。但这样存在一些bug，比如两天一备，保留七天，就巧妙的避开了删除的日子，同时避免服务器<del>再次死机</del>导致某天没有按计划运行那么就永远不会删除，所以我改逻辑为遍历判断阿里云盘中文件时间（从文件名中提取，Aligo中不存在文件信息接口）小于当前时间则删除</li></ol><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> aligo <span class="keyword">import</span> Aligo</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VPSBackup</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, Aligo</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        初始化 阿里云登录用户</span></span><br><span class="line"><span class="string">        :param Aligo: 阿里云盘</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.ali = Aligo</span><br><span class="line">        self.remote_folder = ali.get_folder_by_path ( upload_dir )</span><br><span class="line">        self.upload ()</span><br><span class="line">        self.delete ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compress</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        将需要备份的目录依次压缩并保存至 tmp 下</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="number">0</span>, <span class="built_in">len</span> ( compress_name_list ) ):</span><br><span class="line">            zip_file = compress_dir + <span class="string">&#x27;/&#x27;</span> + t + <span class="string">&quot;-&quot;</span> + compress_name_list[ i ]</span><br><span class="line">            <span class="built_in">zip</span> = zipfile.ZipFile ( zip_file, <span class="string">&#x27;w&#x27;</span>, zipfile.ZIP_DEFLATED )</span><br><span class="line">            <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> os.walk ( backup_dir_list[ i ] ):  <span class="comment"># 遍历统计</span></span><br><span class="line">                <span class="keyword">for</span> each <span class="keyword">in</span> files:</span><br><span class="line">                    <span class="keyword">if</span> os.path.exists ( root + <span class="string">&quot;/&quot;</span> + each ):</span><br><span class="line">                        <span class="built_in">zip</span>.write ( root + <span class="string">&quot;/&quot;</span> + each )</span><br><span class="line">            <span class="built_in">zip</span>.close ()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getFile</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        获取阿里云盘指定目录下所有备份文件</span></span><br><span class="line"><span class="string">        :return: zip_file_list 列表</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        zip_file_list = [ ]</span><br><span class="line">        <span class="built_in">list</span> = ali.get_file_list ( self.remote_folder.file_id )  <span class="comment"># 获取网盘根目录文件列表</span></span><br><span class="line">        <span class="comment"># 遍历文件列表</span></span><br><span class="line">        <span class="keyword">for</span> file <span class="keyword">in</span> <span class="built_in">list</span>:</span><br><span class="line">            tmp = &#123;<span class="string">&#x27;file_id&#x27;</span>: file.file_id, <span class="string">&#x27;file_name&#x27;</span>: file.name&#125;</span><br><span class="line">            zip_file_list.append ( tmp )</span><br><span class="line">        <span class="keyword">return</span> zip_file_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">upload</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        将 tmp 下的压缩包上传</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        self.compress ()  <span class="comment"># 压缩</span></span><br><span class="line">        file_list = os.listdir ( compress_dir )  <span class="comment"># 压缩文件夹中的文件列表</span></span><br><span class="line">        <span class="comment"># 拼接相对路径</span></span><br><span class="line">        <span class="built_in">print</span> ( file_list )</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> ( <span class="number">0</span>, <span class="built_in">len</span> ( file_list ) ):</span><br><span class="line">            file_list[ i ] = os.path.join ( compress_dir, file_list[ i ] )</span><br><span class="line">        <span class="comment"># 批量上传压缩后的文件列表</span></span><br><span class="line">        ali.upload_files ( file_list, parent_file_id=self.remote_folder.file_id )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        删除阿里云盘中过期的压缩包 以及 本地 tmp 临时压缩包</span></span><br><span class="line"><span class="string">        &#x27;&#x27;&#x27;</span></span><br><span class="line">        zip_file_list = self.getFile ()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> zip_file_list:</span><br><span class="line">            <span class="keyword">if</span> (i[ <span class="string">&#x27;file_name&#x27;</span> ][ <span class="number">0</span>:<span class="number">10</span> ] &lt; t_be):</span><br><span class="line">                ali.move_file_to_trash ( i[ <span class="string">&#x27;file_id&#x27;</span> ] )</span><br><span class="line">        shutil.rmtree ( compress_dir )  <span class="comment"># 删掉 tmp 临时文件夹</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    依次填写</span></span><br><span class="line"><span class="string">        ali：登录阿里云盘</span></span><br><span class="line"><span class="string">        backup_dir_list：需要备份的文件夹路径</span></span><br><span class="line"><span class="string">        compress_name_list：压缩包命名</span></span><br><span class="line"><span class="string">        upload_dir：阿里云盘上传路径</span></span><br><span class="line"><span class="string">        day：压缩包保留天数</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="comment"># 登录信息存放在 &lt; 用户家目录 &gt;/.aligo/&lt; name &gt;.json中</span></span><br><span class="line">    <span class="comment"># ali = Aligo () # 方式一，扫码登录</span></span><br><span class="line">    <span class="comment"># ali = Aligo ( refresh_token=&#x27;&lt;refresh_token&gt;&#x27; ) # 方式二，从 网页控制台-&gt;应用 获取 token</span></span><br><span class="line">    ali = Aligo ( email=(<span class="string">&#x27;1310446718@qq.com&#x27;</span>, <span class="string">&#x27;haivhisaofwu1920u90du90&#x27;</span>) )  <span class="comment"># 方式三，发送邮箱，邮箱+随机定义一个字符串</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 备份目录路径数组</span></span><br><span class="line">    backup_dir_list = [</span><br><span class="line">        <span class="string">&#x27;D:\Git repo\新建文件夹\_posts\测试1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;D:\Git repo\新建文件夹\_posts\测试2&#x27;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 压缩包文件名数组与 backup_dir_list 一一对应</span></span><br><span class="line">    compress_name_list = [</span><br><span class="line">        <span class="string">&#x27;测试1.zip&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;测试2.zip&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">    <span class="comment"># 阿里云盘上传路径</span></span><br><span class="line">    upload_dir = <span class="string">&#x27;Alist/Backup&#x27;</span></span><br><span class="line">    <span class="comment"># 压缩包保存多少天</span></span><br><span class="line">    day = <span class="number">7</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 临时压缩包路径</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir ( <span class="string">&#x27;tmp&#x27;</span> )</span><br><span class="line">    <span class="keyword">except</span> FileExistsError <span class="keyword">as</span> e:</span><br><span class="line">        e = <span class="built_in">str</span> ( e )</span><br><span class="line">        <span class="built_in">print</span> ( <span class="string">&quot;error:&quot;</span> + e )</span><br><span class="line">        <span class="built_in">print</span> ( <span class="string">&#x27;文件夹重名，请将现有tmp文件夹移除或按任意键继续&#x27;</span> )</span><br><span class="line">        os.system ( <span class="string">&#x27;pause&#x27;</span> )</span><br><span class="line">    compress_dir = <span class="string">&#x27;tmp&#x27;</span></span><br><span class="line"></span><br><span class="line">    t = time.strftime ( <span class="string">&quot;%Y-%m-%d&quot;</span>, time.localtime () )</span><br><span class="line">    t_be = (datetime.datetime.now () - datetime.timedelta ( days=day - <span class="number">1</span> )).strftime ( <span class="string">&quot;%Y-%m-%d&quot;</span> )</span><br><span class="line"></span><br><span class="line">    back = VPSBackup ( ali )</span><br></pre></td></tr></table></figure><p>运行一遍测试代码，无误后做定时：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim /etc/crontab</span><br><span class="line">2 0 * * * root python3 /home/ubuntu/myself/Alist/VPS Backup.py<span class="comment"># 0:02</span></span><br><span class="line"><span class="built_in">chmod</span> 777 /home/ubuntu/myself/Alist/VPS Backup.py <span class="comment"># 不是root用户需要修改.py文件权限</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>被<a href="https://blog.panghai.top/">@心流</a>种草了阿里云盘，速度很nice！比某度好很多，以及<a href="https://github.com/alist-org/alist">alist-org&#x2F;alist | Github</a>网盘挂载工具，之前<strong>『Cloudreve』</strong>仅支持本地挂载方式，局限于服务器带宽与容量，但Alist支持多云盘挂载，完美解决<strong>『Cloudreve』</strong>局限性，也更好的管理备份或文件分享</p><p>2001年9月11日，在震惊全球的“9·11事件”中，假如位于美国纽约世界贸易中心的公司都有妥善的备份和容灾方案，那么就不会有事件之后大量公司关门的情况出现，之后的东航、马航事件黑匣子更是起到了关键作用。有『备』无患， <strong><code>DON&#39;T BE AN APRIL FOOL. Be prepared. Back up your files on March 31st</code></strong></p>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</category>
      
      
      <category domain="https://zhsher.cn/tags/Python/">Python</category>
      
      <category domain="https://zhsher.cn/tags/%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD/">数据备份</category>
      
      
      <comments>https://zhsher.cn/posts/7884/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>Lsky图床迁入方案</title>
      <link>https://zhsher.cn/posts/45734/</link>
      <guid>https://zhsher.cn/posts/45734/</guid>
      <pubDate>Thu, 27 Oct 2022 08:04:08 GMT</pubDate>
      
        
        
      <description>&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&quot;https://7bu.top/&quot;&gt;去不图床&lt;/a&gt;适用方案一（已过时，参考方案三），自建图床适用方案二，最佳方案三适用多种情况&lt;/p&gt;
&lt;p&gt;原理不难，自己第一次写，出了一些意外所以着重记录为笔记&lt;/p&gt;
&lt;/blockquot</description>
        
      
      
      
      <content:encoded><![CDATA[<blockquote><p><a href="https://7bu.top/">去不图床</a>适用方案一（已过时，参考方案三），自建图床适用方案二，最佳方案三适用多种情况</p><p>原理不难，自己第一次写，出了一些意外所以着重记录为笔记</p></blockquote><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>因为先前一直在使用兰空图床，<a href="https://blog.panghai.top/">@心流</a>问我大量图片如何迁入。回想当时一千多张图片，按不同路径，我是一点一点用picgo拖进去的，但是picgo有最大上传限制50张。翻了翻文档，貌似接口可以做一个，以前没做过，所以尝试一下喽（这也是写这篇的原因，重点是学习实践，如果你是自建图床，直接去看心流的方案，方案一对自建来说有点脱裤子放屁，不是最佳方案）</p><p>参考：<a href="https://7bu.top/page/api-docs.html">接口文档</a></p><p>第三方支持：因为之前卸载了图床，懒得搭建了，所以买了一个<a href="https://7bu.top/">去不图床</a>做测试用，对于没有服务器的同学有一个稳定的图床挺合适的（10r一年贵么？饭钱罢了）</p><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>思路：大众使用本地存储的图库一般策略是<strong>『..&#x2F;img&#x2F;Lsky图床迁入方案&#x2F;01.png』</strong>，即用文件夹去分类每篇文章的图片（也许是其它方式的分类但一定有一个统一的前缀而不是一概的塞入一个文件夹里），那么我们想要将图片上传后，保持图片文件夹路径<strong>『&#x2F;Lsky图床迁入方案&#x2F;01.png』</strong>，仅批量替换文章中<strong>『..&#x2F;img』</strong>为域名<strong>『xxx.cn』</strong>即可以访问图片资源</p><p>小tip：替换文件夹中所有文章的图片地址前缀，可以巧用VScode，<kbd>ctrl</kbd>+<kbd>shift</kbd>+<kbd>f</kbd>全局替换所有md文件中的字符</p><h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><blockquote><p>优点：适用购买的兰空构建的图床（自建图床也可以但是方法二更好），用户不能直接对服务器操作，但有批量上传的需求，如去不图床与清酒图床</p><p>缺点：不能使用思路中的方案，图片路径将变为<strong>『域名+日期+uid』</strong>。例如<code>https://bu.dusays.com/2022/10/23/6354e790488fa.png</code>。且此问题无解，每次上传前需要修改角色组中的路径命名规则为图片所在文件夹名称如<strong>『Lsky图床迁入方案』</strong>，而这需要管理员权限</p></blockquote><p>根据接口文档，先上传一张图片试试，正确填写13~15行，运行代码检查一下py模块是否存在？token、url是否正确？网页端是否正确上传？（切记勿开代理，否则报错<code>Cannot connect to proxy</code>）</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@Author:张时贰</span></span><br><span class="line"><span class="string">@Date:2022年10月21日</span></span><br><span class="line"><span class="string">@CSDN:张时贰</span></span><br><span class="line"><span class="string">@Blog:zhsher.cn</span></span><br><span class="line"><span class="string">@Function:上传单张图片测试</span></span><br><span class="line"><span class="string">@request请求：https://blog.csdn.net/m0_37737957/article/details/123843265</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">token = <span class="string">&#x27;Bearer 335|aatlbU9CTHKKbemsTXxB7F2uSd2PXL3m7By5uD7i&#x27;</span>  <span class="comment"># token Bearer+空格+token</span></span><br><span class="line">url = <span class="string">&#x27;https://7bu.top/api/v1/upload&#x27;</span>  <span class="comment"># 图床地址 域名/api/v1/upload&#x27;</span></span><br><span class="line">path = <span class="string">&#x27;test/background.png&#x27;</span>  <span class="comment"># 图片路径</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="comment"># &quot;Content-Type&quot;: &quot;multipart/form-data&quot;, # 文档声明中必须有改字段，但是程序无法运行，详见github.com/lsky-org/lsky-pro/issues/403</span></span><br><span class="line">    <span class="string">&quot;Authorization&quot;</span>: token,</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    files = &#123;</span><br><span class="line">        <span class="string">&quot;file&quot;</span>: (<span class="string">&#x27;file.png&#x27;</span>, <span class="built_in">open</span> ( path, <span class="string">&#x27;rb&#x27;</span> ).read (), <span class="string">&#x27;image/png&#x27;</span>)  <span class="comment"># 加个read方法，之后使用os不会造成资源占用</span></span><br><span class="line">    &#125;</span><br><span class="line">    json = &#123;</span><br><span class="line">        <span class="comment"># &quot;album_id&quot;: 188  # 相册ID Int</span></span><br><span class="line">        <span class="comment"># 如果你不是图床的搭建者，以下值请忽略</span></span><br><span class="line">        <span class="comment"># &quot;strategy_id&quot;:      # 存储策略 Int</span></span><br><span class="line">        <span class="comment"># 以下参数为企业版</span></span><br><span class="line">        <span class="comment"># &quot;permission&quot;: 0     # 权限 Int 1=公开，0=私有 默认0</span></span><br><span class="line">        <span class="comment"># &quot;expired_at&quot;:       # 过期时间 String &#x27;yyyy-MM-dd HH:mm:ss&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post ( url, data=json, files=files, headers=headers )</span><br><span class="line">    r.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">    <span class="built_in">print</span> ( r.json () )</span><br><span class="line">    os.remove ( path )</span><br></pre></td></tr></table></figure><p>接下来是完整代码，根据注释说明正确填写59~69行，其中<code>path</code>为图片备份路径！服务器自建的，把上传频率设大一点，如果你是购买的杜老师的去不图床，每分钟上传频率与购买订阅有关，具体在仪表盘中查看</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@Author:张时贰</span></span><br><span class="line"><span class="string">@Date:2022年10月21日</span></span><br><span class="line"><span class="string">@CSDN:张时贰</span></span><br><span class="line"><span class="string">@Blog:zhsher.cn</span></span><br><span class="line"><span class="string">@Function:批量上传图片</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_files</span>(<span class="params">path, all_files</span>):</span><br><span class="line">    <span class="comment"># 首先遍历当前目录所有文件及文件夹</span></span><br><span class="line">    file_list = os.listdir ( path )</span><br><span class="line">    <span class="comment"># 准备循环判断每个元素是否是文件夹还是文件，是文件的话，把名称传入list，是文件夹的话，递归</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> file_list:</span><br><span class="line">        <span class="comment"># 利用os.path.join()方法取得路径全名，并存入cur_path变量，否则每次只能遍历一层目录</span></span><br><span class="line">        cur_path = os.path.join ( path, file )</span><br><span class="line">        <span class="comment"># 判断是否是文件夹</span></span><br><span class="line">        <span class="keyword">if</span> os.path.isdir ( cur_path ):</span><br><span class="line">            show_files ( cur_path, all_files )</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            all_files.append ( file )</span><br><span class="line">            <span class="keyword">if</span> file.endswith ( (<span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>, <span class="string">&#x27;.tif&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.ico&#x27;</span>, <span class="string">&#x27;.psd&#x27;</span>, <span class="string">&#x27;.webp&#x27;</span>) ):</span><br><span class="line">                end = (os.path.splitext ( file )[ -<span class="number">1</span> ])</span><br><span class="line">                end = end.replace ( <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;&#x27;</span> )  <span class="comment"># 获取后缀</span></span><br><span class="line">                files = &#123;</span><br><span class="line">                    <span class="string">&quot;file&quot;</span>: (file, <span class="built_in">open</span> ( cur_path, <span class="string">&#x27;rb&#x27;</span> ).read (), <span class="string">&#x27;image/&#x27;</span> + end)  <span class="comment"># 加个read方法，之后使用os不会造成资源占用</span></span><br><span class="line">                &#125;</span><br><span class="line">                r = requests.post ( url, data=json, files=files, headers=headers )</span><br><span class="line">                r.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">                <span class="built_in">print</span> ( r.json () )</span><br><span class="line">                <span class="comment"># 去不图床仪表盘显示每分钟是200张请求，一次性上传多张图片，会出现上传失败</span></span><br><span class="line">                <span class="comment"># 解决办法：每成功上传一张就删除一张（如果代码中断可以反复运行上传剩余图片直至所有图片上传完成），额外加一个sleep，超出频率就歇一会</span></span><br><span class="line">                <span class="keyword">while</span> <span class="keyword">not</span> r.json ()[ <span class="string">&#x27;status&#x27;</span> ]:</span><br><span class="line">                    <span class="built_in">print</span> ( <span class="string">&#x27;小歇一下叭&#x27;</span> )</span><br><span class="line">                    time.sleep ( <span class="number">60</span> )</span><br><span class="line">                    <span class="built_in">print</span> ( <span class="string">&#x27;开干开干&#x27;</span> )</span><br><span class="line">                    r = requests.post ( url, data=json, files=files, headers=headers )</span><br><span class="line">                    r.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">                    <span class="built_in">print</span> ( r.json () )</span><br><span class="line">                <span class="built_in">print</span> ( <span class="string">&#x27;删除 &#x27;</span> + cur_path )</span><br><span class="line">                os.remove ( cur_path )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> all_files</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">        必填：</span></span><br><span class="line"><span class="string">            token：兰空的 token</span></span><br><span class="line"><span class="string">            url：域名/api/v1/upload</span></span><br><span class="line"><span class="string">            path：图片文件夹</span></span><br><span class="line"><span class="string">        选填 json 参考注释</span></span><br><span class="line"><span class="string">        请将本地文件夹备份，path=备份路径，原因详见35~36</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    token = <span class="string">&#x27;Bearer 335|aatlbU9CTHKKbemsTXxB7F2uSd2PXL3m7By5uD7i&#x27;</span>  <span class="comment"># token Bearer+空格+token</span></span><br><span class="line">    url = <span class="string">&#x27;https://7bu.top/api/v1/upload&#x27;</span>  <span class="comment"># 图床地址 域名/api/v1/upload</span></span><br><span class="line">    path = <span class="string">&#x27;test&#x27;</span>  <span class="comment"># 图片文件夹路径，图片可以嵌套多个文件夹</span></span><br><span class="line">    json = &#123;</span><br><span class="line">        <span class="comment"># &quot;album_id&quot;: 188  # 相册ID Int</span></span><br><span class="line">        <span class="comment"># 如果你不是图床的搭建者，以下值请忽略</span></span><br><span class="line">        <span class="comment"># &quot;strategy_id&quot;:      # 存储策略 Int</span></span><br><span class="line">        <span class="comment"># 以下参数为企业版</span></span><br><span class="line">        <span class="comment"># &quot;permission&quot;: 0     # 权限 Int 1=公开，0=私有 默认0</span></span><br><span class="line">        <span class="comment"># &quot;expired_at&quot;:       # 过期时间 String &#x27;yyyy-MM-dd HH:mm:ss&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="comment"># &quot;Content-Type&quot;: &quot;multipart/form-data&quot;, # 文档声明中必须有改字段，但是程序无法运行，详见github.com/lsky-org/lsky-pro/issues/403</span></span><br><span class="line">        <span class="string">&quot;Authorization&quot;</span>: token,</span><br><span class="line">        <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    contents = show_files ( path, [ ] )  <span class="comment"># 参数一传入所有文章存在的目录</span></span><br></pre></td></tr></table></figure><h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><blockquote><p>优点：对自建十分友好，直接上传文件夹即可，方法简单粗暴，三个方案中最快！往后的图片使用新的用户策略上传</p><p>缺点：仅支持自建的兰空图床</p><p>转自<a href="https://blog.panghai.top/posts/d71ca461/">兰空图床使用体验以及图床迁移解决方案 | 心流</a></p></blockquote><p>首先在 <code>/www/lskypro/storage/app/uploads</code> 上传本地的 img 文件夹（心流这个思路很巧，直接对网站根路径访问，我当时怎么就没想到呢，一直在想图片塞一个位置然后数据库里图片路径的数据怎么写，更没有想接口…）</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/Lsky%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA/Lsky%E5%9B%BE%E5%BA%8A%E8%BF%81%E5%85%A5%E6%96%B9%E6%A1%8801.png" alt="Lsky图床迁入方案01"></p><p>测试访问</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/Lsky%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA/Lsky%E5%9B%BE%E5%BA%8A%E8%BF%81%E5%85%A5%E6%96%B9%E6%A1%8803.png" alt="Lsky图床迁入方案03"></p><p>修改文件夹所有者以及文件权限：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">chown</span> -R 33 /www/lskypro/storage/app/uploads/img/</span><br><span class="line"><span class="built_in">chmod</span> -R 700 /www/lskypro/storage/app/uploads/img/</span><br></pre></td></tr></table></figure><p>创建一个储存策略，其中储存路径是 <code>/var/www/html/storage/app/uploads/img</code>，最后的 img 就是上传服务器的图片文件夹名称，例如<code>../img/xxxx/xxx.png</code></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/Lsky%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA/Lsky%E5%9B%BE%E5%BA%8A%E8%BF%81%E5%85%A5%E6%96%B9%E6%A1%8802.png" alt="Lsky图床迁入方案02"></p><p>在 vscode 一键替换这些图片链接即可</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/Lsky%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA/Lsky%E5%9B%BE%E5%BA%8A%E8%BF%81%E5%85%A5%E6%96%B9%E6%A1%8804.png" alt="Lsky图床迁入方案04"></p><p>新建文章时可在角色组编辑上传路径为文章链接即图片分类的文件夹名字，例如<code>../img/d71ca461/xxx.png</code>见下图。如果 CDN 没了或者链接失效，可以立即回滚到原方案</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/Lsky%E5%9B%BE%E5%BA%8A%E6%90%AD%E5%BB%BA/Lsky%E5%9B%BE%E5%BA%8A%E8%BF%81%E5%85%A5%E6%96%B9%E6%A1%8805.png" alt="Lsky图床迁入方案05"></p><h2 id="方案三"><a href="#方案三" class="headerlink" title="方案三"></a>方案三</h2><blockquote><p>方案三源自杜老师推荐博文：<a href="https://imcbc.cn/202205/aboutpicvt/">图床转换工具-picvt - Bing’s Blog</a>，奈何兰空进行了一次大更，方案不适配了，本来想在方案一的基础上改进来，但是它（即优点）这么好用！所以…找了bug问题向<a href="https://imcbc.cn/">@Bing</a>大佬催更了一下😄</p><p>优点：适用购买图床与自建图床，多平台适配，适用路过图床迁移Github，Github迁移本地，本地迁移去不图床，且在上传图片的同时，将md中的图片链接更换</p><p>缺点：没有缺点即它的缺点！</p></blockquote><p>下载作者源码：<a href="https://github.com/caibingcheng/picvt">caibingcheng&#x2F;picvt: 图传切换工具 (github.com)</a>，从本地迁移到去不图床：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/caibingcheng/picvt.git</span><br><span class="line"><span class="built_in">cd</span> picvt</span><br><span class="line">python3 ./picvt.py -D /home/ubuntu/picvt/blog/ -F <span class="built_in">local</span> -T 7bu --path /home/ubuntu/picvt/blog/ --user 1310446718@qq.com --token aatlbU9CTHKKbemsTXxB7F2uSd2PXL3m7By5uD7i</span><br></pre></td></tr></table></figure><p>其中<code>-D /home/ubuntu/picvt/blog/</code>表示存放md的文件夹，图片在<code>blog/img</code>下，文章中图片格式为：</p><ul><li><code>![image-20220116151940879](/img/xxx/xxx02.png)</code></li><li><code>![image-20220116151940879](img/xxx/xxx02.png)</code></li></ul><p>所以<code>-F local -T 7bu --path /home/ubuntu/picvt/blog/ </code>表示图片路径</p><p><code>--user 1310446718@qq.com --token aatlbU9CTHKKbemsTXxB7F2uSd2PXL3m7By5uD7i</code>表示图床用户名与token</p><p>感谢<a href="https://imcbc.cn/">@Bing</a>提供的开源工具，解读代码学到了好多东西！</p><h2 id="附获取相册ID"><a href="#附获取相册ID" class="headerlink" title="附获取相册ID"></a>附获取相册ID</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">@Author:张时贰</span></span><br><span class="line"><span class="string">@Date:2022年10月21日</span></span><br><span class="line"><span class="string">@CSDN:张时贰</span></span><br><span class="line"><span class="string">@Blog:zhsher.cn</span></span><br><span class="line"><span class="string">@Function:查看相册ID</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">token = <span class="string">&#x27;Bearer 335|aatlbU9CTHKKbemsTXxB7F2uSd2PXL3m7By5uD7i&#x27;</span>  <span class="comment"># token，Bearer+空格+token</span></span><br><span class="line">url = <span class="string">&#x27;https://7bu.top/api/v1/albums&#x27;</span>  <span class="comment"># 图床地址 域名/api/v1/albums</span></span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;multipart/form-data&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Authorization&quot;</span>: token,</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;application/json&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    r = requests.get ( url, headers=headers )</span><br><span class="line">    r.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">    getJson = r.json ()[ <span class="string">&#x27;data&#x27;</span> ][ <span class="string">&#x27;data&#x27;</span> ]</span><br><span class="line">    photoID = [ ]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> getJson:</span><br><span class="line">        tmp = &#123;<span class="string">&#x27;id&#x27;</span>: i[ <span class="string">&#x27;id&#x27;</span> ],</span><br><span class="line">               <span class="string">&#x27;name&#x27;</span>: i[ <span class="string">&#x27;name&#x27;</span> ]&#125;</span><br><span class="line">        photoID.append ( tmp )</span><br><span class="line">    <span class="comment"># print ( json.dumps(photoID,indent=4, ensure_ascii=False) )</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> photoID:</span><br><span class="line">        <span class="built_in">print</span> ( i )</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>自己也迁移过了多次，图片一定要做好分类有一个文件夹的前缀方便后续迁移。无服务器方案包括Gitee（已被Gitee用户规则禁止）、Github套jsdelivr的各种cdn（太容易挂了）、帮<a href="https://luomengguo.top/">@梦想高地</a>搭建npm图床，还挺稳的，服务器方案包括兰空、Github Actions推送至服务器站点下（现在的策略）</p><p>虽然我已经不用兰空了，发这篇文章不仅是分享，更多的是记录自己的代码学习笔记</p><p>起初根据文档，我的request是这样写的，会报错『’album id’必须是一个数字』，但是输出<code>type(data[ &quot;album_id&quot; ])</code>就是int？</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">files = &#123;</span><br><span class="line">    <span class="string">&quot;file&quot;</span>: (<span class="string">&#x27;file.png&#x27;</span>, <span class="built_in">open</span> ( path, <span class="string">&#x27;rb&#x27;</span> ), <span class="string">&#x27;image/png&#x27;</span>),</span><br><span class="line">    <span class="string">&quot;album_id&quot;</span>: <span class="number">188</span>  <span class="comment"># 相册ID Int</span></span><br><span class="line">    <span class="comment"># 如果你不是图床的搭建者，以下值请忽略</span></span><br><span class="line">    <span class="comment"># &quot;strategy_id&quot;:      # 存储策略 Int</span></span><br><span class="line">    <span class="comment"># 以下参数为企业版</span></span><br><span class="line">    <span class="comment"># &quot;permission&quot;: 0     # 权限 Int 1=公开，0=私有 默认0</span></span><br><span class="line">    <span class="comment"># &quot;expired_at&quot;:       # 过期时间 String &#x27;yyyy-MM-dd HH:mm:ss&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.post ( url, files=files, headers=headers )</span><br><span class="line">r.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line"><span class="built_in">print</span> ( r.json () )</span><br></pre></td></tr></table></figure><p>后经<a href="https://thiscute.world/">@二花</a>指点说<strong>『requests 有三个 payload 参数：json、data、files，功能都不一样，注意区分，就记住 files 跟 data 是两个物种，不能放一起』</strong>（先前看了一些request教程，都没有提到过files，我就给塞到一个字典数据里了…，尝试搜了好多报错也没有找到）</p><p>之后再带着二花的指点，二次学习：data和json的本质区别是提交的形式不同，data是表单形式，json就默认json，在head指定<code>content-type=application/json</code>可以修改data的形式，所以我的代码中data实际上传的是一个json数据</p><p>谢谢<a href="https://thiscute.world/">@二花</a>叕帮我解决疑问😁</p>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</category>
      
      
      <category domain="https://zhsher.cn/tags/%E5%9B%BE%E5%BA%8A/">图床</category>
      
      
      <comments>https://zhsher.cn/posts/45734/#disqus_thread</comments>
      
    </item>
    
    <item>
      <title>2022 09 29 致DT编程社的一封信</title>
      <link>https://zhsher.cn/posts/26324/</link>
      <guid>https://zhsher.cn/posts/26324/</guid>
      <pubDate>Thu, 29 Sep 2022 15:46:40 GMT</pubDate>
      
        
        
      <description>&lt;blockquote&gt;
&lt;p&gt;这周受&lt;a href=&quot;https://blog.juncikeji.xyz/&quot;&gt;@萌新源&lt;/a&gt;邀请，为惠安高级中学的DT编程社讲一堂课，原本是讲一节编程入门，但我不想急于求成，更希望大家建立自己的学习目标，之后在入门上，先对编程有一个好的理解，</description>
        
      
      
      
      <content:encoded><![CDATA[<blockquote><p>这周受<a href="https://blog.juncikeji.xyz/">@萌新源</a>邀请，为惠安高级中学的DT编程社讲一堂课，原本是讲一节编程入门，但我不想急于求成，更希望大家建立自己的学习目标，之后在入门上，先对编程有一个好的理解，故写此文记录。PS：上一次讲课还是小学支教，写这篇文章也是防止到时候紧张到不知道讲啥</p></blockquote><h2 id="致DT编程社的一封信"><a href="#致DT编程社的一封信" class="headerlink" title="致DT编程社的一封信"></a>致DT编程社的一封信</h2><h3 id="第一章之客套篇"><a href="#第一章之客套篇" class="headerlink" title="第一章之客套篇"></a>第一章之客套篇</h3><p>『来而不往，非礼也』</p><p>前面听了大家的自我介绍，我也客套一下，大家好，我是来自山西某高校的一位学生，修读计算机科学与技术专业。22岁，比你们大6岁。和张思源也认识一段时间了，很荣幸能够给向我小这么多岁的弟弟妹妹授一节课，而这篇文章构思了一周，但也不知道从何讲起、如何称呼你们。原计划是授一节CPP入门，但我更希望你们第一节课能够简单的认识计算机，对计算机产生兴趣，更利于日后的学习</p><h3 id="第二章之停止抱怨"><a href="#第二章之停止抱怨" class="headerlink" title="第二章之停止抱怨"></a>第二章之停止抱怨</h3><p>『既来之，则安之』</p><p>在开始之前，谈谈题外话。相信肯定有一部分人会不满于中考分数，抱怨没有设备，抱怨社团提供的资源少…，开枪没有回头马，这只不过是人生的极小一部分罢了，抱怨不会解决实际问题。何不放手一搏，学好文化课，用实力去改变现状，在大学有更好的社团资源与学习环境（记得放一下视频）</p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E6%97%A5%E8%AE%B0/%E6%97%A5%E8%AE%B016.png" alt="日记16"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E6%97%A5%E8%AE%B0/%E6%97%A5%E8%AE%B017.png" alt="日记17"></p><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E6%97%A5%E8%AE%B0/%E6%97%A5%E8%AE%B018.png" alt="日记18"></p><p>以我为例，我高考失利但由于家庭原因没有二战，但既然自己认为是失利那就拿出实力证明自己。大一修读安全工程，业余时间学习制图、建模、车铣、激光切割…，原本也是有朝这个方向的计划，大二知道有政策，所以借助考试成绩向学校申请转到计算机，因为要补修10门先修课，刚开始是很吃力的，所以借助网络资源自学补完了先修课</p><p>失败，只是弱者的表现，强者在哪都强，在新班级成绩也靠前，之后感觉一切都值得了，因为找到了自己的热爱！</p><h3 id="第三章之设备篇"><a href="#第三章之设备篇" class="headerlink" title="第三章之设备篇"></a>第三章之设备篇</h3><p>『工欲善其事,必先利其器』</p><p>相信大家都是带着好奇与向往来的编程社，但一定有很多人没有电脑。那如何解决呢？</p><ol><li>利用现有资源：平板， 也可以作为入门编程的工具，有很多适配的编译器</li><li>买树莓派：400RMB左右，只需要连接电视即可作为电脑使用</li><li>买电脑&#x2F;平板：平板，1000左右可以考虑二手，电脑，3000~7000，买电脑切记两点<ul><li>不要追求新款，电脑更新换代快而并没有太大的改变，我的电脑是20年五一买的19款</li><li>不要贪便宜但要合理<strong>贪便宜</strong>，不要贪图赠品，最便宜的可能是最贵的，线下实体店往往杀熟提高价格。在节假日通过京东、淘宝的专卖店与自营店有折扣时购入</li></ul></li></ol><p>如果以上都不满足，也不要作为心里负担，当下的主要任务是学好文化课，编程只是你们的附加分</p><h3 id="第四章之如何入门"><a href="#第四章之如何入门" class="headerlink" title="第四章之如何入门"></a>第四章之如何入门</h3><p>『欲速则不达，见小利则大事不成』</p><p>题外话：如果对打字不熟悉，通过<a href="https://www.keybr.com/">Typing Practice</a>练习，与常规打字软件不同，更趋向于形成肌肉记忆</p><p>入门编程，我希望大家能够从简单的入门开始，而不是好高骛远，一开始就定一个很高的目标，这样很容易劝退自己</p><p>推荐语言（难度由简到易）：</p><ul><li>HTML：超文本标记语言，没有编程逻辑，我们平常的网页都是HTML做的，具有可视化的编程结果，容易产生成就感与兴趣</li><li>Python：代码像是阅读英语，简单易学，第三方库多所以功能『很强大』，比如爬虫、社长的机器人</li><li>JAVA：吸收C++语言的各种优点，摒弃了C++里难以理解的多继承、指针等，广泛应用于桌面、服务器、嵌入式环境、Web等</li><li>C++：知识多偏难但建议作为自己学习的第一门语言，通过继承、多态等能够更好的理解编程思想，例如学会C++面向对象后可以间接学会JAVA、Python，因为已经掌握了很多名词、思想等，再学其它语言都很容易上手</li></ul><p>如何去学习？自学！包括张思源和我自己，两个不同年龄的人都是自学，更从侧面反应出计算机是建立在个人兴趣与能力之上的。在学习过程中，最好有自己的笔记（typora），并做到边看边敲代码，如果有自己的博客再好过（私建或借助平台），利用博客可以制作自己的知识库，跟更多的人交换信息（比如自己有错误，或者他人有好的建议）</p><p>学习平台（但不限于平台，可以买实体书籍）：</p><ul><li>Web学习：<a href="https://developer.mozilla.org/zh-CN/docs/Web">Web 开发技术</a></li><li>综合性文档平台：<a href="https://www.w3school.com.cn/">w3school</a>、<a href="https://www.runoob.com/">菜鸟教程</a></li><li>视频教程：B站黑马程序员、尚硅谷</li><li>高校视频平台：<a href="https://www.icourse163.org/">中国大学MOOC(慕课)</a></li></ul><p>自学时遇到困难怎么办？</p><ul><li>根据报错提示信息，尝试自己解决</li><li>善于搜集信息：<a href="baidu.com">百度</a>（资源参差不齐不建议）<a href="google.com">谷歌</a>或<a href="bing.com">必应</a>（资源比百度优质，谷歌进不去可以拿bing替代）、<a href="https://www.csdn.net/">CSDN</a>（入门学习首推）、<a href="https://www.cnblogs.com/">博客园</a>、<a href="https://www.oschina.net/">开源中国</a>、<a href="https://stackoverflow.com/">Stack Overflow</a>（全英文平台，可作为进阶使用）。所以多学英语，有时候外国文档可能会更好的解决问题</li><li>向周围的人提问：多和大佬交流（但不限于提问，聊天还可以开拓眼界），快速解决问题。提供完整的代码以及报错信息截图，做过什么尝试？无论对方是否解决，注意礼貌，说一声谢谢。推荐阅读<a href="https://github.com/tvvocold/How-To-Ask-Questions-The-Smart-Way">《提问的智慧》中文版</a></li></ul><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.zhsher.cn/%E6%97%A5%E8%AE%B0/%E6%97%A5%E8%AE%B019.png" alt="日记19" style="zoom:67%;" /><h3 id="第五章之不要摆烂"><a href="#第五章之不要摆烂" class="headerlink" title="第五章之不要摆烂"></a>第五章之不要摆烂</h3><p>『逆水行舟不进则退，心似平原走马易放难追』</p><p>正如『DT编程社』所说，<strong>热爱 坚持 创新</strong>。我相信，在一个月之后，社团一定会有一些感觉编程的背后很枯燥，这个很正常，我的好多同学都是抱着好奇心报的计算机专业，但自己学不会又懒得学，被迫转行，甚至挂科太多学位证都是问题。但强者的路往往是孤独的，必须保持着你们现在的初心去热爱编程，坚持学习，勇于创新，做出自己的东西。这个时候你再回头看，一定值得！</p>]]></content:encoded>
      
      
      <category domain="https://zhsher.cn/categories/%E5%B0%8F%E5%BC%A0%E5%88%97%E4%BC%A0/">小张列传</category>
      
      
      <category domain="https://zhsher.cn/tags/%E5%B0%8F%E5%BC%A0%E5%88%97%E4%BC%A0/">小张列传</category>
      
      
      <comments>https://zhsher.cn/posts/26324/#disqus_thread</comments>
      
    </item>
    
  </channel>
</rss>
